<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Bug reports</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../style.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Bug reports</h1>
</header>
<p>Last updated: 13:00, Nov, 25, 2018</p>
<ul>
<li><a href="#cJSON">cJSON</a>
<ul>
<li><a href="#Bug%20in%20cJSON.c%20cJSON_SetNumberHelper%20#138">Bug in cJSON.c cJSON_SetNumberHelper #138</a></li>
<li><a href="#Bug%20in%20cJSON_AddItemToObject%20#106">Bug in cJSON_AddItemToObject #106</a></li>
<li><a href="#Invalid%20pointer%20returned%20if%20reallocate%20fails%20in%20ensure%20function%20#189">Invalid pointer returned if reallocate fails in ensure function #189</a></li>
<li><a href="#String%20deallocated%20before%20use%20#248">String deallocated before use #248</a></li>
</ul></li>
<li><a href="#ArduinoJson">ArduinoJson</a>
<ul>
<li><a href="#Update%20QuotedString.cpp%20#81">Update QuotedString.cpp #81</a>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2015-4590">CVE-2015-4590</a></li>
</ul></li>
<li><a href="#get%3CString%3E%20returns%20-0%20for%200%20#808">get<String> returns -0 for 0 #808</a></li>
</ul></li>
<li><a href="#json-parser">json-parser</a>
<ul>
<li><a href="#heap%20buffer%20overflow%20on%20some%20inputs%20#68">heap buffer overflow on some inputs #68</a></li>
</ul></li>
<li><a href="#json-c">json-c</a>
<ul>
<li><a href="#Empty%20strings%20and%20unicode%20zero%20values%20break%20json%20parsing.%20#53">Empty strings and unicode zero values break json parsing. #53</a></li>
</ul></li>
<li><a href="#jansson">jansson</a>
<ul>
<li>Jansson is a C library for encoding, decoding and manipulating JSON data.</li>
<li><a href="#Stack%20exhaustion%20parsing%20a%20JSON%20file%20#282">Stack exhaustion parsing a JSON file #282</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-4425">CVE-2016-4425</a></li>
</ul></li>
</ul></li>
<li><a href="#iniparser">iniparser</a>
<ul>
<li>ini file parser</li>
<li><a href="#Empty%20string%20with%20quotes.%20#70">Empty string with quotes. #70</a></li>
</ul></li>
<li><a href="#http-parser">http-parser</a>
<ul>
<li><a href="#Heap%20out-of-bounds%20read%20in%20strtoul%20(68345541)">Heap out-of-bounds read in strtoul (68345541)</a></li>
</ul></li>
<li><a href="#myhtml">myhtml</a>
<ul>
<li>Fast C/C++ HTML 5 Parser. Using threads.</li>
<li><a href="#fix%20charef%20parsing%20#152">fix charef parsing #152</a></li>
</ul></li>
<li><a href="#mongoose">mongoose</a>
<ul>
<li>Mongoose Embedded Web Server Library - Mongoose is more than an embedded webserver. It is a multi-protocol embedded networking library with functions including TCP, HTTP client and server, WebSocket client and server, MQTT client and broker and much more.</li>
<li><a href="#websocket%20client%20bug%20#631">websocket client bug #631</a></li>
</ul></li>
<li><a href="#Firefox">Firefox</a>
<ul>
<li><a href="#CVE-2018-5176">Iframe injection &amp; content spoofing &amp; scripts execution via json viewer</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5176">CVE-2018-5176</a></li>
</ul></li>
</ul></li>
<li><a href="#poco">poco</a>
<ul>
<li>The POCO C++ Libraries are powerful cross-platform C++ libraries for building network- and internet-based applications that run on desktop, server, mobile, IoT, and embedded systems.</li>
<li><a href="#Zip%20Decompress%20Parent%20Path%20Injection%20#1968">Zip Decompress Parent Path Injection #1968</a></li>
</ul></li>
<li><a href="#CImg">CImg</a>
<ul>
<li>The CImg Library is a small and open-source C++ toolkit for image processing.</li>
<li><a href="#other%20testcases%20lead%20to%20heap%20overflow%20by%20loading%20crafted%20images%20#185">other testcases lead to heap overflow by loading crafted images #185</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-7640">CVE-2018-7640</a></li>
</ul></li>
<li><a href="#double%20free%20when%20load%20bmp%20image%20#184">double free when load bmp image #184</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-7589">CVE-2018-7589</a></li>
</ul></li>
<li><a href="#a%20heap%20overflow%20when%20load%20a%20bmp%20image%20#183">a heap overflow when load a bmp image #183</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-7588">CVE-2018-7588</a></li>
</ul></li>
</ul></li>
<li><a href="#ImageMagick">ImageMagick</a>
<ul>
<li>ImageMagick is a free and open-source software suite for displaying, converting, and editing raster image and vector image files.</li>
<li><a href="#heap-buffer-overflow%20in%20SVGStripString%20of%20svg.c%20#1336">heap-buffer-overflow in SVGStripString of svg.c #1336</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-18023">CVE-2018-18023</a></li>
</ul></li>
<li><a href="#heap-buffer-overflow%20in%20EncodeImage%20of%20pict.c%20#1335">heap-buffer-overflow in EncodeImage of pict.c #1335</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-18025">CVE-2018-18025</a></li>
</ul></li>
<li><a href="#heap-buffer-overflow%20in%20MagickCore%20#1156">heap-buffer-overflow in MagickCore #1156</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11625">CVE-2018-11625</a></li>
</ul></li>
<li><a href="#heap-buffer-overflow%20#1009">heap-buffer-overflow #1009</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-9135">CVE-2018-9135</a></li>
</ul></li>
<li><a href="#Stack%20over-read%20in%20MagickCore/accelerate.c%20due%20to%20type%20mismatch%20#967">Stack over-read in MagickCore/accelerate.c due to type mismatch #967</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-6930">CVE-2018-6930</a></li>
</ul></li>
<li><a href="#out-of-bounds%20read%20in%20coders/sun.c:582:57%20#375">out-of-bounds read in coders/sun.c:582:57 #375</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-6500">CVE-2017-6500</a></li>
</ul></li>
</ul></li>
<li><a href="#FFmpeg">FFmpeg</a>
<ul>
<li>FFmpeg is a collection of libraries and tools to process multimedia content such as audio, video, subtitles and related metadata.</li>
<li><a href="#integer%20overflow%20and%20out%20of%20array%20access">integer overflow and out of array access</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1999011">CVE-2018-1999011</a></li>
</ul></li>
<li><a href="#Fix%20multiple%20runtime%20error:%20index%20256%20out%20of%20bounds">Fix multiple runtime error: index 256 out of bounds</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-9995">CVE-2017-9995</a></li>
</ul></li>
<li><a href="#http:%20make%20length/offset-related%20variables%20unsigned.">http: make length/offset-related variables unsigned.</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-10190">CVE-2016-10190</a></li>
</ul></li>
<li><a href="#FFmpeg%20before%202017-01-24%20has%20an%20out-of-bounds%20write%20caused%20by%20a%20heap-based%20buffer%20overflow">FFmpeg before 2017-01-24 has an out-of-bounds write caused by a heap-based buffer overflow</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7865">CVE-2017-7865</a></li>
</ul></li>
<li><a href="#FFmpeg%20before%202017-01-23%20has%20an%20out-of-bounds%20write%20caused%20by%20a%20stack-based%20buffer%20overflow">FFmpeg before 2017-01-23 has an out-of-bounds write caused by a stack-based buffer overflow</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7866">CVE-2017-7866</a></li>
</ul></li>
</ul></li>
<li><a href="#OpenCV">OpenCV</a>
<ul>
<li><a href="#Out%20of%20bounds%20write%20causes%20Segmentation%20Fault%20#9723">Out of bounds write causes Segmentation Fault #9723</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-1000450">CVE-2017-1000450</a></li>
</ul></li>
<li><a href="#A%20heap%20based%20buffer%20overflow%20happens%20in%20cv::Jpeg2KDecoder::readComponent8u%20#10541">A heap based buffer overflow happens in cv::Jpeg2KDecoder::readComponent8u #10541</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5268">CVE-2018-5268</a></li>
</ul></li>
</ul></li>
</ul>
<p><a name="cJSON"></p>
<h3 id="project-name-cjson">Project Name: <a href="https://github.com/DaveGamble/cJSON">cJSON</a></h3>
<p><a name="Bug in cJSON.c cJSON_SetNumberHelper #138"></p>
<h3 id="bug-in-cjson.c-cjson_setnumberhelper-138">1. <a href="https://github.com/DaveGamble/cJSON/issues/138">Bug in cJSON.c cJSON_SetNumberHelper #138</a></h3>
<p><a href="https://github.com/DaveGamble/cJSON/issues/138"><strong>Description</strong></a></p>
<blockquote>
<p>cJSON.c line 231 : object-&gt;valueint = cJSON_Number;</p>
<p>may be it is type?</p>
<p>object-&gt;type = cJSON_Number; object-&gt;valueint = number;</p>
</blockquote>
<p><a href="https://github.com/DaveGamble/cJSON/commit/ef34500693e8c4a2849d41a4bd66fd19c9ec46c2"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb1-1" data-line-number="1">    {</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="st">-        object-&gt;valueint = cJSON_Number;</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="va">+        object-&gt;valueint = (int)number;</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    }</a></code></pre></div>
<p><a href="https://github.com/DaveGamble/cJSON/commit/ef34500693e8c4a2849d41a4bd66fd19c9ec46c2"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb2-1" data-line-number="1"> <span class="co">/* don&#39;t ask me, but the original cJSON_SetNumberValue returns an integer or double */</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"> CJSON_PUBLIC(<span class="dt">double</span>) cJSON_SetNumberHelper(cJSON *object, <span class="dt">double</span> number)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"> {</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">     <span class="cf">if</span> (number &gt;= INT_MAX)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">     {</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">         object-&gt;valueint = INT_MAX;</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">     }</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">     <span class="cf">else</span> <span class="cf">if</span> (number &lt;= INT_MIN)</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">     {</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">         object-&gt;valueint = INT_MIN;</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">    }</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    {</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">        object-&gt;valueint = (<span class="dt">int</span>)number;</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">    }</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">     <span class="cf">return</span> object-&gt;valuedouble = number;</a>
<a class="sourceLine" id="cb2-17" data-line-number="17"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<p>Should be able to discovered by comparing to the output of other JSON parser</p>
<hr />
<p><a name="Bug in cJSON_AddItemToObject #106"></p>
<h3 id="bug-in-cjson_additemtoobject-106">2. <a href="https://github.com/DaveGamble/cJSON/issues/106">Bug in cJSON_AddItemToObject #106</a></h3>
<p><a href="https://github.com/DaveGamble/cJSON/issues/106"><strong>Description</strong></a></p>
<blockquote>
<p>In cJSON_AddItemToObject,</p>
<p>/* free old key and set new one */ if (item-&gt;string) { cJSON_free(item-&gt;string); }</p>
<p>Shouldn’t this be:</p>
<p>if (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; item-&gt;string) { cJSON_free(item-&gt;string); }</p>
<p>Thanks! Diego.</p>
</blockquote>
<p><a href="https://github.com/DaveGamble/cJSON/commit/702fd95af3408b157167bfd30728c66a212aeae7"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb3-1" data-line-number="1">    /* free old key and set new one */</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="st">-    if (item-&gt;string)</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="va">+    if (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; item-&gt;string)</span></a></code></pre></div>
<p><a href="https://github.com/DaveGamble/cJSON/commit/702fd95af3408b157167bfd30728c66a212aeae7"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" data-line-number="1"> <span class="dt">void</span>   cJSON_AddItemToObject(cJSON *object, <span class="dt">const</span> <span class="dt">char</span> *string, cJSON *item)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"> {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">     <span class="cf">if</span> (!item)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">     {</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">         <span class="cf">return</span>;</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    }</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">     <span class="co">/* free old key and set new one */</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    <span class="cf">if</span> (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; item-&gt;string)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">    {</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">        cJSON_free(item-&gt;string);</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">    }</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">     item-&gt;string = (<span class="dt">char</span>*)cJSON_strdup((<span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span>*)string);</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"> </a>
<a class="sourceLine" id="cb4-14" data-line-number="14">     cJSON_AddItemToArray(object,item);</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<p>Should be able to discovered given certain input</p>
<hr />
<p><a name="Invalid pointer returned if reallocate fails in ensure function #189"></p>
<h3 id="invalid-pointer-returned-if-reallocate-fails-in-ensure-function-189">3. <a href="https://github.com/DaveGamble/cJSON/issues/189">Invalid pointer returned if reallocate fails in ensure function #189</a></h3>
<p><a href="https://github.com/DaveGamble/cJSON/issues/189"><strong>Description</strong></a></p>
<blockquote>
<p>Q: The calls to reallocate is assumed to return a valid pointer. If it fails, NULL should be returned instead of newbuffer + p-&gt;offset.</p>
</blockquote>
<blockquote>
<p>A: This is definitely a bug and most likely also a security issue, since an attacker could make realloc fail at exactly the right moment while also providing a big JSON (big offset), thereby potentially producing a pointer to an arbitrary memory address that will be written to by cJSON later on.</p>
</blockquote>
<p><a href="https://github.com/DaveGamble/cJSON/commit/954d61e5e7cb9dc6c480fc28ac1cdceca07dd5bd"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="va">+        if (newbuffer == NULL)</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="va">+        {</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="va">+            p-&gt;hooks.deallocate(p-&gt;buffer);</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="va">+            p-&gt;length = 0;</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="va">+            p-&gt;buffer = NULL;</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="va">+             return NULL;</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="va">+        }</span></a></code></pre></div>
<p><a href="https://github.com/DaveGamble/cJSON/commit/954d61e5e7cb9dc6c480fc28ac1cdceca07dd5bd"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" data-line-number="1"> <span class="co">/* realloc printbuffer if necessary to have at least &quot;needed&quot; bytes more */</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"> <span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">char</span>* ensure(printbuffer * <span class="dt">const</span> p, <span class="dt">size_t</span> needed)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"> {</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">     <span class="dt">unsigned</span> <span class="dt">char</span> *newbuffer = NULL;</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">     <span class="dt">size_t</span> newsize = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb6-7" data-line-number="7">     <span class="cf">if</span> ((p == NULL) || (p-&gt;buffer == NULL))</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">     {</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">         <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">     }</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"> </a>
<a class="sourceLine" id="cb6-12" data-line-number="12">     <span class="cf">if</span> ((p-&gt;length &gt; <span class="dv">0</span>) &amp;&amp; (p-&gt;offset &gt;= p-&gt;length))</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">     {</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">         <span class="co">/* make sure that offset is valid */</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">         <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">     }</a>
<a class="sourceLine" id="cb6-17" data-line-number="17"> </a>
<a class="sourceLine" id="cb6-18" data-line-number="18">     <span class="cf">if</span> (needed &gt; INT_MAX)</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">     {</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">         <span class="co">/* sizes bigger than INT_MAX are currently not supported */</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21">         <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">     }</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"> </a>
<a class="sourceLine" id="cb6-24" data-line-number="24">     needed += p-&gt;offset + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">     <span class="cf">if</span> (needed &lt;= p-&gt;length)</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">     {</a>
<a class="sourceLine" id="cb6-27" data-line-number="27">         <span class="cf">return</span> p-&gt;buffer + p-&gt;offset;</a>
<a class="sourceLine" id="cb6-28" data-line-number="28">     }</a>
<a class="sourceLine" id="cb6-29" data-line-number="29"> </a>
<a class="sourceLine" id="cb6-30" data-line-number="30">     <span class="cf">if</span> (p-&gt;noalloc) {</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">         <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-32" data-line-number="32">     }</a>
<a class="sourceLine" id="cb6-33" data-line-number="33"> </a>
<a class="sourceLine" id="cb6-34" data-line-number="34">     <span class="co">/* calculate new buffer size */</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35">     <span class="cf">if</span> (needed &gt; (INT_MAX / <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb6-36" data-line-number="36">     {</a>
<a class="sourceLine" id="cb6-37" data-line-number="37">         <span class="co">/* overflow of int, use INT_MAX if possible */</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38">         <span class="cf">if</span> (needed &lt;= INT_MAX)</a>
<a class="sourceLine" id="cb6-39" data-line-number="39">         {</a>
<a class="sourceLine" id="cb6-40" data-line-number="40">             newsize = INT_MAX;</a>
<a class="sourceLine" id="cb6-41" data-line-number="41">         }</a>
<a class="sourceLine" id="cb6-42" data-line-number="42">         <span class="cf">else</span></a>
<a class="sourceLine" id="cb6-43" data-line-number="43">         {</a>
<a class="sourceLine" id="cb6-44" data-line-number="44">             <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-45" data-line-number="45">         }</a>
<a class="sourceLine" id="cb6-46" data-line-number="46">     }</a>
<a class="sourceLine" id="cb6-47" data-line-number="47">     <span class="cf">else</span></a>
<a class="sourceLine" id="cb6-48" data-line-number="48">     {</a>
<a class="sourceLine" id="cb6-49" data-line-number="49">         newsize = needed * <span class="dv">2</span>;</a>
<a class="sourceLine" id="cb6-50" data-line-number="50">     }</a>
<a class="sourceLine" id="cb6-51" data-line-number="51"> </a>
<a class="sourceLine" id="cb6-52" data-line-number="52">     <span class="cf">if</span> (p-&gt;hooks.reallocate != NULL)</a>
<a class="sourceLine" id="cb6-53" data-line-number="53">    {</a>
<a class="sourceLine" id="cb6-54" data-line-number="54">        <span class="co">/* reallocate with realloc if available */</span></a>
<a class="sourceLine" id="cb6-55" data-line-number="55">        newbuffer = (<span class="dt">unsigned</span> <span class="dt">char</span>*)p-&gt;hooks.reallocate(p-&gt;buffer, newsize);</a>
<a class="sourceLine" id="cb6-56" data-line-number="56">        <span class="cf">if</span> (newbuffer == NULL)</a>
<a class="sourceLine" id="cb6-57" data-line-number="57">        {</a>
<a class="sourceLine" id="cb6-58" data-line-number="58">            p-&gt;hooks.deallocate(p-&gt;buffer);</a>
<a class="sourceLine" id="cb6-59" data-line-number="59">            p-&gt;length = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb6-60" data-line-number="60">            p-&gt;buffer = NULL;</a>
<a class="sourceLine" id="cb6-61" data-line-number="61">             <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-62" data-line-number="62">        }</a>
<a class="sourceLine" id="cb6-63" data-line-number="63">    }</a>
<a class="sourceLine" id="cb6-64" data-line-number="64">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb6-65" data-line-number="65">    {</a>
<a class="sourceLine" id="cb6-66" data-line-number="66">         <span class="co">/* otherwise reallocate manually */</span></a>
<a class="sourceLine" id="cb6-67" data-line-number="67">         newbuffer = (<span class="dt">unsigned</span> <span class="dt">char</span>*)p-&gt;hooks.allocate(newsize);</a>
<a class="sourceLine" id="cb6-68" data-line-number="68">         <span class="cf">if</span> (!newbuffer)</a>
<a class="sourceLine" id="cb6-69" data-line-number="69">         {</a>
<a class="sourceLine" id="cb6-70" data-line-number="70">             p-&gt;hooks.deallocate(p-&gt;buffer);</a>
<a class="sourceLine" id="cb6-71" data-line-number="71">             p-&gt;length = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb6-72" data-line-number="72">             p-&gt;buffer = NULL;</a>
<a class="sourceLine" id="cb6-73" data-line-number="73"> </a>
<a class="sourceLine" id="cb6-74" data-line-number="74">             <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-75" data-line-number="75">         }</a>
<a class="sourceLine" id="cb6-76" data-line-number="76">         <span class="cf">if</span> (newbuffer)</a>
<a class="sourceLine" id="cb6-77" data-line-number="77">         {</a>
<a class="sourceLine" id="cb6-78" data-line-number="78">             memcpy(newbuffer, p-&gt;buffer, p-&gt;offset + <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb6-79" data-line-number="79">         }</a>
<a class="sourceLine" id="cb6-80" data-line-number="80">         p-&gt;hooks.deallocate(p-&gt;buffer);</a>
<a class="sourceLine" id="cb6-81" data-line-number="81">     }</a>
<a class="sourceLine" id="cb6-82" data-line-number="82">     p-&gt;length = newsize;</a>
<a class="sourceLine" id="cb6-83" data-line-number="83">     p-&gt;buffer = newbuffer;</a>
<a class="sourceLine" id="cb6-84" data-line-number="84"> </a>
<a class="sourceLine" id="cb6-85" data-line-number="85">     <span class="cf">return</span> newbuffer + p-&gt;offset;</a>
<a class="sourceLine" id="cb6-86" data-line-number="86"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<p>This is a security issue.</p>
<hr />
<p><a name="String deallocated before use #248"></p>
<h3 id="string-deallocated-before-use-248">4. <a href="https://github.com/DaveGamble/cJSON/issues/248">String deallocated before use #248</a></h3>
<p><a href="https://github.com/DaveGamble/cJSON/issues/248"><strong>Description:</strong></a></p>
<blockquote>
<p>add_item_to_object: Fix use-after-free when string is aliased</p>
<p>If the <code>string</code> property of the item that is added is an alias to the <code>string</code> parameter of <code>add_item_to_object</code>, and <code>constant</code> is false, <code>cJSON_strdup</code> would access the string after it has been freed.</p>
</blockquote>
<p><a href="https://github.com/FSMaxB/cJSON/commit/22a7d04fa004462e0dca35c3cc7809bea38e65f9"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb7-1" data-line-number="1">static cJSON_bool add_item_to_object(cJSON * const object, const char * const string, cJSON * const item, const internal_hooks * const hooks, const cJSON_bool constant_key)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="va">+    char *new_key = NULL;</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="va">+    int new_type = cJSON_Invalid;</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">     if ((object == NULL) || (string == NULL) || (item == NULL))</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    {</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">        return false;</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">    }</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="st">-     if (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; (item-&gt;string != NULL))</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="st">-    {</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="st">-        hooks-&gt;deallocate(item-&gt;string);</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="st">-    }</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">     if (constant_key)</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">    {</a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="st">-        item-&gt;string = (char*)cast_away_const(string);</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="st">-        item-&gt;type |= cJSON_StringIsConst;</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="va">+        new_key = (char*)cast_away_const(string);</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="va">+        new_type = item-&gt;type | cJSON_StringIsConst;</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">    }</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">    else</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">    {</a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="st">-        char *key = (char*)cJSON_strdup((const unsigned char*)string, hooks);</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="st">-        if (key == NULL)</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="va">+        new_key = (char*)cJSON_strdup((const unsigned char*)string, hooks);</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25"><span class="va">+        if (new_key == NULL)</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">        {</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">            return false;</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">        }</a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="st">-         item-&gt;string = key;</span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30"><span class="st">-        item-&gt;type &amp;= ~cJSON_StringIsConst;</span></a>
<a class="sourceLine" id="cb7-31" data-line-number="31"><span class="va">+        new_type = item-&gt;type &amp; ~cJSON_StringIsConst;</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32">    }</a>
<a class="sourceLine" id="cb7-33" data-line-number="33"><span class="va">+     if (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; (item-&gt;string != NULL))</span></a>
<a class="sourceLine" id="cb7-34" data-line-number="34"><span class="va">+    {</span></a>
<a class="sourceLine" id="cb7-35" data-line-number="35"><span class="va">+        hooks-&gt;deallocate(item-&gt;string);</span></a>
<a class="sourceLine" id="cb7-36" data-line-number="36"><span class="va">+    }</span></a>
<a class="sourceLine" id="cb7-37" data-line-number="37"><span class="va">+     item-&gt;string = new_key;</span></a>
<a class="sourceLine" id="cb7-38" data-line-number="38"><span class="va">+    item-&gt;type = new_type;</span></a>
<a class="sourceLine" id="cb7-39" data-line-number="39">     return add_item_to_array(object, item);</a>
<a class="sourceLine" id="cb7-40" data-line-number="40">}</a></code></pre></div>
<p><a href="https://github.com/FSMaxB/cJSON/commit/22a7d04fa004462e0dca35c3cc7809bea38e65f9"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">// The same as above</span></a></code></pre></div>
<p><strong>Comments</strong>:</p>
<p>This is a security issue</p>
<hr />
<p><a name="iniparser"></p>
<h3 id="project-name-iniparser">Project Name: <a href="https://github.com/ndevilla/iniparser/">iniparser</a></h3>
<p><a name="Empty string with quotes. #70"></p>
<h3 id="empty-string-with-quotes.-70">1. <a href="https://github.com/ndevilla/iniparser/issues/70">Empty string with quotes. #70</a></h3>
<p><a href="https://github.com/ndevilla/iniparser/issues/70"><strong>Description:</strong></a></p>
<blockquote>
<p>for example: <code>filter = &quot;&quot;</code></p>
</blockquote>
<blockquote>
<p>this code can’t handle it</p>
</blockquote>
<pre><code>} else if (sscanf (line, &quot;%[^=] = \&quot;%[^\&quot;]\&quot;&quot;, key, value) == 2
       ||  sscanf (line, &quot;%[^=] = &#39;%[^\&#39;]&#39;&quot;,   key, value) == 2) {</code></pre>
<blockquote>
<p>this string will be processed in</p>
</blockquote>
<pre><code>} else if (sscanf (line, &quot;%[^=] = %[^;#]&quot;, key, value) == 2) {</code></pre>
<blockquote>
<p>the condition</p>
</blockquote>
<pre><code>if (!strcmp(value, &quot;\&quot;\&quot;&quot;) || (!strcmp(value, &quot;&#39;&#39;&quot;))) {
        value[0]=0 ;
}</code></pre>
<blockquote>
<p>will not be processed.</p>
</blockquote>
<blockquote>
<p>result: load = &quot;&quot; save = &quot;&quot;&quot;&quot; load = &quot;&quot;&quot;&quot; save = &quot;&quot;&quot;&quot;&quot;&quot; etc.</p>
</blockquote>
<p><a href="https://github.com/ndevilla/iniparser/commit/54716a77d621373ad3428170af6dacf9f106c264"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="va">+         sta = LINE_VALUE ;</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="va">+     } else if (sscanf (line, &quot;%[^=] = %[^;#]&quot;, key, value) == 2) {</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="va">+         /* Usual key=value without quotes, with or + without comments */</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="va">+         strstrip(key);</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="va">+         strlwc(key, key, len);</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="va">+         strstrip(value);</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">        /*</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">         * sscanf cannot handle &#39;&#39; or &quot;&quot; as empty values</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">         * this is done here</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">         */</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">        if (!strcmp(value, &quot;\&quot;\&quot;&quot;) || (!strcmp(value, &quot;&#39;&#39;&quot;))) {</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">            value[0]=0 ;</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">        }</a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="st">-        sta = LINE_VALUE ;</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="st">-    } else if (sscanf (line, &quot;%[^=] = %[^;#]&quot;, key, value) == 2) {</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="st">-        /* Usual key=value without quotes, with or without comments */</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="st">-        strstrip(key);</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="st">-        strlwc(key, key, len);</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="st">-        strstrip(value);</span></a></code></pre></div>
<p><a href="https://github.com/ndevilla/iniparser/commit/54716a77d621373ad3428170af6dacf9f106c264"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb13-1" data-line-number="1"> <span class="co">/*-------------------------------------------------------------------------*/</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"> <span class="co">/**</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">   </span><span class="an">@brief</span><span class="co">    Load a single line from an INI file</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">   </span><span class="an">@param</span><span class="co">    </span><span class="cv">input_line</span><span class="co">  Input line, may be concatenated multi-line input</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">   </span><span class="an">@param</span><span class="co">    </span><span class="cv">section</span><span class="co">     Output space to store section</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">   </span><span class="an">@param</span><span class="co">    </span><span class="cv">key</span><span class="co">         Output space to store key</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">   </span><span class="an">@param</span><span class="co">    </span><span class="cv">value</span><span class="co">       Output space to store value</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">   </span><span class="an">@return</span><span class="co">   line_status value</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">  */</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"> <span class="co">/*--------------------------------------------------------------------------*/</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"> <span class="dt">static</span> line_status iniparser_line(</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">     <span class="dt">const</span> <span class="dt">char</span> * input_line,</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">     <span class="dt">char</span> * section,</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">     <span class="dt">char</span> * key,</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">     <span class="dt">char</span> * value)</a>
<a class="sourceLine" id="cb13-16" data-line-number="16"> {</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">     line_status sta ;</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">     <span class="dt">char</span> * line = NULL;</a>
<a class="sourceLine" id="cb13-19" data-line-number="19">     <span class="dt">size_t</span>      len ;</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"> </a>
<a class="sourceLine" id="cb13-21" data-line-number="21">     line = xstrdup(input_line);</a>
<a class="sourceLine" id="cb13-22" data-line-number="22">     len = strstrip(line);</a>
<a class="sourceLine" id="cb13-23" data-line-number="23"> </a>
<a class="sourceLine" id="cb13-24" data-line-number="24">     sta = LINE_UNPROCESSED ;</a>
<a class="sourceLine" id="cb13-25" data-line-number="25">     <span class="cf">if</span> (len&lt;<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb13-26" data-line-number="26">         <span class="co">/* Empty line */</span></a>
<a class="sourceLine" id="cb13-27" data-line-number="27">         sta = LINE_EMPTY ;</a>
<a class="sourceLine" id="cb13-28" data-line-number="28">     } <span class="cf">else</span> <span class="cf">if</span> (line[<span class="dv">0</span>]==<span class="ch">&#39;#&#39;</span> || line[<span class="dv">0</span>]==<span class="ch">&#39;;&#39;</span>) {</a>
<a class="sourceLine" id="cb13-29" data-line-number="29">         <span class="co">/* Comment line */</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30">         sta = LINE_COMMENT ;</a>
<a class="sourceLine" id="cb13-31" data-line-number="31">     } <span class="cf">else</span> <span class="cf">if</span> (line[<span class="dv">0</span>]==<span class="ch">&#39;[&#39;</span> &amp;&amp; line[len<span class="dv">-1</span>]==<span class="ch">&#39;]&#39;</span>) {</a>
<a class="sourceLine" id="cb13-32" data-line-number="32">         <span class="co">/* Section name */</span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33">         sscanf(line, <span class="st">&quot;[%[^]]&quot;</span>, section);</a>
<a class="sourceLine" id="cb13-34" data-line-number="34">         strstrip(section);</a>
<a class="sourceLine" id="cb13-35" data-line-number="35">         strlwc(section, section, len);</a>
<a class="sourceLine" id="cb13-36" data-line-number="36">         sta = LINE_SECTION ;</a>
<a class="sourceLine" id="cb13-37" data-line-number="37">     } <span class="cf">else</span> <span class="cf">if</span> (sscanf (line, <span class="st">&quot;%[^=] = </span><span class="sc">\&quot;</span><span class="st">%[^</span><span class="sc">\&quot;</span><span class="st">]</span><span class="sc">\&quot;</span><span class="st">&quot;</span>, key, value) == <span class="dv">2</span></a>
<a class="sourceLine" id="cb13-38" data-line-number="38">            ||  sscanf (line, <span class="st">&quot;%[^=] = &#39;%[^</span><span class="sc">\&#39;</span><span class="st">]&#39;&quot;</span>,   key, value) == <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb13-39" data-line-number="39">         <span class="co">/* Usual key=value with quotes, with or without comments */</span></a>
<a class="sourceLine" id="cb13-40" data-line-number="40">        strstrip(key);</a>
<a class="sourceLine" id="cb13-41" data-line-number="41">        strlwc(key, key, len);</a>
<a class="sourceLine" id="cb13-42" data-line-number="42">        <span class="co">/* Don&#39;t strip spaces from values surrounded with quotes */</span></a>
<a class="sourceLine" id="cb13-43" data-line-number="43">        sta = LINE_VALUE ;</a>
<a class="sourceLine" id="cb13-44" data-line-number="44">    } <span class="cf">else</span> <span class="cf">if</span> (sscanf (line, <span class="st">&quot;%[^=] = %[^;#]&quot;</span>, key, value) == <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb13-45" data-line-number="45">        <span class="co">/* Usual key=value without quotes, with or without comments */</span></a>
<a class="sourceLine" id="cb13-46" data-line-number="46">        strstrip(key);</a>
<a class="sourceLine" id="cb13-47" data-line-number="47">        strlwc(key, key, len);</a>
<a class="sourceLine" id="cb13-48" data-line-number="48">        strstrip(value);</a>
<a class="sourceLine" id="cb13-49" data-line-number="49">        <span class="co">/*</span></a>
<a class="sourceLine" id="cb13-50" data-line-number="50"><span class="co">         * sscanf cannot handle &#39;&#39; or &quot;&quot; as empty values</span></a>
<a class="sourceLine" id="cb13-51" data-line-number="51"><span class="co">         * this is done here</span></a>
<a class="sourceLine" id="cb13-52" data-line-number="52"><span class="co">         */</span></a>
<a class="sourceLine" id="cb13-53" data-line-number="53">        <span class="cf">if</span> (!strcmp(value, <span class="st">&quot;</span><span class="sc">\&quot;\&quot;</span><span class="st">&quot;</span>) || (!strcmp(value, <span class="st">&quot;&#39;&#39;&quot;</span>))) {</a>
<a class="sourceLine" id="cb13-54" data-line-number="54">            value[<span class="dv">0</span>]=<span class="dv">0</span> ;</a>
<a class="sourceLine" id="cb13-55" data-line-number="55">        }</a>
<a class="sourceLine" id="cb13-56" data-line-number="56">         sta = LINE_VALUE ;</a>
<a class="sourceLine" id="cb13-57" data-line-number="57">    } <span class="cf">else</span> <span class="cf">if</span> (sscanf(line, <span class="st">&quot;%[^=] = %[;#]&quot;</span>, key, value)==<span class="dv">2</span></a>
<a class="sourceLine" id="cb13-58" data-line-number="58">           ||  sscanf(line, <span class="st">&quot;%[^=] %[=]&quot;</span>, key, value) == <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb13-59" data-line-number="59">         <span class="co">/*</span></a>
<a class="sourceLine" id="cb13-60" data-line-number="60"><span class="co">          * Special cases:</span></a>
<a class="sourceLine" id="cb13-61" data-line-number="61"><span class="co">          * key=</span></a>
<a class="sourceLine" id="cb13-62" data-line-number="62"><span class="co">          * key=;</span></a>
<a class="sourceLine" id="cb13-63" data-line-number="63"><span class="co">          * key=#</span></a>
<a class="sourceLine" id="cb13-64" data-line-number="64"><span class="co">          */</span></a>
<a class="sourceLine" id="cb13-65" data-line-number="65">         strstrip(key);</a>
<a class="sourceLine" id="cb13-66" data-line-number="66">         strlwc(key, key, len);</a>
<a class="sourceLine" id="cb13-67" data-line-number="67">         value[<span class="dv">0</span>]=<span class="dv">0</span> ;</a>
<a class="sourceLine" id="cb13-68" data-line-number="68">         sta = LINE_VALUE ;</a>
<a class="sourceLine" id="cb13-69" data-line-number="69">     } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb13-70" data-line-number="70">         <span class="co">/* Generate syntax error */</span></a>
<a class="sourceLine" id="cb13-71" data-line-number="71">         sta = LINE_ERROR ;</a>
<a class="sourceLine" id="cb13-72" data-line-number="72">     }</a>
<a class="sourceLine" id="cb13-73" data-line-number="73"> </a>
<a class="sourceLine" id="cb13-74" data-line-number="74">     free(line);</a>
<a class="sourceLine" id="cb13-75" data-line-number="75">     <span class="cf">return</span> sta ;</a>
<a class="sourceLine" id="cb13-76" data-line-number="76"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="http-parser"></p>
<h2 id="project-name-http-parser">Project Name: <a href="https://github.com/nodejs/http-parser/">http-parser</a></h2>
<p><a name="Heap out-of-bounds read in strtoul (68345541)"></p>
<h3 id="heap-out-of-bounds-read-in-strtoul-68345541-408">1. <a href="https://github.com/nodejs/http-parser/issues/408">Heap out-of-bounds read in strtoul (68345541) #408</a></h3>
<p><a href="https://github.com/nodejs/http-parser/issues/408"><strong>Description:</strong></a></p>
<blockquote>
<p>src: fix out-of-bounds read through <code>strtoul</code></p>
</blockquote>
<blockquote>
<p><code>strtoul</code> will attempt to lookup the next digit up until it will stumble upon an invalid one. However, for an unterminated string as an input value, this results in out-of-bounds read.</p>
</blockquote>
<blockquote>
<p>Remove <code>strtoul</code> call, and replace it with simple loop.</p>
</blockquote>
<p><a href="https://github.com/nodejs/http-parser/commit/9ce7316de31f90d8485706a1ab8ef623404c2d8c"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb14-1" data-line-number="1">  if (u-&gt;field_set &amp; (1 &lt;&lt; UF_PORT)) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">-     /* Don&#39;t bother with endp; we&#39;ve already validated the string */</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">-     unsigned long v = strtoul(buf + u-&gt;field_data[UF_PORT] .off, NULL, 10);</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">-      /* Ports have a max value of 2^16 */</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">-     if (v &gt; 0xffff) {</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">-       return 1;</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="va">+     uint16_t off;</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="va">+     uint16_t len;</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="va">+     const char* p;</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="va">+     const char* end;</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="va">+     unsigned long v;</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="va">+      off = u-&gt;field_data[UF_PORT].off;</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="va">+     len = u-&gt;field_data[UF_PORT].len;</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="va">+     end = buf + off + len;</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="va">+      /* NOTE: The characters are already validated and are in the [0-9] range */</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="va">+     assert(off + len &lt;= buflen &amp;&amp; &quot;Port number overflow&quot;);</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="va">+     v = 0;</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="va">+     for (p = buf + off; p &lt; end; p++) {</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="va">+       v *= 10;</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="va">+       v += *p - &#39;0&#39;;</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="va">+        /* Ports have a max value of 2^16 */</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="va">+       if (v &gt; 0xffff) {</span></a>
<a class="sourceLine" id="cb14-23" data-line-number="23"><span class="va">+         return 1;</span></a>
<a class="sourceLine" id="cb14-24" data-line-number="24"><span class="va">+       }</span></a>
<a class="sourceLine" id="cb14-25" data-line-number="25">    }</a></code></pre></div>
<p><a href="https://github.com/nodejs/http-parser/commit/9ce7316de31f90d8485706a1ab8ef623404c2d8c"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb15-1" data-line-number="1"> <span class="dt">int</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"> http_parser_parse_url(<span class="dt">const</span> <span class="dt">char</span> *buf, <span class="dt">size_t</span> buflen, <span class="dt">int</span> is_connect,</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">                       <span class="kw">struct</span> http_parser_url *u)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"> {</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">   <span class="kw">enum</span> state s;</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">   <span class="dt">const</span> <span class="dt">char</span> *p;</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">   <span class="kw">enum</span> http_parser_url_fields uf, old_uf;</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">   <span class="dt">int</span> found_at = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb15-9" data-line-number="9"> </a>
<a class="sourceLine" id="cb15-10" data-line-number="10">   u-&gt;port = u-&gt;field_set = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">   s = is_connect ? s_req_server_start : s_req_spaces_before_url;</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">   old_uf = UF_MAX;</a>
<a class="sourceLine" id="cb15-13" data-line-number="13"> </a>
<a class="sourceLine" id="cb15-14" data-line-number="14">   <span class="cf">for</span> (p = buf; p &lt; buf + buflen; p++) {</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">     s = parse_url_char(s, *p);</a>
<a class="sourceLine" id="cb15-16" data-line-number="16"> </a>
<a class="sourceLine" id="cb15-17" data-line-number="17">     <span class="co">/* Figure out the next field that we&#39;re operating on */</span></a>
<a class="sourceLine" id="cb15-18" data-line-number="18">     <span class="cf">switch</span> (s) {</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">       <span class="cf">case</span> s_dead:</a>
<a class="sourceLine" id="cb15-20" data-line-number="20">         <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-21" data-line-number="21"> </a>
<a class="sourceLine" id="cb15-22" data-line-number="22">       <span class="co">/* Skip delimeters */</span></a>
<a class="sourceLine" id="cb15-23" data-line-number="23">       <span class="cf">case</span> s_req_schema_slash:</a>
<a class="sourceLine" id="cb15-24" data-line-number="24">       <span class="cf">case</span> s_req_schema_slash_slash:</a>
<a class="sourceLine" id="cb15-25" data-line-number="25">       <span class="cf">case</span> s_req_server_start:</a>
<a class="sourceLine" id="cb15-26" data-line-number="26">       <span class="cf">case</span> s_req_query_string_start:</a>
<a class="sourceLine" id="cb15-27" data-line-number="27">       <span class="cf">case</span> s_req_fragment_start:</a>
<a class="sourceLine" id="cb15-28" data-line-number="28">         <span class="cf">continue</span>;</a>
<a class="sourceLine" id="cb15-29" data-line-number="29"> </a>
<a class="sourceLine" id="cb15-30" data-line-number="30">       <span class="cf">case</span> s_req_schema:</a>
<a class="sourceLine" id="cb15-31" data-line-number="31">         uf = UF_SCHEMA;</a>
<a class="sourceLine" id="cb15-32" data-line-number="32">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-33" data-line-number="33"> </a>
<a class="sourceLine" id="cb15-34" data-line-number="34">       <span class="cf">case</span> s_req_server_with_at:</a>
<a class="sourceLine" id="cb15-35" data-line-number="35">         found_at = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-36" data-line-number="36"> </a>
<a class="sourceLine" id="cb15-37" data-line-number="37">       <span class="co">/* FALLTHROUGH */</span></a>
<a class="sourceLine" id="cb15-38" data-line-number="38">       <span class="cf">case</span> s_req_server:</a>
<a class="sourceLine" id="cb15-39" data-line-number="39">         uf = UF_HOST;</a>
<a class="sourceLine" id="cb15-40" data-line-number="40">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-41" data-line-number="41"> </a>
<a class="sourceLine" id="cb15-42" data-line-number="42">       <span class="cf">case</span> s_req_path:</a>
<a class="sourceLine" id="cb15-43" data-line-number="43">         uf = UF_PATH;</a>
<a class="sourceLine" id="cb15-44" data-line-number="44">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-45" data-line-number="45"> </a>
<a class="sourceLine" id="cb15-46" data-line-number="46">       <span class="cf">case</span> s_req_query_string:</a>
<a class="sourceLine" id="cb15-47" data-line-number="47">         uf = UF_QUERY;</a>
<a class="sourceLine" id="cb15-48" data-line-number="48">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-49" data-line-number="49"> </a>
<a class="sourceLine" id="cb15-50" data-line-number="50">       <span class="cf">case</span> s_req_fragment:</a>
<a class="sourceLine" id="cb15-51" data-line-number="51">         uf = UF_FRAGMENT;</a>
<a class="sourceLine" id="cb15-52" data-line-number="52">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-53" data-line-number="53"> </a>
<a class="sourceLine" id="cb15-54" data-line-number="54">       <span class="cf">default</span>:</a>
<a class="sourceLine" id="cb15-55" data-line-number="55">         assert(!<span class="st">&quot;Unexpected state&quot;</span>);</a>
<a class="sourceLine" id="cb15-56" data-line-number="56">         <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-57" data-line-number="57">     }</a>
<a class="sourceLine" id="cb15-58" data-line-number="58"> </a>
<a class="sourceLine" id="cb15-59" data-line-number="59">     <span class="co">/* Nothing&#39;s changed; soldier on */</span></a>
<a class="sourceLine" id="cb15-60" data-line-number="60">     <span class="cf">if</span> (uf == old_uf) {</a>
<a class="sourceLine" id="cb15-61" data-line-number="61">       u-&gt;field_data[uf].len++;</a>
<a class="sourceLine" id="cb15-62" data-line-number="62">       <span class="cf">continue</span>;</a>
<a class="sourceLine" id="cb15-63" data-line-number="63">     }</a>
<a class="sourceLine" id="cb15-64" data-line-number="64"> </a>
<a class="sourceLine" id="cb15-65" data-line-number="65">     u-&gt;field_data[uf].off = p - buf;</a>
<a class="sourceLine" id="cb15-66" data-line-number="66">     u-&gt;field_data[uf].len = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-67" data-line-number="67"> </a>
<a class="sourceLine" id="cb15-68" data-line-number="68">     u-&gt;field_set |= (<span class="dv">1</span> &lt;&lt; uf);</a>
<a class="sourceLine" id="cb15-69" data-line-number="69">     old_uf = uf;</a>
<a class="sourceLine" id="cb15-70" data-line-number="70">   }</a>
<a class="sourceLine" id="cb15-71" data-line-number="71"> </a>
<a class="sourceLine" id="cb15-72" data-line-number="72">   <span class="co">/* host must be present if there is a schema */</span></a>
<a class="sourceLine" id="cb15-73" data-line-number="73">   <span class="co">/* parsing http:///toto will fail */</span></a>
<a class="sourceLine" id="cb15-74" data-line-number="74">   <span class="cf">if</span> ((u-&gt;field_set &amp; (<span class="dv">1</span> &lt;&lt; UF_SCHEMA)) &amp;&amp;</a>
<a class="sourceLine" id="cb15-75" data-line-number="75">       (u-&gt;field_set &amp; (<span class="dv">1</span> &lt;&lt; UF_HOST)) == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb15-76" data-line-number="76">     <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-77" data-line-number="77">   }</a>
<a class="sourceLine" id="cb15-78" data-line-number="78"> </a>
<a class="sourceLine" id="cb15-79" data-line-number="79">   <span class="cf">if</span> (u-&gt;field_set &amp; (<span class="dv">1</span> &lt;&lt; UF_HOST)) {</a>
<a class="sourceLine" id="cb15-80" data-line-number="80">     <span class="cf">if</span> (http_parse_host(buf, u, found_at) != <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb15-81" data-line-number="81">       <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-82" data-line-number="82">     }</a>
<a class="sourceLine" id="cb15-83" data-line-number="83">   }</a>
<a class="sourceLine" id="cb15-84" data-line-number="84"> </a>
<a class="sourceLine" id="cb15-85" data-line-number="85">   <span class="co">/* CONNECT requests can only contain &quot;hostname:port&quot; */</span></a>
<a class="sourceLine" id="cb15-86" data-line-number="86">   <span class="cf">if</span> (is_connect &amp;&amp; u-&gt;field_set != ((<span class="dv">1</span> &lt;&lt; UF_HOST)|(<span class="dv">1</span> &lt;&lt; UF_PORT))) {</a>
<a class="sourceLine" id="cb15-87" data-line-number="87">     <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-88" data-line-number="88">  }</a>
<a class="sourceLine" id="cb15-89" data-line-number="89">   <span class="cf">if</span> (u-&gt;field_set &amp; (<span class="dv">1</span> &lt;&lt; UF_PORT)) {</a>
<a class="sourceLine" id="cb15-90" data-line-number="90">    <span class="dt">uint16_t</span> off;</a>
<a class="sourceLine" id="cb15-91" data-line-number="91">    <span class="dt">uint16_t</span> len;</a>
<a class="sourceLine" id="cb15-92" data-line-number="92">    <span class="dt">const</span> <span class="dt">char</span>* p;</a>
<a class="sourceLine" id="cb15-93" data-line-number="93">    <span class="dt">const</span> <span class="dt">char</span>* end;</a>
<a class="sourceLine" id="cb15-94" data-line-number="94">    <span class="dt">unsigned</span> <span class="dt">long</span> v;</a>
<a class="sourceLine" id="cb15-95" data-line-number="95">     off = u-&gt;field_data[UF_PORT].off;</a>
<a class="sourceLine" id="cb15-96" data-line-number="96">    len = u-&gt;field_data[UF_PORT].len;</a>
<a class="sourceLine" id="cb15-97" data-line-number="97">    end = buf + off + len;</a>
<a class="sourceLine" id="cb15-98" data-line-number="98">     <span class="co">/* </span><span class="al">NOTE</span><span class="co">: The characters are already validated and are in the [0-9] range */</span></a>
<a class="sourceLine" id="cb15-99" data-line-number="99">    assert(off + len &lt;= buflen &amp;&amp; <span class="st">&quot;Port number overflow&quot;</span>);</a>
<a class="sourceLine" id="cb15-100" data-line-number="100">    v = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb15-101" data-line-number="101">    <span class="cf">for</span> (p = buf + off; p &lt; end; p++) {</a>
<a class="sourceLine" id="cb15-102" data-line-number="102">      v *= <span class="dv">10</span>;</a>
<a class="sourceLine" id="cb15-103" data-line-number="103">      v += *p - <span class="ch">&#39;0&#39;</span>;</a>
<a class="sourceLine" id="cb15-104" data-line-number="104">       <span class="co">/* Ports have a max value of 2^16 */</span></a>
<a class="sourceLine" id="cb15-105" data-line-number="105">      <span class="cf">if</span> (v &gt; <span class="bn">0xffff</span>) {</a>
<a class="sourceLine" id="cb15-106" data-line-number="106">        <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-107" data-line-number="107">      }</a>
<a class="sourceLine" id="cb15-108" data-line-number="108">    }</a>
<a class="sourceLine" id="cb15-109" data-line-number="109">     u-&gt;port = (<span class="dt">uint16_t</span>) v;</a>
<a class="sourceLine" id="cb15-110" data-line-number="110">   }</a>
<a class="sourceLine" id="cb15-111" data-line-number="111"> </a>
<a class="sourceLine" id="cb15-112" data-line-number="112">   <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb15-113" data-line-number="113"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="myhtml"></p>
<h3 id="project-name-myhtml">Project Name: <a href="https://github.com/lexborisov/myhtml/">myhtml</a></h3>
<p><a name="fix charef parsing #152"></p>
<h3 id="fix-charef-parsing-152">1. <a href="https://github.com/lexborisov/myhtml/pull/152">fix charef parsing #152</a></h3>
<p><a href="https://github.com/lexborisov/myhtml/pull/152"><strong>Description</strong></a></p>
<blockquote>
<p>fix bugs like this:<br />
&amp;redirect =&gt; ®direct</p>
</blockquote>
<p><a href="https://github.com/lexborisov/myhtml/pull/152"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="st">-    if(named_character_references[pos].codepoints_len)</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">-        return &amp;named_character_references[pos];</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="st">-    else if(result-&gt;last_entry) {</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="va">+    if(result-&gt;last_entry) {</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">        *offset = result-&gt;last_offset;</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">        return result-&gt;last_entry;</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    }</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">    </a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="st">-    return &amp;named_character_references[pos];</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="va">+    return &amp;named_character_references[0];</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">}</a></code></pre></div>
<p><a href="https://github.com/lexborisov/myhtml/pull/152"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb17-1" data-line-number="1"> <span class="dt">const</span> charef_entry_t * myhtml_charef_find_by_pos(<span class="dt">size_t</span> pos, <span class="dt">const</span> <span class="dt">char</span> *begin, <span class="dt">size_t</span> *offset, <span class="dt">size_t</span> size, charef_entry_result_t *result)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"> {</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">     <span class="dt">unsigned</span> <span class="dt">const</span> <span class="dt">char</span>* u_begin = (<span class="dt">unsigned</span> <span class="dt">const</span> <span class="dt">char</span>*)begin;</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">     </a>
<a class="sourceLine" id="cb17-5" data-line-number="5">     <span class="cf">if</span>(u_begin[*offset] == <span class="ch">&#39;&amp;&#39;</span>) {</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">         result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">         </a>
<a class="sourceLine" id="cb17-8" data-line-number="8">         <span class="cf">if</span>(result-&gt;curr_entry-&gt;codepoints_len)</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">             <span class="cf">return</span> result-&gt;curr_entry;</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">         <span class="cf">else</span> <span class="cf">if</span>(result-&gt;last_entry) {</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">             *offset = result-&gt;last_offset;</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">             <span class="cf">return</span> result-&gt;last_entry;</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">         }</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">         </a>
<a class="sourceLine" id="cb17-15" data-line-number="15">         <span class="cf">return</span> &amp;named_character_references[<span class="dv">0</span>];</a>
<a class="sourceLine" id="cb17-16" data-line-number="16">     }</a>
<a class="sourceLine" id="cb17-17" data-line-number="17">     </a>
<a class="sourceLine" id="cb17-18" data-line-number="18">     result-&gt;is_done = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb17-19" data-line-number="19">     </a>
<a class="sourceLine" id="cb17-20" data-line-number="20">     <span class="cf">while</span> (named_character_references[pos].ch)</a>
<a class="sourceLine" id="cb17-21" data-line-number="21">     {</a>
<a class="sourceLine" id="cb17-22" data-line-number="22">         <span class="cf">if</span>(named_character_references[pos].ch == u_begin[*offset])</a>
<a class="sourceLine" id="cb17-23" data-line-number="23">         {</a>
<a class="sourceLine" id="cb17-24" data-line-number="24">             <span class="cf">if</span>(u_begin[*offset] == <span class="ch">&#39;;&#39;</span>) {</a>
<a class="sourceLine" id="cb17-25" data-line-number="25">                 result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-26" data-line-number="26">                 </a>
<a class="sourceLine" id="cb17-27" data-line-number="27">                 result-&gt;curr_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-28" data-line-number="28">                 <span class="cf">return</span> result-&gt;curr_entry;</a>
<a class="sourceLine" id="cb17-29" data-line-number="29">             }</a>
<a class="sourceLine" id="cb17-30" data-line-number="30">             </a>
<a class="sourceLine" id="cb17-31" data-line-number="31">             (*offset)++;</a>
<a class="sourceLine" id="cb17-32" data-line-number="32">             </a>
<a class="sourceLine" id="cb17-33" data-line-number="33">             <span class="cf">if</span>(named_character_references[pos].next == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb17-34" data-line-number="34">                 result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-35" data-line-number="35">                 <span class="cf">return</span> &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-36" data-line-number="36">             }</a>
<a class="sourceLine" id="cb17-37" data-line-number="37">             </a>
<a class="sourceLine" id="cb17-38" data-line-number="38">             <span class="cf">if</span>(*offset &gt;= size)</a>
<a class="sourceLine" id="cb17-39" data-line-number="39">             {</a>
<a class="sourceLine" id="cb17-40" data-line-number="40">                 result-&gt;curr_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-41" data-line-number="41">                 </a>
<a class="sourceLine" id="cb17-42" data-line-number="42">                 <span class="cf">if</span>(named_character_references[pos].codepoints_len) {</a>
<a class="sourceLine" id="cb17-43" data-line-number="43">                     result-&gt;last_offset = *offset;</a>
<a class="sourceLine" id="cb17-44" data-line-number="44">                     result-&gt;last_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-45" data-line-number="45">                 }</a>
<a class="sourceLine" id="cb17-46" data-line-number="46">                 </a>
<a class="sourceLine" id="cb17-47" data-line-number="47">                 <span class="cf">return</span> result-&gt;curr_entry;</a>
<a class="sourceLine" id="cb17-48" data-line-number="48">             }</a>
<a class="sourceLine" id="cb17-49" data-line-number="49">             </a>
<a class="sourceLine" id="cb17-50" data-line-number="50">             <span class="cf">if</span>(u_begin[*offset] == <span class="ch">&#39;&amp;&#39;</span>) {</a>
<a class="sourceLine" id="cb17-51" data-line-number="51">                 result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-52" data-line-number="52">                 result-&gt;curr_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-53" data-line-number="53">                 </a>
<a class="sourceLine" id="cb17-54" data-line-number="54">                 <span class="cf">if</span>(result-&gt;curr_entry-&gt;codepoints_len)</a>
<a class="sourceLine" id="cb17-55" data-line-number="55">                     <span class="cf">return</span> result-&gt;curr_entry;</a>
<a class="sourceLine" id="cb17-56" data-line-number="56">                 <span class="cf">else</span> <span class="cf">if</span>(result-&gt;last_entry) {</a>
<a class="sourceLine" id="cb17-57" data-line-number="57">                     *offset = result-&gt;last_offset;</a>
<a class="sourceLine" id="cb17-58" data-line-number="58">                     <span class="cf">return</span> result-&gt;last_entry;</a>
<a class="sourceLine" id="cb17-59" data-line-number="59">                 }</a>
<a class="sourceLine" id="cb17-60" data-line-number="60">                 </a>
<a class="sourceLine" id="cb17-61" data-line-number="61">                 <span class="cf">return</span> &amp;named_character_references[<span class="dv">0</span>];</a>
<a class="sourceLine" id="cb17-62" data-line-number="62">             }</a>
<a class="sourceLine" id="cb17-63" data-line-number="63">             </a>
<a class="sourceLine" id="cb17-64" data-line-number="64">             <span class="cf">if</span>(named_character_references[pos].codepoints_len) {</a>
<a class="sourceLine" id="cb17-65" data-line-number="65">                 result-&gt;last_offset = *offset;</a>
<a class="sourceLine" id="cb17-66" data-line-number="66">                 result-&gt;last_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-67" data-line-number="67">             }</a>
<a class="sourceLine" id="cb17-68" data-line-number="68">             </a>
<a class="sourceLine" id="cb17-69" data-line-number="69">             pos = named_character_references[pos].next;</a>
<a class="sourceLine" id="cb17-70" data-line-number="70">         }</a>
<a class="sourceLine" id="cb17-71" data-line-number="71">         <span class="cf">else</span> <span class="cf">if</span>(u_begin[*offset] &gt; named_character_references[pos].ch) {</a>
<a class="sourceLine" id="cb17-72" data-line-number="72">             pos++;</a>
<a class="sourceLine" id="cb17-73" data-line-number="73">         }</a>
<a class="sourceLine" id="cb17-74" data-line-number="74">         <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb17-75" data-line-number="75">             <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb17-76" data-line-number="76">         }</a>
<a class="sourceLine" id="cb17-77" data-line-number="77">     }</a>
<a class="sourceLine" id="cb17-78" data-line-number="78">    </a>
<a class="sourceLine" id="cb17-79" data-line-number="79">    result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-80" data-line-number="80">    </a>
<a class="sourceLine" id="cb17-81" data-line-number="81">    <span class="cf">if</span>(result-&gt;last_entry) {</a>
<a class="sourceLine" id="cb17-82" data-line-number="82">        *offset = result-&gt;last_offset;</a>
<a class="sourceLine" id="cb17-83" data-line-number="83">        <span class="cf">return</span> result-&gt;last_entry;</a>
<a class="sourceLine" id="cb17-84" data-line-number="84">    }</a>
<a class="sourceLine" id="cb17-85" data-line-number="85">    <span class="cf">return</span> &amp;named_character_references[<span class="dv">0</span>];</a>
<a class="sourceLine" id="cb17-86" data-line-number="86">}</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="json-parser"></p>
<h3 id="project-name-json-parser">Project Name: <a href="https://github.com/udp/json-parser/">json-parser</a></h3>
<p><a name="heap buffer overflow on some inputs #68"></p>
<h3 id="heap-buffer-overflow-on-some-inputs-68">1. <a href="https://github.com/udp/json-parser/issues/68">heap buffer overflow on some inputs #68</a></h3>
<p><a href="https://github.com/udp/json-parser/issues/68"><strong>Description</strong></a></p>
<blockquote>
<p>Explanation if you need it for your thesis: When json-parser reads a unicode character, it reads 4 or 6 characters immediately without going back around the main loop which usually processes one byte at a time. To prevent this from causing a buffer overrun, there was an error condition if end - state.ptr &lt; 4 to check that 4 bytes were actually available to read. However, this check was performed on the ‘u’ character of the , which would return &gt;= 4 even if the input truncated at . To fix this, the error condition has been changed to end - state.ptr &lt;= 4.</p>
</blockquote>
<p><a href="https://github.com/udp/json-parser/commit/b42439a2927a879f40698e4861e727c4265c13e6"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="st">-                    if (end - state.ptr &lt; 4 || </span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="va">+                    if (end - state.ptr &lt;= 4 || </span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">                        (uc_b1 = hex_value (*++ state.ptr)) == 0xFF ||</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">                        (uc_b2 = hex_value (*++ state.ptr)) == 0xFF ||</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">                        (uc_b3 = hex_value (*++ state.ptr)) == 0xFF ||</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">                         (uc_b4 = hex_value (*++ state.ptr)) == 0xFF)</a>
<a class="sourceLine" id="cb18-7" data-line-number="7">                     {</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">                         sprintf (error, &quot;Invalid character value `%c` (at %d:%d)&quot;, b, line_and_col);</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">                         goto e_failed;</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">                     }</a>
<a class="sourceLine" id="cb18-11" data-line-number="11"> </a>
<a class="sourceLine" id="cb18-12" data-line-number="12">                     uc_b1 = (uc_b1 &lt;&lt; 4) | uc_b2;</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">                     uc_b2 = (uc_b3 &lt;&lt; 4) | uc_b4;</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">                     uchar = (uc_b1 &lt;&lt; 8) | uc_b2;</a>
<a class="sourceLine" id="cb18-15" data-line-number="15"> </a>
<a class="sourceLine" id="cb18-16" data-line-number="16">                    if ((uchar &amp; 0xF800) == 0xD800) {</a>
<a class="sourceLine" id="cb18-17" data-line-number="17">                        json_uchar uchar2;</a>
<a class="sourceLine" id="cb18-18" data-line-number="18">                        </a>
<a class="sourceLine" id="cb18-19" data-line-number="19">                        if (end - state.ptr &lt; 6 || (*++ state.ptr) != &#39;\\&#39; || (*++ state.ptr) != &#39;u&#39; ||</a>
<a class="sourceLine" id="cb18-20" data-line-number="20"><span class="st">-                        if (end - state.ptr &lt;= 6 || (*++ state.ptr) != &#39;\\&#39; || (*++ state.ptr) != &#39;u&#39; ||</span></a>
<a class="sourceLine" id="cb18-21" data-line-number="21"><span class="va">+                            (uc_b1 = hex_value (*++ state.ptr)) == 0xFF ||</span></a>
<a class="sourceLine" id="cb18-22" data-line-number="22">                            (uc_b2 = hex_value (*++ state.ptr)) == 0xFF ||</a></code></pre></div>
<p><a href="https://github.com/udp/json-parser/blob/b42439a2927a879f40698e4861e727c4265c13e6/json.c#L221"><strong>Full function:</strong></a></p>
<p>Too long, omitted, see <a href="https://github.com/udp/json-parser/blob/b42439a2927a879f40698e4861e727c4265c13e6/json.c#L221">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="mongoose"></p>
<h3 id="project-name-mongoose">Project Name: <a href="https://github.com/cesanta/mongoose">mongoose</a></h3>
<p><a name="websocket client bug #631"></p>
<h3 id="websocket-client-bug-631">1. <a href="https://github.com/cesanta/mongoose/issues/631">websocket client bug #631</a></h3>
<p><a href="https://github.com/cesanta/mongoose/issues/631"><strong>Description</strong></a></p>
<blockquote>
<p>the function mg_http_common_url_parse(…) has a bug，when parse url, such as: ws://localhost:8080/ws =&gt; host=locahost:8080, path=/ws now result is =&gt; host=localhost:8080, path=ws (that is error,not leading /)</p>
</blockquote>
<blockquote>
<p>the error occur because on the functio,code is:</p>
</blockquote>
<pre><code>if (*url == &#39;/&#39;) {
  url++;     ==&gt; that is error
  break;
}</code></pre>
<blockquote>
<p>Fix url path parsing</p>
</blockquote>
<blockquote>
<p>The url parser had two bugs:</p>
</blockquote>
<ul>
<li><p><code>http://example.com</code> -&gt; <code>GET // HTTP/1.1</code></p></li>
<li><p><code>foo://bar/baz</code> -&gt; path is <code>&quot;baz&quot;</code> instead of <code>&quot;/baz&quot;</code></p></li>
</ul>
<blockquote>
<p>Now the path returned by <code>mg_http_common_url_parse</code> always starts with <code>/</code>.</p>
</blockquote>
<p><a href="https://github.com/cesanta/mongoose/commit/29d6c4ac04d4eb5c7eca295a77c8df47fb04f12f"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="dt">@@ -7540,7 +7540,6 @@ static int mg_http_common_url_parse(const char *url, const char *schema,</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">      return -1;</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">    }</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">    if (*url == &#39;/&#39;) {</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="st">-      url++;</span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">      break;</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">    }</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">    if (*url == &#39;:&#39;) *port_i = addr_len;</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="dt">@@ -7632,7 +7631,7 @@ struct mg_connection *mg_connect_http(struct mg_mgr *mgr,</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10">    /* If the port was addred by us, restore the original host. */</a>
<a class="sourceLine" id="cb20-11" data-line-number="11">    if (port_i &gt;= 0) addr[port_i] = &#39;\0&#39;;</a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="st">-    mg_printf(nc, &quot;%s /%s HTTP/1.1\r\nHost: %s\r\nContent-Length: %&quot; SIZE_T_FMT</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="va">+    mg_printf(nc, &quot;%s %s HTTP/1.1\r\nHost: %s\r\nContent-Length: %&quot; SIZE_T_FMT</span></a></code></pre></div>
<p><a href="https://github.com/cesanta/mongoose/commit/29d6c4ac04d4eb5c7eca295a77c8df47fb04f12f"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb21-1" data-line-number="1"> <span class="dt">static</span> <span class="dt">int</span> mg_http_common_url_parse(<span class="dt">const</span> <span class="dt">char</span> *url, <span class="dt">const</span> <span class="dt">char</span> *schema,</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">                                     <span class="dt">const</span> <span class="dt">char</span> *schema_tls, <span class="dt">int</span> *use_ssl,</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">                                     <span class="dt">char</span> **addr, <span class="dt">int</span> *port_i,</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">                                     <span class="dt">const</span> <span class="dt">char</span> **path) {</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">   <span class="dt">int</span> addr_len = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb21-7" data-line-number="7">   <span class="cf">if</span> (memcmp(url, schema, strlen(schema)) == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">     url += strlen(schema);</a>
<a class="sourceLine" id="cb21-9" data-line-number="9">   } <span class="cf">else</span> <span class="cf">if</span> (memcmp(url, schema_tls, strlen(schema_tls)) == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb21-10" data-line-number="10">     url += strlen(schema_tls);</a>
<a class="sourceLine" id="cb21-11" data-line-number="11">     *use_ssl = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb21-12" data-line-number="12"> <span class="pp">#ifndef MG_ENABLE_SSL</span></a>
<a class="sourceLine" id="cb21-13" data-line-number="13">     <span class="cf">return</span> <span class="dv">-1</span>; <span class="co">/* SSL is not enabled, cannot do HTTPS URLs */</span></a>
<a class="sourceLine" id="cb21-14" data-line-number="14"> <span class="pp">#endif</span></a>
<a class="sourceLine" id="cb21-15" data-line-number="15">   }</a>
<a class="sourceLine" id="cb21-16" data-line-number="16"> </a>
<a class="sourceLine" id="cb21-17" data-line-number="17">   <span class="cf">while</span> (*url != &#39;\<span class="dv">0</span>&#39;) {</a>
<a class="sourceLine" id="cb21-18" data-line-number="18">     *addr = (<span class="dt">char</span> *) MG_REALLOC(*addr, addr_len + <span class="dv">5</span> <span class="co">/* space for port too. */</span>);</a>
<a class="sourceLine" id="cb21-19" data-line-number="19">     <span class="cf">if</span> (*addr == NULL) {</a>
<a class="sourceLine" id="cb21-20" data-line-number="20">       DBG((<span class="st">&quot;OOM&quot;</span>));</a>
<a class="sourceLine" id="cb21-21" data-line-number="21">      <span class="cf">return</span> <span class="dv">-1</span>;</a>
<a class="sourceLine" id="cb21-22" data-line-number="22">    }</a>
<a class="sourceLine" id="cb21-23" data-line-number="23">    <span class="cf">if</span> (*url == <span class="ch">&#39;/&#39;</span>) {</a>
<a class="sourceLine" id="cb21-24" data-line-number="24">      <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb21-25" data-line-number="25">    }</a>
<a class="sourceLine" id="cb21-26" data-line-number="26">    <span class="cf">if</span> (*url == <span class="ch">&#39;:&#39;</span>) *port_i = addr_len;</a>
<a class="sourceLine" id="cb21-27" data-line-number="27">@@ <span class="dv">-7632</span>,<span class="dv">7</span> +<span class="dv">7631</span>,<span class="dv">7</span> @@ <span class="kw">struct</span> mg_connection *mg_connect_http(<span class="kw">struct</span> mg_mgr *mgr,</a>
<a class="sourceLine" id="cb21-28" data-line-number="28">    <span class="co">/* If the port was addred by us, restore the original host. */</span></a>
<a class="sourceLine" id="cb21-29" data-line-number="29">    <span class="cf">if</span> (port_i &gt;= <span class="dv">0</span>) addr[port_i] = &#39;\<span class="dv">0</span>&#39;;</a>
<a class="sourceLine" id="cb21-30" data-line-number="30">    mg_printf(nc, <span class="st">&quot;%s %s HTTP/1.1</span><span class="sc">\r\n</span><span class="st">Host: %s</span><span class="sc">\r\n</span><span class="st">Content-Length: %&quot;</span> SIZE_T_FMT</a>
<a class="sourceLine" id="cb21-31" data-line-number="31">                  <span class="st">&quot;</span><span class="sc">\r\n</span><span class="st">%s</span><span class="sc">\r\n</span><span class="st">%s&quot;</span>,</a>
<a class="sourceLine" id="cb21-32" data-line-number="32">              post_data == NULL ? <span class="st">&quot;GET&quot;</span> : <span class="st">&quot;POST&quot;</span>, path, addr,</a>
<a class="sourceLine" id="cb21-33" data-line-number="33">              post_data == NULL ? <span class="dv">0</span> : strlen(post_data),</a>
<a class="sourceLine" id="cb21-34" data-line-number="34">               extra_headers == NULL ? <span class="st">&quot;&quot;</span> : extra_headers,</a>
<a class="sourceLine" id="cb21-35" data-line-number="35">               post_data == NULL ? <span class="st">&quot;&quot;</span> : post_data);</a>
<a class="sourceLine" id="cb21-36" data-line-number="36">   }</a>
<a class="sourceLine" id="cb21-37" data-line-number="37"> </a>
<a class="sourceLine" id="cb21-38" data-line-number="38">   MG_FREE(addr);</a>
<a class="sourceLine" id="cb21-39" data-line-number="39">   <span class="cf">return</span> nc;</a>
<a class="sourceLine" id="cb21-40" data-line-number="40"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="Firefox"></p>
<h3 id="project-name-firefox">Project Name: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5176">Firefox</a></h3>
<p><a name="Iframe injection & content spoofing & scripts execution via json viewer"></p>
<h3 id="iframe-injection-content-spoofing-scripts-execution-via-json-viewer">1. <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5176">Iframe injection &amp; content spoofing &amp; scripts execution via json viewer</a></h3>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5176"><strong>Description</strong></a></p>
<blockquote>
<p>The JSON Viewer displays clickable hyperlinks for strings that are parseable as URLs, including “javascript:” links. If a JSON file contains malicious JavaScript script embedded as “javascript:” links, users may be tricked into clicking and running this code in the context of the JSON Viewer. This can allow for the theft of cookies and authorization tokens which are accessible to that context. This vulnerability affects Firefox &lt; 60.</p>
</blockquote>
<p><a href="https://bugzilla.mozilla.org/attachment.cgi?id=8957304&amp;action=edit"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb22-1" data-line-number="1">       // Render the value (summary) using Reps library.</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">       return Rep(Object.assign({}, props, {</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">         cropLimit: 50,</a>
<a class="sourceLine" id="cb22-4" data-line-number="4">         noGrip: true,</a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="st">-        omitLinkHref: false,</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="va">+        openLink(str) {</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="va">+          try {</span></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="va">+            let u = new URL(str);</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="va">+            if (u.protocol == &quot;https:&quot; || u.protocol == &quot;http:&quot;) {</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="va">+              window.open(str, &quot;_blank&quot;);</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="va">+            }</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="va">+          } catch (ex) { /* the link might be bust, then we do nothing */ }</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="va">+        },</span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14">       }));</a></code></pre></div>
<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1442840"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co">// omitted</span></a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="poco"></p>
<h3 id="project-name-poco">Project Name: <a href="https://github.com/pocoproject/poco">poco</a></h3>
<p><a name="Zip Decompress Parent Path Injection #1968"></p>
<h3 id="zip-decompress-parent-path-injection-1968">1. <a href="https://github.com/pocoproject/poco/issues/1968">Zip Decompress Parent Path Injection #1968</a></h3>
<p><a href="https://github.com/pocoproject/poco/issues/1968"><strong>Description</strong></a></p>
<blockquote>
<p>By manipulation of the Zip input file header, the contents of the zip archive can be written to an arbitrary parent path of the user.</p>
</blockquote>
<blockquote>
<p>Expected behavior<br />
Throw an exception if filename contains a parent directory reference. isValidPath() (ZipCommon.cpp) should check if the filename contains a tilde character.</p>
</blockquote>
<blockquote>
<p>Actual behavior<br />
By inserting a tilde-slash (~/) in the filename area of the zip header, files can be written to the user’s home directory.</p>
</blockquote>
<blockquote>
<p>Steps to reproduce the problem<br />
Use the sample-unzip samle application as follows:</p>
</blockquote>
<pre><code>$ ./sample-unzip -f vuln.zip SOME_OUT_DIR
vuln.zip contains a file foo. foo includes the string bar</code></pre>
<p><a href="https://github.com/pocoproject/poco/commit/f5b2cf3dd6976ae53b2f3c9618b0087a0646cc7d"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb25-1" data-line-number="1">Zip/src/Decompress.cpp</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="dt">@@ -80,7 +80,7 @@ bool Decompress::handleZipEntry(std::istream&amp; zipStream, const ZipLocalFileHeade</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3">        {</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">            std::string dirName = hdr.getFileName();</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">            if (!ZipCommon::isValidPath(dirName))</a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="st">-               throw ZipException(&quot;Illegal entry name &quot; + dirName + &quot; containing parent directory reference&quot;);</span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="va">+               throw ZipException(&quot;Illegal entry name &quot; + dirName);</span></a>
<a class="sourceLine" id="cb25-8" data-line-number="8">            Poco::Path dir(_outDir, dirName);</a>
<a class="sourceLine" id="cb25-9" data-line-number="9">            dir.makeDirectory();</a>
<a class="sourceLine" id="cb25-10" data-line-number="10">            Poco::File aFile(dir);</a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="dt">@@ -100,7 +100,7 @@ bool Decompress::handleZipEntry(std::istream&amp; zipStream, const ZipLocalFileHeade</span></a>
<a class="sourceLine" id="cb25-12" data-line-number="12">        }</a>
<a class="sourceLine" id="cb25-13" data-line-number="13">        if (!ZipCommon::isValidPath(fileName))</a>
<a class="sourceLine" id="cb25-14" data-line-number="14"><span class="st">-           throw ZipException(&quot;Illegal entry name &quot; + fileName + &quot; containing parent directory reference&quot;);</span></a>
<a class="sourceLine" id="cb25-15" data-line-number="15"><span class="va">+           throw ZipException(&quot;Illegal entry name &quot; + fileName);</span></a>
<a class="sourceLine" id="cb25-16" data-line-number="16">        Poco::Path file(fileName);</a>
<a class="sourceLine" id="cb25-17" data-line-number="17">        file.makeFile();</a>
<a class="sourceLine" id="cb25-18" data-line-number="18"></a>
<a class="sourceLine" id="cb25-19" data-line-number="19">Zip/src/ZipCommon.cpp</a>
<a class="sourceLine" id="cb25-20" data-line-number="20"><span class="dt">@@ -21,15 +22,26 @@ namespace Zip {</span></a>
<a class="sourceLine" id="cb25-21" data-line-number="21"> bool ZipCommon::isValidPath(const std::string&amp; path)</a>
<a class="sourceLine" id="cb25-22" data-line-number="22">{</a>
<a class="sourceLine" id="cb25-23" data-line-number="23"><span class="va">+   if (!Path(path).isRelative())</span></a>
<a class="sourceLine" id="cb25-24" data-line-number="24"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-25" data-line-number="25"><span class="va">+   if (path == &quot;..&quot;)</span></a>
<a class="sourceLine" id="cb25-26" data-line-number="26"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-27" data-line-number="27"><span class="st">-   if (path.compare(0, 3, &quot;../&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-28" data-line-number="28"><span class="va">+   if ((path.size() &gt;= 3) &amp;&amp; path.compare(0, 3, &quot;../&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-29" data-line-number="29"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-30" data-line-number="30"><span class="va">+   if ((path.size() &gt;= 3) &amp;&amp; path.compare(0, 3, &quot;..\\&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-31" data-line-number="31"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-32" data-line-number="32"><span class="va">+   if (path.find(&quot;/../&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-33" data-line-number="33"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-34" data-line-number="34"><span class="va">+   if (path.find(&quot;\\..\\&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-35" data-line-number="35"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-36" data-line-number="36"><span class="va">+   if (path.find(&quot;/..\\&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-37" data-line-number="37">        return false;</a>
<a class="sourceLine" id="cb25-38" data-line-number="38"><span class="st">-   if (path.compare(0, 3, &quot;..\\&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-39" data-line-number="39"><span class="va">+   if (path.find(&quot;\\../&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-40" data-line-number="40">        return false;</a>
<a class="sourceLine" id="cb25-41" data-line-number="41"><span class="st">-   if (path.find(&quot;/..&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-42" data-line-number="42"><span class="va">+   if ((path.size() &gt;= 2) &amp;&amp; path.compare(0, 2, &quot;~/&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-43" data-line-number="43">        return false;</a>
<a class="sourceLine" id="cb25-44" data-line-number="44"><span class="st">-   if (path.find(&quot;\\..&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-45" data-line-number="45"><span class="va">+   if (path.size() &gt; 0 &amp;&amp; (path[0] == &#39;/&#39; || path[0] == &#39;\\&#39;))</span></a>
<a class="sourceLine" id="cb25-46" data-line-number="46">        return false;</a>
<a class="sourceLine" id="cb25-47" data-line-number="47">    return true;</a>
<a class="sourceLine" id="cb25-48" data-line-number="48">}</a></code></pre></div>
<p><a href="https://github.com/pocoproject/poco/commit/f5b2cf3dd6976ae53b2f3c9618b0087a0646cc7d"><strong>Full function:</strong></a></p>
<p>see <a href="https://github.com/pocoproject/poco/commit/f5b2cf3dd6976ae53b2f3c9618b0087a0646cc7d">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="CImg"></p>
<h3 id="project-name-cimg">Project Name: <a href="https://github.com/dtschump/CImg">CImg</a></h3>
<p><a name="other testcases lead to heap overflow by loading crafted images #185"></p>
<h3 id="other-testcases-lead-to-heap-overflow-by-loading-crafted-images-185">1. <a href="https://github.com/dtschump/CImg/issues/185">other testcases lead to heap overflow by loading crafted images #185</a></h3>
<p><a href="https://github.com/dtschump/CImg/issues/185"><strong>Description</strong></a></p>
<blockquote>
<p>An issue was discovered in CImg v.220. A heap-based buffer over-read in load_bmp in CImg.h occurs when loading a crafted bmp image, a different vulnerability than CVE-2018-7588. This is in a Monochrome case, aka case 1.</p>
</blockquote>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="dt">@@ -48331,7 +48331,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2">      if (header_size&gt;40) cimg::fseek(nfile,header_size - 40,SEEK_CUR);</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">       const int</a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="st">-        dx_bytes = (bpp==1)?(dx/8 + (dx%8?1:0)):((bpp==4)?(dx/2 + (dx%2)):(dx*bpp/8)),</span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5"><span class="va">+        dx_bytes = (bpp==1)?(dx/8 + (dx%8?1:0)):((bpp==4)?(dx/2 + (dx%2)):(int)((longT)dx*bpp/8)),</span></a>
<a class="sourceLine" id="cb26-6" data-line-number="6">        align_bytes = (4 - dx_bytes%4)%4;</a>
<a class="sourceLine" id="cb26-7" data-line-number="7">      const ulongT</a>
<a class="sourceLine" id="cb26-8" data-line-number="8">        cimg_iobuffer = (ulongT)24*1024*1024,</a>
<a class="sourceLine" id="cb26-9" data-line-number="9"><span class="dt">@@ -48363,10 +48363,10 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb26-10" data-line-number="10">      }</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">       // Read pixel data</a>
<a class="sourceLine" id="cb26-12" data-line-number="12"><span class="st">-      assign(dx,cimg::abs(dy),1,3);</span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13"><span class="va">+      assign(dx,cimg::abs(dy),1,3,0);</span></a>
<a class="sourceLine" id="cb26-14" data-line-number="14">      switch (bpp) {</a>
<a class="sourceLine" id="cb26-15" data-line-number="15"><span class="st">-      case 1 : { // Monochrome</span></a>
<a class="sourceLine" id="cb26-16" data-line-number="16"><span class="va">+        for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb26-17" data-line-number="17">        if (colormap._width&gt;=2) for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb26-18" data-line-number="18">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb26-19" data-line-number="19">            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</a>
<a class="sourceLine" id="cb26-20" data-line-number="20">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb26-21" data-line-number="21"><span class="dt">@@ -48384,7 +48384,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb26-22" data-line-number="22">        }</a>
<a class="sourceLine" id="cb26-23" data-line-number="23">      } break;</a>
<a class="sourceLine" id="cb26-24" data-line-number="24">      case 4 : { // 16 colors</a>
<a class="sourceLine" id="cb26-25" data-line-number="25"><span class="st">-        for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb26-26" data-line-number="26"><span class="va">+        if (colormap._width&gt;=16) for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb26-27" data-line-number="27">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb26-28" data-line-number="28">            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</a>
<a class="sourceLine" id="cb26-29" data-line-number="29">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb26-30" data-line-number="30"><span class="dt">@@ -48402,8 +48402,8 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb26-31" data-line-number="31">          ptrs+=align_bytes;</a>
<a class="sourceLine" id="cb26-32" data-line-number="32">        }</a>
<a class="sourceLine" id="cb26-33" data-line-number="33">      } break;</a>
<a class="sourceLine" id="cb26-34" data-line-number="34"><span class="st">-      case 8 : { //  256 colors</span></a>
<a class="sourceLine" id="cb26-35" data-line-number="35"><span class="st">-        for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb26-36" data-line-number="36"><span class="va">+      case 8 : { // 256 colors</span></a>
<a class="sourceLine" id="cb26-37" data-line-number="37"><span class="va">+        if (colormap._width&gt;=256) for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb26-38" data-line-number="38">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb26-39" data-line-number="39">            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</a>
<a class="sourceLine" id="cb26-40" data-line-number="40">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a></code></pre></div>
<p><a href="https://github.com/dtschump/CImg/commit/10af1e8c1ad2a58a0a3342a856bae63e8f257abb"><strong>Full function:</strong></a></p>
<p>The function is too long, see <a href="https://github.com/dtschump/CImg/commit/10af1e8c1ad2a58a0a3342a856bae63e8f257abb">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="double free when load bmp image #184"></p>
<h3 id="double-free-when-load-bmp-image-184">2. <a href="https://github.com/dtschump/CImg/issues/184">double free when load bmp image #184</a></h3>
<p><a href="https://github.com/dtschump/CImg/issues/184"><strong>Description</strong></a></p>
<p>An issue was discovered in CImg v.220. A double free in load_bmp in CImg.h occurs when loading a crafted bmp image.</p>
<p><a href="https://github.com/dtschump/CImg/commit/8447076ef22322a14a0ce130837e44c5ba8095f4"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="dt">@@ -48333,9 +48333,9 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2">      const int</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">        dx_bytes = (bpp==1)?(dx/8 + (dx%8?1:0)):((bpp==4)?(dx/2 + (dx%2)):(dx*bpp/8)),</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">        align_bytes = (4 - dx_bytes%4)%4;</a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="st">-      const longT</span></a>
<a class="sourceLine" id="cb27-6" data-line-number="6"><span class="st">-        cimg_iobuffer = (longT)24*1024*1024,</span></a>
<a class="sourceLine" id="cb27-7" data-line-number="7"><span class="st">-        buf_size = std::min((longT)cimg::abs(dy)*(dx_bytes + align_bytes),(longT)file_size - offset);</span></a>
<a class="sourceLine" id="cb27-8" data-line-number="8"><span class="va">+      const ulongT</span></a>
<a class="sourceLine" id="cb27-9" data-line-number="9"><span class="va">+        cimg_iobuffer = (ulongT)24*1024*1024,</span></a>
<a class="sourceLine" id="cb27-10" data-line-number="10"><span class="va">+        buf_size = std::min((ulongT)cimg::abs(dy)*(dx_bytes + align_bytes),(ulongT)file_size - offset);</span></a>
<a class="sourceLine" id="cb27-11" data-line-number="11">       CImg&lt;intT&gt; colormap;</a>
<a class="sourceLine" id="cb27-12" data-line-number="12">      if (bpp&lt;16) { if (!nb_colors) nb_colors = 1&lt;&lt;bpp; } else nb_colors = 0;</a>
<a class="sourceLine" id="cb27-13" data-line-number="13"><span class="dt">@@ -48368,7 +48368,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-14" data-line-number="14">      case 1 : { // Monochrome</a>
<a class="sourceLine" id="cb27-15" data-line-number="15">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb27-16" data-line-number="16">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-17" data-line-number="17"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb27-18" data-line-number="18"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb27-19" data-line-number="19">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-20" data-line-number="20">          }</a>
<a class="sourceLine" id="cb27-21" data-line-number="21">          unsigned char mask = 0x80, val = 0;</a>
<a class="sourceLine" id="cb27-22" data-line-number="22"><span class="dt">@@ -48386,7 +48386,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-23" data-line-number="23">      case 4 : { // 16 colors</a>
<a class="sourceLine" id="cb27-24" data-line-number="24">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb27-25" data-line-number="25">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-26" data-line-number="26"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb27-27" data-line-number="27"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb27-28" data-line-number="28">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-29" data-line-number="29">          }</a>
<a class="sourceLine" id="cb27-30" data-line-number="30">          unsigned char mask = 0xF0, val = 0;</a>
<a class="sourceLine" id="cb27-31" data-line-number="31"><span class="dt">@@ -48405,7 +48405,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-32" data-line-number="32">      case 8 : { //  256 colors</a>
<a class="sourceLine" id="cb27-33" data-line-number="33">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb27-34" data-line-number="34">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-35" data-line-number="35"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb27-36" data-line-number="36"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb27-37" data-line-number="37">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-38" data-line-number="38">          }</a>
<a class="sourceLine" id="cb27-39" data-line-number="39">          cimg_forX(*this,x) {</a>
<a class="sourceLine" id="cb27-40" data-line-number="40"><span class="dt">@@ -48420,7 +48420,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-41" data-line-number="41">      case 16 : { // 16 bits colors</a>
<a class="sourceLine" id="cb27-42" data-line-number="42">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb27-43" data-line-number="43">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-44" data-line-number="44"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb27-45" data-line-number="45"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb27-46" data-line-number="46">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-47" data-line-number="47">          }</a>
<a class="sourceLine" id="cb27-48" data-line-number="48">          cimg_forX(*this,x) {</a>
<a class="sourceLine" id="cb27-49" data-line-number="49"><span class="dt">@@ -48436,7 +48436,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-50" data-line-number="50">      case 24 : { // 24 bits colors</a>
<a class="sourceLine" id="cb27-51" data-line-number="51">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb27-52" data-line-number="52">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-53" data-line-number="53"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb27-54" data-line-number="54"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb27-55" data-line-number="55">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-56" data-line-number="56">          }</a>
<a class="sourceLine" id="cb27-57" data-line-number="57">          cimg_forX(*this,x) {</a>
<a class="sourceLine" id="cb27-58" data-line-number="58"><span class="dt">@@ -48450,7 +48450,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-59" data-line-number="59">      case 32 : { // 32 bits colors</a>
<a class="sourceLine" id="cb27-60" data-line-number="60">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb27-61" data-line-number="61">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-62" data-line-number="62"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb27-63" data-line-number="63"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb27-64" data-line-number="64">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-65" data-line-number="65">          }</a>
<a class="sourceLine" id="cb27-66" data-line-number="66">          cimg_forX(*this,x) {</a></code></pre></div>
<p><a href="https://github.com/dtschump/CImg/commit/8447076ef22322a14a0ce130837e44c5ba8095f4"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/dtschump/CImg/commit/8447076ef22322a14a0ce130837e44c5ba8095f4">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="a heap overflow when load a bmp image #183"></p>
<h3 id="a-heap-overflow-when-load-a-bmp-image-183">3. <a href="">a heap overflow when load a bmp image #183</a></h3>
<p><a href="https://github.com/dtschump/CImg/issues/183"><strong>Description</strong></a></p>
<p>An issue was discovered in CImg v.220. A heap-based buffer over-read in load_bmp in CImg.h occurs when loading a crafted bmp image.</p>
<p><a href="https://github.com/dtschump/CImg/commit/8447076ef22322a14a0ce130837e44c5ba8095f4"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="dt">@@ -48333,9 +48333,9 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2">      const int</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">        dx_bytes = (bpp==1)?(dx/8 + (dx%8?1:0)):((bpp==4)?(dx/2 + (dx%2)):(dx*bpp/8)),</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">        align_bytes = (4 - dx_bytes%4)%4;</a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="st">-      const longT</span></a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="st">-        cimg_iobuffer = (longT)24*1024*1024,</span></a>
<a class="sourceLine" id="cb28-7" data-line-number="7"><span class="st">-        buf_size = std::min((longT)cimg::abs(dy)*(dx_bytes + align_bytes),(longT)file_size - offset);</span></a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="va">+      const ulongT</span></a>
<a class="sourceLine" id="cb28-9" data-line-number="9"><span class="va">+        cimg_iobuffer = (ulongT)24*1024*1024,</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10"><span class="va">+        buf_size = std::min((ulongT)cimg::abs(dy)*(dx_bytes + align_bytes),(ulongT)file_size - offset);</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11">       CImg&lt;intT&gt; colormap;</a>
<a class="sourceLine" id="cb28-12" data-line-number="12">      if (bpp&lt;16) { if (!nb_colors) nb_colors = 1&lt;&lt;bpp; } else nb_colors = 0;</a>
<a class="sourceLine" id="cb28-13" data-line-number="13"><span class="dt">@@ -48368,7 +48368,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb28-14" data-line-number="14">      case 1 : { // Monochrome</a>
<a class="sourceLine" id="cb28-15" data-line-number="15">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb28-16" data-line-number="16">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb28-17" data-line-number="17"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb28-18" data-line-number="18"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb28-19" data-line-number="19">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb28-20" data-line-number="20">          }</a>
<a class="sourceLine" id="cb28-21" data-line-number="21">          unsigned char mask = 0x80, val = 0;</a>
<a class="sourceLine" id="cb28-22" data-line-number="22"><span class="dt">@@ -48386,7 +48386,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb28-23" data-line-number="23">      case 4 : { // 16 colors</a>
<a class="sourceLine" id="cb28-24" data-line-number="24">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb28-25" data-line-number="25">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb28-26" data-line-number="26"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb28-27" data-line-number="27"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb28-28" data-line-number="28">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb28-29" data-line-number="29">          }</a>
<a class="sourceLine" id="cb28-30" data-line-number="30">          unsigned char mask = 0xF0, val = 0;</a>
<a class="sourceLine" id="cb28-31" data-line-number="31"><span class="dt">@@ -48405,7 +48405,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb28-32" data-line-number="32">      case 8 : { //  256 colors</a>
<a class="sourceLine" id="cb28-33" data-line-number="33">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb28-34" data-line-number="34">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb28-35" data-line-number="35"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb28-36" data-line-number="36"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb28-37" data-line-number="37">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb28-38" data-line-number="38">          }</a>
<a class="sourceLine" id="cb28-39" data-line-number="39">          cimg_forX(*this,x) {</a>
<a class="sourceLine" id="cb28-40" data-line-number="40"><span class="dt">@@ -48420,7 +48420,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb28-41" data-line-number="41">      case 16 : { // 16 bits colors</a>
<a class="sourceLine" id="cb28-42" data-line-number="42">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb28-43" data-line-number="43">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb28-44" data-line-number="44"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb28-45" data-line-number="45"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb28-46" data-line-number="46">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb28-47" data-line-number="47">          }</a>
<a class="sourceLine" id="cb28-48" data-line-number="48">          cimg_forX(*this,x) {</a>
<a class="sourceLine" id="cb28-49" data-line-number="49"><span class="dt">@@ -48436,7 +48436,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb28-50" data-line-number="50">      case 24 : { // 24 bits colors</a>
<a class="sourceLine" id="cb28-51" data-line-number="51">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb28-52" data-line-number="52">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb28-53" data-line-number="53"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb28-54" data-line-number="54"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb28-55" data-line-number="55">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb28-56" data-line-number="56">          }</a>
<a class="sourceLine" id="cb28-57" data-line-number="57">          cimg_forX(*this,x) {</a>
<a class="sourceLine" id="cb28-58" data-line-number="58"><span class="dt">@@ -48450,7 +48450,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb28-59" data-line-number="59">      case 32 : { // 32 bits colors</a>
<a class="sourceLine" id="cb28-60" data-line-number="60">        for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb28-61" data-line-number="61">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb28-62" data-line-number="62"><span class="st">-            cimg::fread(ptrs=buffer._data,dx_bytes,nfile);</span></a>
<a class="sourceLine" id="cb28-63" data-line-number="63"><span class="va">+            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</span></a>
<a class="sourceLine" id="cb28-64" data-line-number="64">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb28-65" data-line-number="65">          }</a>
<a class="sourceLine" id="cb28-66" data-line-number="66">          cimg_forX(*this,x) {</a></code></pre></div>
<p><a href="https://github.com/dtschump/CImg/commit/8447076ef22322a14a0ce130837e44c5ba8095f4"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/dtschump/CImg/commit/8447076ef22322a14a0ce130837e44c5ba8095f4">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="ImageMagick"></p>
<h3 id="project-name-imagemagick">Project Name: <a href="https://github.com/ImageMagick/ImageMagick">ImageMagick</a></h3>
<p><a name="heap-buffer-overflow in SVGStripString of svg.c #1336"></p>
<h3 id="heap-buffer-overflow-in-svgstripstring-of-svg.c-1336">1. <a href="https://github.com/ImageMagick/ImageMagick/issues/1336">heap-buffer-overflow in SVGStripString of svg.c #1336</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/1336"><strong>Description</strong></a></p>
<blockquote>
<p>In ImageMagick 7.0.8-13 Q16, there is a heap-based buffer over-read in the SVGStripString function of coders/svg.c, which allows attackers to cause a denial of service via a crafted SVG image file.</p>
</blockquote>
<p><a href="https://github.com/ImageMagick/ImageMagick6/commit/a5db4873626f702d2ddd8bc293573493e0a412c0"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb29-1" data-line-number="1">      {</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">        for ( ; *p != &#39;\0&#39;; p++)</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">          if ((*p == &#39;*&#39;) &amp;&amp; (*(p+1) == &#39;/&#39;))</a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="st">-            break;</span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="va">+            {</span></a>
<a class="sourceLine" id="cb29-6" data-line-number="6"><span class="va">+              p+=2;</span></a>
<a class="sourceLine" id="cb29-7" data-line-number="7"><span class="va">+              break;</span></a>
<a class="sourceLine" id="cb29-8" data-line-number="8"><span class="va">+            }</span></a>
<a class="sourceLine" id="cb29-9" data-line-number="9">        if (*p == &#39;\0&#39;)</a>
<a class="sourceLine" id="cb29-10" data-line-number="10">          break;</a>
<a class="sourceLine" id="cb29-11" data-line-number="11"><span class="st">-        p+=2;</span></a>
<a class="sourceLine" id="cb29-12" data-line-number="12">      }</a>
<a class="sourceLine" id="cb29-13" data-line-number="13">    *q++=(*p);</a>
<a class="sourceLine" id="cb29-14" data-line-number="14">  }</a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick6/commit/a5db4873626f702d2ddd8bc293573493e0a412c0"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb30-1" data-line-number="1"> <span class="dt">static</span> <span class="dt">void</span> SVGStripString(<span class="dt">const</span> MagickBooleanType trim,<span class="dt">char</span> *message)</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"> {</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">   <span class="dt">register</span> <span class="dt">char</span></a>
<a class="sourceLine" id="cb30-4" data-line-number="4">     *p,</a>
<a class="sourceLine" id="cb30-5" data-line-number="5">     *q;</a>
<a class="sourceLine" id="cb30-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb30-7" data-line-number="7">   <span class="dt">size_t</span></a>
<a class="sourceLine" id="cb30-8" data-line-number="8">     length;</a>
<a class="sourceLine" id="cb30-9" data-line-number="9"> </a>
<a class="sourceLine" id="cb30-10" data-line-number="10">   assert(message != (<span class="dt">char</span> *) NULL);</a>
<a class="sourceLine" id="cb30-11" data-line-number="11">   <span class="cf">if</span> (*message == &#39;\<span class="dv">0</span>&#39;)</a>
<a class="sourceLine" id="cb30-12" data-line-number="12">     <span class="cf">return</span>;</a>
<a class="sourceLine" id="cb30-13" data-line-number="13">   <span class="co">/*</span></a>
<a class="sourceLine" id="cb30-14" data-line-number="14"><span class="co">     Remove comment.</span></a>
<a class="sourceLine" id="cb30-15" data-line-number="15"><span class="co">   */</span></a>
<a class="sourceLine" id="cb30-16" data-line-number="16">   q=message;</a>
<a class="sourceLine" id="cb30-17" data-line-number="17">   <span class="cf">for</span> (p=message; *p != &#39;\<span class="dv">0</span>&#39;; p++)</a>
<a class="sourceLine" id="cb30-18" data-line-number="18">   {</a>
<a class="sourceLine" id="cb30-19" data-line-number="19">     <span class="cf">if</span> ((*p == <span class="ch">&#39;/&#39;</span>) &amp;&amp; (*(p+<span class="dv">1</span>) == <span class="ch">&#39;*&#39;</span>))</a>
<a class="sourceLine" id="cb30-20" data-line-number="20">      {</a>
<a class="sourceLine" id="cb30-21" data-line-number="21">        <span class="cf">for</span> ( ; *p != &#39;\<span class="dv">0</span>&#39;; p++)</a>
<a class="sourceLine" id="cb30-22" data-line-number="22">          <span class="cf">if</span> ((*p == <span class="ch">&#39;*&#39;</span>) &amp;&amp; (*(p+<span class="dv">1</span>) == <span class="ch">&#39;/&#39;</span>))</a>
<a class="sourceLine" id="cb30-23" data-line-number="23">            {</a>
<a class="sourceLine" id="cb30-24" data-line-number="24">              p+=<span class="dv">2</span>;</a>
<a class="sourceLine" id="cb30-25" data-line-number="25">              <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb30-26" data-line-number="26">            }</a>
<a class="sourceLine" id="cb30-27" data-line-number="27">        <span class="cf">if</span> (*p == &#39;\<span class="dv">0</span>&#39;)</a>
<a class="sourceLine" id="cb30-28" data-line-number="28">          <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb30-29" data-line-number="29">      }</a>
<a class="sourceLine" id="cb30-30" data-line-number="30">    *q++=(*p);</a>
<a class="sourceLine" id="cb30-31" data-line-number="31">  }</a>
<a class="sourceLine" id="cb30-32" data-line-number="32">   *q=&#39;\<span class="dv">0</span>&#39;;</a>
<a class="sourceLine" id="cb30-33" data-line-number="33">   <span class="cf">if</span> (trim != MagickFalse)</a>
<a class="sourceLine" id="cb30-34" data-line-number="34">     {</a>
<a class="sourceLine" id="cb30-35" data-line-number="35">       <span class="co">/*</span></a>
<a class="sourceLine" id="cb30-36" data-line-number="36"><span class="co">         Remove whitespace.</span></a>
<a class="sourceLine" id="cb30-37" data-line-number="37"><span class="co">       */</span></a>
<a class="sourceLine" id="cb30-38" data-line-number="38">       length=strlen(message);</a>
<a class="sourceLine" id="cb30-39" data-line-number="39">       p=message;</a>
<a class="sourceLine" id="cb30-40" data-line-number="40">       <span class="cf">while</span> (isspace((<span class="dt">int</span>) ((<span class="dt">unsigned</span> <span class="dt">char</span>) *p)) != <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb30-41" data-line-number="41">         p++;</a>
<a class="sourceLine" id="cb30-42" data-line-number="42">       <span class="cf">if</span> ((*p == <span class="ch">&#39;\&#39;&#39;</span>) || (*p == <span class="ch">&#39;&quot;&#39;</span>))</a>
<a class="sourceLine" id="cb30-43" data-line-number="43">         p++;</a>
<a class="sourceLine" id="cb30-44" data-line-number="44">       q=message+length<span class="dv">-1</span>;</a>
<a class="sourceLine" id="cb30-45" data-line-number="45">       <span class="cf">while</span> ((isspace((<span class="dt">int</span>) ((<span class="dt">unsigned</span> <span class="dt">char</span>) *q)) != <span class="dv">0</span>) &amp;&amp; (q &gt; p))</a>
<a class="sourceLine" id="cb30-46" data-line-number="46">         q--;</a>
<a class="sourceLine" id="cb30-47" data-line-number="47">       <span class="cf">if</span> (q &gt; p)</a>
<a class="sourceLine" id="cb30-48" data-line-number="48">         <span class="cf">if</span> ((*q == <span class="ch">&#39;\&#39;&#39;</span>) || (*q == <span class="ch">&#39;&quot;&#39;</span>))</a>
<a class="sourceLine" id="cb30-49" data-line-number="49">           q--;</a>
<a class="sourceLine" id="cb30-50" data-line-number="50">       (<span class="dt">void</span>) memmove(message,p,(<span class="dt">size_t</span>) (q-p+<span class="dv">1</span>));</a>
<a class="sourceLine" id="cb30-51" data-line-number="51">       message[q-p+<span class="dv">1</span>]=&#39;\<span class="dv">0</span>&#39;;</a>
<a class="sourceLine" id="cb30-52" data-line-number="52">     }</a>
<a class="sourceLine" id="cb30-53" data-line-number="53">   <span class="co">/*</span></a>
<a class="sourceLine" id="cb30-54" data-line-number="54"><span class="co">     Convert newlines to a space.</span></a>
<a class="sourceLine" id="cb30-55" data-line-number="55"><span class="co">   */</span></a>
<a class="sourceLine" id="cb30-56" data-line-number="56">   <span class="cf">for</span> (p=message; *p != &#39;\<span class="dv">0</span>&#39;; p++)</a>
<a class="sourceLine" id="cb30-57" data-line-number="57">     <span class="cf">if</span> (*p == <span class="ch">&#39;\n&#39;</span>)</a>
<a class="sourceLine" id="cb30-58" data-line-number="58">       *p=<span class="ch">&#39; &#39;</span>;</a>
<a class="sourceLine" id="cb30-59" data-line-number="59"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="heap-buffer-overflow in EncodeImage of pict.c #1335"></p>
<h3 id="heap-buffer-overflow-in-encodeimage-of-pict.c-1335">2. <a href="https://github.com/ImageMagick/ImageMagick/issues/1335">heap-buffer-overflow in EncodeImage of pict.c #1335</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/1335"><strong>Description</strong></a></p>
<blockquote>
<p>In ImageMagick 7.0.8-13 Q16, there is a heap-based buffer over-read in the EncodeImage function of coders/pict.c, which allows attackers to cause a denial of service via a crafted SVG image file.</p>
</blockquote>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="dt">@@ -444,7 +444,7 @@ static unsigned char *DecodeImage(Image *blob,Image *image,</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2">    bytes_per_line=width;</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">  row_bytes=(size_t) (image-&gt;columns | 0x8000);</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">  if (image-&gt;storage_class == DirectClass)</a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="st">-    row_bytes=(size_t) (4*(image-&gt;columns | 0x8000));</span></a>
<a class="sourceLine" id="cb31-6" data-line-number="6"><span class="va">+    row_bytes=(size_t) ((4*image-&gt;columns) | 0x8000);</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7">  /*</a>
<a class="sourceLine" id="cb31-8" data-line-number="8">    Allocate pixel and scanline buffer.</a>
<a class="sourceLine" id="cb31-9" data-line-number="9">  */</a>
<a class="sourceLine" id="cb31-10" data-line-number="10"><span class="dt">@@ -1778,7 +1778,7 @@ static MagickBooleanType WritePICTImage(const ImageInfo *image_info,</span></a>
<a class="sourceLine" id="cb31-11" data-line-number="11">  /*</a>
<a class="sourceLine" id="cb31-12" data-line-number="12">    Allocate memory.</a>
<a class="sourceLine" id="cb31-13" data-line-number="13">  */</a>
<a class="sourceLine" id="cb31-14" data-line-number="14"><span class="st">-  bytes_per_line=image-&gt;columns | 0x8000;</span></a>
<a class="sourceLine" id="cb31-15" data-line-number="15"><span class="va">+  bytes_per_line=image-&gt;columns;</span></a>
<a class="sourceLine" id="cb31-16" data-line-number="16">  if (storage_class == DirectClass)</a>
<a class="sourceLine" id="cb31-17" data-line-number="17">    bytes_per_line*=image-&gt;alpha_trait != UndefinedPixelTrait ? 4 : 3;</a>
<a class="sourceLine" id="cb31-18" data-line-number="18">  buffer=(unsigned char *) AcquireQuantumMemory(PictInfoSize,sizeof(*buffer));</a>
<a class="sourceLine" id="cb31-19" data-line-number="19"><span class="dt">@@ -1799,7 +1799,8 @@ static MagickBooleanType WritePICTImage(const ImageInfo *image_info,</span></a>
<a class="sourceLine" id="cb31-20" data-line-number="20">      ThrowWriterException(ResourceLimitError,&quot;MemoryAllocationFailed&quot;);</a>
<a class="sourceLine" id="cb31-21" data-line-number="21">    }</a>
<a class="sourceLine" id="cb31-22" data-line-number="22">  (void) memset(scanline,0,row_bytes);</a>
<a class="sourceLine" id="cb31-23" data-line-number="23"><span class="st">-  (void) memset(packed_scanline,0,(size_t) (row_bytes+2*MaxCount));</span></a>
<a class="sourceLine" id="cb31-24" data-line-number="24"><span class="va">+  (void) memset(packed_scanline,0,(size_t) (row_bytes+2*MaxCount)*</span></a>
<a class="sourceLine" id="cb31-25" data-line-number="25"><span class="va">+    sizeof(*packed_scanline));</span></a>
<a class="sourceLine" id="cb31-26" data-line-number="26">  /*</a>
<a class="sourceLine" id="cb31-27" data-line-number="27">    Write header, header size, size bounding box, version, and reserved.</a>
<a class="sourceLine" id="cb31-28" data-line-number="28">  */</a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/1a22fc0c8837838e60daecc0bf01648f359dd6fd#diff-9f0be979d8a302c3f34029647fc77cbdR450"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/ImageMagick/ImageMagick/commit/1a22fc0c8837838e60daecc0bf01648f359dd6fd#diff-9f0be979d8a302c3f34029647fc77cbdR450">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="heap-buffer-overflow in MagickCore #1156"></p>
<h3 id="heap-buffer-overflow-in-magickcore-1156">3. <a href="https://github.com/ImageMagick/ImageMagick/issues/1156">heap-buffer-overflow in MagickCore #1156</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/1156"><strong>Description</strong></a></p>
<blockquote>
<p>In ImageMagick 7.0.7-37 Q16, SetGrayscaleImage in the quantize.c file allows attackers to cause a heap-based buffer over-read via a crafted file.</p>
</blockquote>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb32-1" data-line-number="1">  if (image-&gt;type != GrayscaleType)</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">    (void) TransformImageColorspace(image,GRAYColorspace,exception);</a>
<a class="sourceLine" id="cb32-3" data-line-number="3">  if (image-&gt;storage_class == PseudoClass)</a>
<a class="sourceLine" id="cb32-4" data-line-number="4"><span class="st">-    colormap_index=(ssize_t *) AcquireQuantumMemory(image-&gt;colors,</span></a>
<a class="sourceLine" id="cb32-5" data-line-number="5"><span class="va">+    colormap_index=(ssize_t *) AcquireQuantumMemory(image-&gt;colors+1,</span></a>
<a class="sourceLine" id="cb32-6" data-line-number="6">      sizeof(*colormap_index));</a>
<a class="sourceLine" id="cb32-7" data-line-number="7">  else</a>
<a class="sourceLine" id="cb32-8" data-line-number="8"><span class="st">-    colormap_index=(ssize_t *) AcquireQuantumMemory(MaxColormapSize,</span></a>
<a class="sourceLine" id="cb32-9" data-line-number="9"><span class="va">+    colormap_index=(ssize_t *) AcquireQuantumMemory(MaxColormapSize+1,</span></a>
<a class="sourceLine" id="cb32-10" data-line-number="10">      sizeof(*colormap_index));</a>
<a class="sourceLine" id="cb32-11" data-line-number="11">  if (colormap_index == (ssize_t *) NULL)</a>
<a class="sourceLine" id="cb32-12" data-line-number="12">    ThrowBinaryException(ResourceLimitError,&quot;MemoryAllocationFailed&quot;,</a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/5294966898532a6bd54699fbf04edf18902513ac#diff-b422c231973548d46a04db74c7cb8e58R3448"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/ImageMagick/ImageMagick/commit/5294966898532a6bd54699fbf04edf18902513ac#diff-b422c231973548d46a04db74c7cb8e58R3448">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="heap-buffer-overflow #1009"></p>
<h3 id="heap-buffer-overflow-1009">4. <a href="https://github.com/ImageMagick/ImageMagick/issues/1009">heap-buffer-overflow #1009</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/1009"><strong>Description</strong></a></p>
<p>In ImageMagick 7.0.7-24 Q16, there is a heap-based buffer over-read in IsWEBPImageLossless in coders/webp.c.</p>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/4f7196b0b7539b113f2580b6a77aa496813d8899"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="dt">@@ -181,6 +181,8 @@ static MagickBooleanType IsWEBPImageLossless(const unsigned char *stream,</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2">  /*</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">    Read simple header.</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">  */</a>
<a class="sourceLine" id="cb33-5" data-line-number="5"><span class="va">+  if (length &lt;= VP8_CHUNK_INDEX)</span></a>
<a class="sourceLine" id="cb33-6" data-line-number="6"><span class="va">+    return(MagickFalse);</span></a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/4f7196b0b7539b113f2580b6a77aa496813d8899"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb34-1" data-line-number="1"> <span class="dt">static</span> MagickBooleanType IsWEBPImageLossless(<span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> *stream,</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">   <span class="dt">const</span> <span class="dt">size_t</span> length)</a>
<a class="sourceLine" id="cb34-3" data-line-number="3"> {</a>
<a class="sourceLine" id="cb34-4" data-line-number="4"> <span class="pp">#define VP8_CHUNK_INDEX  15</span></a>
<a class="sourceLine" id="cb34-5" data-line-number="5"> <span class="pp">#define LOSSLESS_FLAG  &#39;L&#39;</span></a>
<a class="sourceLine" id="cb34-6" data-line-number="6"> <span class="pp">#define EXTENDED_HEADER  &#39;X&#39;</span></a>
<a class="sourceLine" id="cb34-7" data-line-number="7"> <span class="pp">#define VP8_CHUNK_HEADER  &quot;VP8&quot;</span></a>
<a class="sourceLine" id="cb34-8" data-line-number="8"> <span class="pp">#define VP8_CHUNK_HEADER_SIZE  3</span></a>
<a class="sourceLine" id="cb34-9" data-line-number="9"> <span class="pp">#define RIFF_HEADER_SIZE  12</span></a>
<a class="sourceLine" id="cb34-10" data-line-number="10"> <span class="pp">#define VP8X_CHUNK_SIZE  10</span></a>
<a class="sourceLine" id="cb34-11" data-line-number="11"> <span class="pp">#define TAG_SIZE  4</span></a>
<a class="sourceLine" id="cb34-12" data-line-number="12"> <span class="pp">#define CHUNK_SIZE_BYTES  4</span></a>
<a class="sourceLine" id="cb34-13" data-line-number="13"> <span class="pp">#define CHUNK_HEADER_SIZE  8</span></a>
<a class="sourceLine" id="cb34-14" data-line-number="14"> <span class="pp">#define MAX_CHUNK_PAYLOAD  (~0U-CHUNK_HEADER_SIZE-1)</span></a>
<a class="sourceLine" id="cb34-15" data-line-number="15"> </a>
<a class="sourceLine" id="cb34-16" data-line-number="16">   <span class="dt">ssize_t</span></a>
<a class="sourceLine" id="cb34-17" data-line-number="17">     offset;</a>
<a class="sourceLine" id="cb34-18" data-line-number="18"> </a>
<a class="sourceLine" id="cb34-19" data-line-number="19">  <span class="co">/*</span></a>
<a class="sourceLine" id="cb34-20" data-line-number="20"><span class="co">    Read simple header.</span></a>
<a class="sourceLine" id="cb34-21" data-line-number="21"><span class="co">  */</span></a>
<a class="sourceLine" id="cb34-22" data-line-number="22">  <span class="cf">if</span> (length &lt;= VP8_CHUNK_INDEX)</a>
<a class="sourceLine" id="cb34-23" data-line-number="23">    <span class="cf">return</span>(MagickFalse);</a>
<a class="sourceLine" id="cb34-24" data-line-number="24">  <span class="cf">if</span> (stream[VP8_CHUNK_INDEX] != EXTENDED_HEADER)</a>
<a class="sourceLine" id="cb34-25" data-line-number="25">    <span class="cf">return</span>(stream[VP8_CHUNK_INDEX] == LOSSLESS_FLAG ? MagickTrue : MagickFalse);</a>
<a class="sourceLine" id="cb34-26" data-line-number="26">  <span class="co">/*</span></a>
<a class="sourceLine" id="cb34-27" data-line-number="27"><span class="co">     Read extended header.</span></a>
<a class="sourceLine" id="cb34-28" data-line-number="28"><span class="co">   */</span></a>
<a class="sourceLine" id="cb34-29" data-line-number="29">   offset=RIFF_HEADER_SIZE+TAG_SIZE+CHUNK_SIZE_BYTES+VP8X_CHUNK_SIZE;</a>
<a class="sourceLine" id="cb34-30" data-line-number="30">   <span class="cf">while</span> (offset &lt;= (<span class="dt">ssize_t</span>) (length-TAG_SIZE))</a>
<a class="sourceLine" id="cb34-31" data-line-number="31">   {</a>
<a class="sourceLine" id="cb34-32" data-line-number="32">     <span class="dt">uint32_t</span></a>
<a class="sourceLine" id="cb34-33" data-line-number="33">       chunk_size,</a>
<a class="sourceLine" id="cb34-34" data-line-number="34">       chunk_size_pad;</a>
<a class="sourceLine" id="cb34-35" data-line-number="35"> </a>
<a class="sourceLine" id="cb34-36" data-line-number="36">     chunk_size=ReadWebPLSBWord(stream+offset+TAG_SIZE);</a>
<a class="sourceLine" id="cb34-37" data-line-number="37">     <span class="cf">if</span> (chunk_size &gt; MAX_CHUNK_PAYLOAD)</a>
<a class="sourceLine" id="cb34-38" data-line-number="38">       <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb34-39" data-line-number="39">     chunk_size_pad=(CHUNK_HEADER_SIZE+chunk_size+<span class="dv">1</span>) &amp; ~<span class="dv">1</span>;</a>
<a class="sourceLine" id="cb34-40" data-line-number="40">     <span class="cf">if</span> (memcmp(stream+offset,VP8_CHUNK_HEADER,VP8_CHUNK_HEADER_SIZE) == <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb34-41" data-line-number="41">       <span class="cf">return</span>(*(stream+offset+VP8_CHUNK_HEADER_SIZE) == LOSSLESS_FLAG ?</a>
<a class="sourceLine" id="cb34-42" data-line-number="42">         MagickTrue : MagickFalse);</a>
<a class="sourceLine" id="cb34-43" data-line-number="43">     offset+=chunk_size_pad;</a>
<a class="sourceLine" id="cb34-44" data-line-number="44">   }</a>
<a class="sourceLine" id="cb34-45" data-line-number="45">   <span class="cf">return</span>(MagickFalse);</a>
<a class="sourceLine" id="cb34-46" data-line-number="46"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="Stack over-read in MagickCore/accelerate.c due to type mismatch #967"></p>
<h3 id="stack-over-read-in-magickcoreaccelerate.c-due-to-type-mismatch-967">5. <a href="#Stack%20over-read%20in%20MagickCore/accelerate.c%20due%20to%20type%20mismatch%20#967">Stack over-read in MagickCore/accelerate.c due to type mismatch #967</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/967"><strong>Description</strong></a></p>
<p>A stack-based buffer over-read in the ComputeResizeImage function in the MagickCore/accelerate.c file of ImageMagick 7.0.7-22 allows a remote attacker to cause a denial of service (application crash) via a maliciously crafted pict file.</p>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/6aa7d5d9a39b6d42a4f6c7eacd6ad2169b68fc4f"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="dt">@@ -4325,7 +4325,7 @@ static Image *ComputeResizeImage(const Image* image,MagickCLEnv clEnv,</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">  for (i = 0; i &lt; 7; i++)</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">    coefficientBuffer[i]=(float) resizeFilterCoefficient[i];</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">  cubicCoefficientsBuffer=CreateOpenCLBuffer(device,CL_MEM_COPY_HOST_PTR |</a>
<a class="sourceLine" id="cb35-5" data-line-number="5"><span class="st">-    CL_MEM_READ_ONLY,7*sizeof(*cubicCoefficientsBuffer),&amp;coefficientBuffer);</span></a>
<a class="sourceLine" id="cb35-6" data-line-number="6"><span class="va">+    CL_MEM_READ_ONLY,sizeof(coefficientBuffer),&amp;coefficientBuffer);</span></a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/6aa7d5d9a39b6d42a4f6c7eacd6ad2169b68fc4f"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/ImageMagick/ImageMagick/commit/6aa7d5d9a39b6d42a4f6c7eacd6ad2169b68fc4f#diff-8368336e30a67e0e3c22fec282b6baccR4263">here</a>, it has a lot of comparisons.</p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="ArduinoJson"></p>
<h3 id="project-name-arduinojson">Project Name: <a href="https://github.com/bblanchon/ArduinoJson">ArduinoJson</a></h3>
<p><a name="Update QuotedString.cpp #81"></p>
<h3 id="update-quotedstring.cpp-81">1. <a href="https://github.com/bblanchon/ArduinoJson/pull/81">Update QuotedString.cpp #81</a></h3>
<p><a href="https://github.com/bblanchon/ArduinoJson/pull/81"><strong>Description</strong></a></p>
<blockquote>
<p>The extractFrom function in Internals/QuotedString.cpp in Arduino JSON before 4.5 allows remote attackers to cause a denial of service (crash) via a JSON string with a  (backslash) followed by a terminator, as demonstrated by “\\0”, which triggers a buffer overflow and over-read.</p>
</blockquote>
<p><a href="https://github.com/bblanchon/ArduinoJson/commit/5e7b9ec688d79e7b16ec7064e1d37e8481a31e72"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="dt">@@ -58,46 +58,44 @@ static char unescapeChar(char c) {</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2">static inline bool isQuote(char c) { return c == &#39;\&quot;&#39; || c == &#39;\&#39;&#39;; }</a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="st">- char *QuotedString::extractFrom(char *input, char **endPtr) {</span></a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="st">-  char firstChar = *input;</span></a>
<a class="sourceLine" id="cb36-5" data-line-number="5"><span class="st">-   if (!isQuote(firstChar)) {</span></a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="st">-    // must start with a quote</span></a>
<a class="sourceLine" id="cb36-7" data-line-number="7"><span class="st">-    return NULL;</span></a>
<a class="sourceLine" id="cb36-8" data-line-number="8"><span class="st">-  }</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9"><span class="st">-   char stopChar = firstChar;  // closing quote is the same as opening quote</span></a>
<a class="sourceLine" id="cb36-10" data-line-number="10">   char *startPtr = input + 1;  // skip the quote</a>
<a class="sourceLine" id="cb36-11" data-line-number="11">  char *readPtr = startPtr;</a>
<a class="sourceLine" id="cb36-12" data-line-number="12">  char *writePtr = startPtr;</a>
<a class="sourceLine" id="cb36-13" data-line-number="13">  char c;</a>
<a class="sourceLine" id="cb36-14" data-line-number="14"><span class="va">+   char firstChar = *input;</span></a>
<a class="sourceLine" id="cb36-15" data-line-number="15"><span class="va">+  char stopChar = firstChar;  // closing quote is the same as opening quote</span></a>
<a class="sourceLine" id="cb36-16" data-line-number="16"><span class="va">+   if (!isQuote(firstChar)) goto ERROR_OPENING_QUOTE_MISSING;</span></a>
<a class="sourceLine" id="cb36-17" data-line-number="17">   for (;;) {</a>
<a class="sourceLine" id="cb36-18" data-line-number="18">    c = *readPtr++;</a>
<a class="sourceLine" id="cb36-19" data-line-number="19"><span class="st">-     if (c == &#39;\0&#39;) {</span></a>
<a class="sourceLine" id="cb36-20" data-line-number="20"><span class="st">-      // premature ending</span></a>
<a class="sourceLine" id="cb36-21" data-line-number="21"><span class="st">-      return NULL;</span></a>
<a class="sourceLine" id="cb36-22" data-line-number="22"><span class="st">-    }</span></a>
<a class="sourceLine" id="cb36-23" data-line-number="23"><span class="va">+    if (c == &#39;\0&#39;) goto ERROR_CLOSING_QUOTE_MISSING;</span></a>
<a class="sourceLine" id="cb36-24" data-line-number="24"><span class="st">-     if (c == stopChar) {</span></a>
<a class="sourceLine" id="cb36-25" data-line-number="25"><span class="st">-      // closing quote</span></a>
<a class="sourceLine" id="cb36-26" data-line-number="26"><span class="st">-      break;</span></a>
<a class="sourceLine" id="cb36-27" data-line-number="27"><span class="st">-    }</span></a>
<a class="sourceLine" id="cb36-28" data-line-number="28"><span class="va">+    if (c == stopChar) goto SUCCESS;</span></a>
<a class="sourceLine" id="cb36-29" data-line-number="29">     if (c == &#39;\\&#39;) {</a>
<a class="sourceLine" id="cb36-30" data-line-number="30">      // replace char</a>
<a class="sourceLine" id="cb36-31" data-line-number="31">      c = unescapeChar(*readPtr++);</a>
<a class="sourceLine" id="cb36-32" data-line-number="32"><span class="va">+      if (c == &#39;\0&#39;) goto ERROR_ESCAPE_SEQUENCE_INTERRUPTED;</span></a>
<a class="sourceLine" id="cb36-33" data-line-number="33">    }</a>
<a class="sourceLine" id="cb36-34" data-line-number="34">     *writePtr++ = c;</a>
<a class="sourceLine" id="cb36-35" data-line-number="35">  }</a>
<a class="sourceLine" id="cb36-36" data-line-number="36"><span class="va">+ SUCCESS:</span></a>
<a class="sourceLine" id="cb36-37" data-line-number="37">  // end the string here</a>
<a class="sourceLine" id="cb36-38" data-line-number="38">  *writePtr = &#39;\0&#39;;</a>
<a class="sourceLine" id="cb36-39" data-line-number="39">   // update end ptr</a>
<a class="sourceLine" id="cb36-40" data-line-number="40">  *endPtr = readPtr;</a>
<a class="sourceLine" id="cb36-41" data-line-number="41"><span class="va">+   // return pointer to unquoted string</span></a>
<a class="sourceLine" id="cb36-42" data-line-number="42">  return startPtr;</a>
<a class="sourceLine" id="cb36-43" data-line-number="43"><span class="va">+ ERROR_OPENING_QUOTE_MISSING:</span></a>
<a class="sourceLine" id="cb36-44" data-line-number="44"><span class="va">+ ERROR_CLOSING_QUOTE_MISSING:</span></a>
<a class="sourceLine" id="cb36-45" data-line-number="45"><span class="va">+ ERROR_ESCAPE_SEQUENCE_INTERRUPTED:</span></a>
<a class="sourceLine" id="cb36-46" data-line-number="46"><span class="va">+   return NULL;</span></a>
<a class="sourceLine" id="cb36-47" data-line-number="47">}</a></code></pre></div>
<p><a href="https://github.com/bblanchon/ArduinoJson/commit/5e7b9ec688d79e7b16ec7064e1d37e8481a31e72"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="dt">char</span> *QuotedString::extractFrom(<span class="dt">char</span> *input, <span class="dt">char</span> **endPtr) {</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">  <span class="dt">char</span> firstChar = *input;</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">   <span class="cf">if</span> (!isQuote(firstChar)) {</a>
<a class="sourceLine" id="cb37-4" data-line-number="4">    <span class="co">// must start with a quote</span></a>
<a class="sourceLine" id="cb37-5" data-line-number="5">    <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb37-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb37-7" data-line-number="7">   <span class="dt">char</span> stopChar = firstChar;  <span class="co">// closing quote is the same as opening quote</span></a>
<a class="sourceLine" id="cb37-8" data-line-number="8">   <span class="dt">char</span> *startPtr = input + <span class="dv">1</span>;  <span class="co">// skip the quote</span></a>
<a class="sourceLine" id="cb37-9" data-line-number="9">  <span class="dt">char</span> *readPtr = startPtr;</a>
<a class="sourceLine" id="cb37-10" data-line-number="10">  <span class="dt">char</span> *writePtr = startPtr;</a>
<a class="sourceLine" id="cb37-11" data-line-number="11">  <span class="dt">char</span> c;</a>
<a class="sourceLine" id="cb37-12" data-line-number="12">   <span class="cf">for</span> (;;) {</a>
<a class="sourceLine" id="cb37-13" data-line-number="13">    c = *readPtr++;</a>
<a class="sourceLine" id="cb37-14" data-line-number="14">     <span class="cf">if</span> (c == &#39;\<span class="dv">0</span>&#39;) {</a>
<a class="sourceLine" id="cb37-15" data-line-number="15">      <span class="co">// premature ending</span></a>
<a class="sourceLine" id="cb37-16" data-line-number="16">      <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb37-17" data-line-number="17">    }</a>
<a class="sourceLine" id="cb37-18" data-line-number="18">     <span class="cf">if</span> (c == stopChar) {</a>
<a class="sourceLine" id="cb37-19" data-line-number="19">      <span class="co">// closing quote</span></a>
<a class="sourceLine" id="cb37-20" data-line-number="20">      <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb37-21" data-line-number="21">    }</a>
<a class="sourceLine" id="cb37-22" data-line-number="22">     <span class="cf">if</span> (c == <span class="ch">&#39;\\&#39;</span>) {</a>
<a class="sourceLine" id="cb37-23" data-line-number="23">      <span class="co">// replace char</span></a>
<a class="sourceLine" id="cb37-24" data-line-number="24">      c = unescapeChar(*readPtr++);</a>
<a class="sourceLine" id="cb37-25" data-line-number="25">    }</a>
<a class="sourceLine" id="cb37-26" data-line-number="26">     *writePtr++ = c;</a>
<a class="sourceLine" id="cb37-27" data-line-number="27">  }</a>
<a class="sourceLine" id="cb37-28" data-line-number="28">  <span class="co">// end the string here</span></a>
<a class="sourceLine" id="cb37-29" data-line-number="29">  *writePtr = &#39;\<span class="dv">0</span>&#39;;</a>
<a class="sourceLine" id="cb37-30" data-line-number="30">   <span class="co">// update end ptr</span></a>
<a class="sourceLine" id="cb37-31" data-line-number="31">  *endPtr = readPtr;</a>
<a class="sourceLine" id="cb37-32" data-line-number="32">  <span class="cf">return</span> startPtr;</a>
<a class="sourceLine" id="cb37-33" data-line-number="33">}</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="get<String> returns -0 for 0 #808"></p>
<h3 id="get-returns--0-for-0-808">2. <a href="https://github.com/bblanchon/ArduinoJson/issues/808">get<String> returns -0 for 0 #808</a></h3>
<p><a href="https://github.com/bblanchon/ArduinoJson/issues/808"><strong>Description</strong></a></p>
<blockquote>
<p>get<String> returns different outputs of 0 for v6.3.0-beta and v6.2.3-beta. In case of v6.3.0-beta it returns “-0” (minus occurs before 0), but in case of v6.2.3-beta it returns “0”.</p>
</blockquote>
<blockquote>
<p>Example:</p>
</blockquote>
<pre><code>char json[] = &quot;{\&quot;x\&quot;:0}&quot;;
StaticJsonDocument&lt;256&gt; doc;
deserializeJson(doc, json);
JsonObject object = doc.as&lt;JsonObject&gt;();
obj[&quot;x_str&quot;] = object.get&lt;String&gt;(&quot;x&quot;);
obj[&quot;x_uint&quot;] = object.get&lt;unsigned int&gt;(&quot;x&quot;);</code></pre>
<blockquote>
<p>Output in case of v6.3.0-beta:</p>
</blockquote>
<pre><code>x_str = &quot;-0&quot;
x_uint = 0</code></pre>
<blockquote>
<p>Output in case of v6.2.3-beta:</p>
</blockquote>
<pre><code>x_str = &quot;0&quot;
x_uint = 0</code></pre>
<p><a href="https://github.com/bblanchon/ArduinoJson/commit/98c8e8e35a19c7b41ca7b97008867f98415480bc"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="dt">@@ -30,13 +30,6 @@ struct JsonVariantData {</span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2">    content.asFloat = value;</a>
<a class="sourceLine" id="cb41-3" data-line-number="3">  }</a>
<a class="sourceLine" id="cb41-4" data-line-number="4"><span class="st">-   void setInteger(JsonInteger value) {</span></a>
<a class="sourceLine" id="cb41-5" data-line-number="5"><span class="st">-    if (value &gt; 0)</span></a>
<a class="sourceLine" id="cb41-6" data-line-number="6"><span class="st">-      setPostiveInteger(static_cast&lt;JsonUInt&gt;(value));</span></a>
<a class="sourceLine" id="cb41-7" data-line-number="7"><span class="st">-    else</span></a>
<a class="sourceLine" id="cb41-8" data-line-number="8"><span class="st">-      setNegativeInteger(static_cast&lt;JsonUInt&gt;(-value));</span></a>
<a class="sourceLine" id="cb41-9" data-line-number="9"><span class="st">-  }</span></a>
<a class="sourceLine" id="cb41-10" data-line-number="10">   void setNegativeInteger(JsonUInt value) {</a>
<a class="sourceLine" id="cb41-11" data-line-number="11">    type = JSON_NEGATIVE_INTEGER;</a>
<a class="sourceLine" id="cb41-12" data-line-number="12">    content.asInteger = value;</a></code></pre></div>
<p><a href="https://github.com/bblanchon/ArduinoJson/commit/98c8e8e35a19c7b41ca7b97008867f98415480bc"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb42-1" data-line-number="1">  <span class="dt">void</span> setInteger(JsonInteger value) {</a>
<a class="sourceLine" id="cb42-2" data-line-number="2">    <span class="cf">if</span> (value &gt; <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb42-3" data-line-number="3">      setPostiveInteger(static_cast&lt;JsonUInt&gt;(value));</a>
<a class="sourceLine" id="cb42-4" data-line-number="4">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb42-5" data-line-number="5">      setNegativeInteger(static_cast&lt;JsonUInt&gt;(-value));</a>
<a class="sourceLine" id="cb42-6" data-line-number="6">  }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="out-of-bounds read in coders/sun.c:582:57 #375"></p>
<h3 id="out-of-bounds-read-in-coderssun.c58257-375">1. <a href="https://github.com/ImageMagick/ImageMagick/issues/375">out-of-bounds read in coders/sun.c:582:57 #375</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/375"><strong>Description</strong></a></p>
<p>An issue was discovered in ImageMagick 6.9.7. A specially crafted sun file triggers a heap-based buffer over-read.</p>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/3007531bfd326c5c1e29cd41d2cd80c166de8528"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="dt">@@ -458,7 +458,7 @@ static Image *ReadSUNImage(const ImageInfo *image_info,ExceptionInfo *exception)</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2">        ThrowReaderException(ResourceLimitError,&quot;ImproperImageHeader&quot;);</a>
<a class="sourceLine" id="cb43-3" data-line-number="3">      }</a>
<a class="sourceLine" id="cb43-4" data-line-number="4">    pixels_length=height*bytes_per_line;</a>
<a class="sourceLine" id="cb43-5" data-line-number="5">    sun_pixels=(unsigned char *) AcquireQuantumMemory(pixels_length,</a>
<a class="sourceLine" id="cb43-6" data-line-number="6">    sun_pixels=(unsigned char *) AcquireQuantumMemory(pixels_length+image-&gt;rows,</a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/3007531bfd326c5c1e29cd41d2cd80c166de8528"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/ImageMagick/ImageMagick/commit/3007531bfd326c5c1e29cd41d2cd80c166de8528#diff-faffa511c4f3a41db200d63cb3cadd9bR303">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="FFmpeg"></p>
<h3 id="project-name-ffmpeg">Project Name: <a href="https://github.com/FFmpeg/FFmpeg">FFmpeg</a></h3>
<p><a name="integer overflow and out of array access"></p>
<h3 id="integer-overflow-and-out-of-array-access">1. <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1999011">integer overflow and out of array access</a></h3>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1999011"><strong>Description</strong></a></p>
<blockquote>
<p>Buffer Overflow vulnerability in asf_o format demuxer that can result in heap-buffer-overflow that may result in remote code execution. This attack appears to be exploitable via specially crafted ASF file that has to be provided as input to FFmpeg.</p>
</blockquote>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/2b46ebdbff1d8dec7a3d8ea280a612b91a582869"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="dt">@@ -706,7 +706,8 @@ static int parse_video_info(AVIOContext *pb, AVStream *st)</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2">    st-&gt;codecpar-&gt;codec_id  = ff_codec_get_id(ff_codec_bmp_tags, tag);</a>
<a class="sourceLine" id="cb44-3" data-line-number="3">    size_bmp = FFMAX(size_asf, size_bmp);</a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="st">-    if (size_bmp &gt; BMP_HEADER_SIZE) {</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5"><span class="va">+    if (size_bmp &gt; BMP_HEADER_SIZE &amp;&amp;</span></a>
<a class="sourceLine" id="cb44-6" data-line-number="6"><span class="va">+        size_bmp &lt; INT_MAX - AV_INPUT_BUFFER_PADDING_SIZE) {</span></a>
<a class="sourceLine" id="cb44-7" data-line-number="7">        int ret;</a>
<a class="sourceLine" id="cb44-8" data-line-number="8">        st-&gt;codecpar-&gt;extradata_size  = size_bmp - BMP_HEADER_SIZE;</a>
<a class="sourceLine" id="cb44-9" data-line-number="9">        if (!(st-&gt;codecpar-&gt;extradata = av_malloc(st-&gt;codecpar-&gt;extradata_size +</a></code></pre></div>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/2b46ebdbff1d8dec7a3d8ea280a612b91a582869"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb45-1" data-line-number="1"> <span class="dt">static</span> <span class="dt">int</span> parse_video_info(AVIOContext *pb, AVStream *st)</a>
<a class="sourceLine" id="cb45-2" data-line-number="2"> {</a>
<a class="sourceLine" id="cb45-3" data-line-number="3">     <span class="dt">uint16_t</span> size_asf; <span class="co">// ASF-specific Format Data size</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4">     <span class="dt">uint32_t</span> size_bmp; <span class="co">// BMP_HEADER-specific Format Data size</span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5">     <span class="dt">unsigned</span> <span class="dt">int</span> tag;</a>
<a class="sourceLine" id="cb45-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb45-7" data-line-number="7">     st-&gt;codecpar-&gt;width  = avio_rl32(pb);</a>
<a class="sourceLine" id="cb45-8" data-line-number="8">     st-&gt;codecpar-&gt;height = avio_rl32(pb);</a>
<a class="sourceLine" id="cb45-9" data-line-number="9">     avio_skip(pb, <span class="dv">1</span>); <span class="co">// skip reserved flags</span></a>
<a class="sourceLine" id="cb45-10" data-line-number="10">     size_asf = avio_rl16(pb);</a>
<a class="sourceLine" id="cb45-11" data-line-number="11">     tag = ff_get_bmp_header(pb, st, &amp;size_bmp);</a>
<a class="sourceLine" id="cb45-12" data-line-number="12">     st-&gt;codecpar-&gt;codec_tag = tag;</a>
<a class="sourceLine" id="cb45-13" data-line-number="13">    st-&gt;codecpar-&gt;codec_id  = ff_codec_get_id(ff_codec_bmp_tags, tag);</a>
<a class="sourceLine" id="cb45-14" data-line-number="14">    size_bmp = FFMAX(size_asf, size_bmp);</a>
<a class="sourceLine" id="cb45-15" data-line-number="15">    <span class="cf">if</span> (size_bmp &gt; BMP_HEADER_SIZE &amp;&amp;</a>
<a class="sourceLine" id="cb45-16" data-line-number="16">        size_bmp &lt; INT_MAX - AV_INPUT_BUFFER_PADDING_SIZE) {</a>
<a class="sourceLine" id="cb45-17" data-line-number="17">        <span class="dt">int</span> ret;</a>
<a class="sourceLine" id="cb45-18" data-line-number="18">        st-&gt;codecpar-&gt;extradata_size  = size_bmp - BMP_HEADER_SIZE;</a>
<a class="sourceLine" id="cb45-19" data-line-number="19">        <span class="cf">if</span> (!(st-&gt;codecpar-&gt;extradata = av_malloc(st-&gt;codecpar-&gt;extradata_size +</a>
<a class="sourceLine" id="cb45-20" data-line-number="20">                                                AV_INPUT_BUFFER_PADDING_SIZE))) {</a>
<a class="sourceLine" id="cb45-21" data-line-number="21">             st-&gt;codecpar-&gt;extradata_size = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb45-22" data-line-number="22">             <span class="cf">return</span> AVERROR(ENOMEM);</a>
<a class="sourceLine" id="cb45-23" data-line-number="23">         }</a>
<a class="sourceLine" id="cb45-24" data-line-number="24">         memset(st-&gt;codecpar-&gt;extradata + st-&gt;codecpar-&gt;extradata_size , <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb45-25" data-line-number="25">                AV_INPUT_BUFFER_PADDING_SIZE);</a>
<a class="sourceLine" id="cb45-26" data-line-number="26">         <span class="cf">if</span> ((ret = avio_read(pb, st-&gt;codecpar-&gt;extradata,</a>
<a class="sourceLine" id="cb45-27" data-line-number="27">                              st-&gt;codecpar-&gt;extradata_size)) &lt; <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb45-28" data-line-number="28">             <span class="cf">return</span> ret;</a>
<a class="sourceLine" id="cb45-29" data-line-number="29">     }</a>
<a class="sourceLine" id="cb45-30" data-line-number="30">     <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb45-31" data-line-number="31"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="Fix multiple runtime error: index 256 out of bounds"></p>
<h3 id="fix-multiple-runtime-error-index-256-out-of-bounds">2. <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-9995">Fix multiple runtime error: index 256 out of bounds</a></h3>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-9995"><strong>Description</strong></a></p>
<p>libavcodec/scpr.c in FFmpeg 3.3 before 3.3.1 does not properly validate height and width data, which allows remote attackers to cause a denial of service (heap-based buffer overflow and application crash) or possibly have unspecified other impact via a crafted file.</p>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/2171dfae8c065878a2e130390eb78cf2947a5b69"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="va">+    if (x &gt;= 16 || c &gt;= 256) {</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="va">+        return AVERROR_INVALIDDATA;</span></a>
<a class="sourceLine" id="cb46-3" data-line-number="3"><span class="va">+    }</span></a></code></pre></div>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/2171dfae8c065878a2e130390eb78cf2947a5b69"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb47-1" data-line-number="1"> <span class="dt">static</span> <span class="dt">int</span> decode_unit(SCPRContext *s, PixelModel *pixel, <span class="dt">unsigned</span> step, <span class="dt">unsigned</span> *rval)</a>
<a class="sourceLine" id="cb47-2" data-line-number="2"> {</a>
<a class="sourceLine" id="cb47-3" data-line-number="3">     GetByteContext *gb = &amp;s-&gt;gb;</a>
<a class="sourceLine" id="cb47-4" data-line-number="4">     RangeCoder *rc = &amp;s-&gt;rc;</a>
<a class="sourceLine" id="cb47-5" data-line-number="5">     <span class="dt">unsigned</span> totfr = pixel-&gt;total_freq;</a>
<a class="sourceLine" id="cb47-6" data-line-number="6">     <span class="dt">unsigned</span> value, x = <span class="dv">0</span>, cumfr = <span class="dv">0</span>, cnt_x = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb47-7" data-line-number="7">     <span class="dt">int</span> i, j, ret, c, cnt_c;</a>
<a class="sourceLine" id="cb47-8" data-line-number="8"> </a>
<a class="sourceLine" id="cb47-9" data-line-number="9">     <span class="cf">if</span> ((ret = s-&gt;get_freq(rc, totfr, &amp;value)) &lt; <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb47-10" data-line-number="10">         <span class="cf">return</span> ret;</a>
<a class="sourceLine" id="cb47-11" data-line-number="11"> </a>
<a class="sourceLine" id="cb47-12" data-line-number="12">     <span class="cf">while</span> (x &lt; <span class="dv">16</span>) {</a>
<a class="sourceLine" id="cb47-13" data-line-number="13">         cnt_x = pixel-&gt;lookup[x];</a>
<a class="sourceLine" id="cb47-14" data-line-number="14">         <span class="cf">if</span> (value &gt;= cumfr + cnt_x)</a>
<a class="sourceLine" id="cb47-15" data-line-number="15">             cumfr += cnt_x;</a>
<a class="sourceLine" id="cb47-16" data-line-number="16">         <span class="cf">else</span></a>
<a class="sourceLine" id="cb47-17" data-line-number="17">             <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb47-18" data-line-number="18">         x++;</a>
<a class="sourceLine" id="cb47-19" data-line-number="19">     }</a>
<a class="sourceLine" id="cb47-20" data-line-number="20"> </a>
<a class="sourceLine" id="cb47-21" data-line-number="21">     c = x * <span class="dv">16</span>;</a>
<a class="sourceLine" id="cb47-22" data-line-number="22">     cnt_c = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb47-23" data-line-number="23">     <span class="cf">while</span> (c &lt; <span class="dv">256</span>) {</a>
<a class="sourceLine" id="cb47-24" data-line-number="24">         cnt_c = pixel-&gt;freq[c];</a>
<a class="sourceLine" id="cb47-25" data-line-number="25">         <span class="cf">if</span> (value &gt;= cumfr + cnt_c)</a>
<a class="sourceLine" id="cb47-26" data-line-number="26">             cumfr += cnt_c;</a>
<a class="sourceLine" id="cb47-27" data-line-number="27">         <span class="cf">else</span></a>
<a class="sourceLine" id="cb47-28" data-line-number="28">            <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb47-29" data-line-number="29">        c++;</a>
<a class="sourceLine" id="cb47-30" data-line-number="30">    }</a>
<a class="sourceLine" id="cb47-31" data-line-number="31">    <span class="cf">if</span> (x &gt;= <span class="dv">16</span> || c &gt;= <span class="dv">256</span>) {</a>
<a class="sourceLine" id="cb47-32" data-line-number="32">        <span class="cf">return</span> AVERROR_INVALIDDATA;</a>
<a class="sourceLine" id="cb47-33" data-line-number="33">    }</a>
<a class="sourceLine" id="cb47-34" data-line-number="34">     <span class="cf">if</span> ((ret = s-&gt;decode(gb, rc, cumfr, cnt_c, totfr)) &lt; <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb47-35" data-line-number="35">        <span class="cf">return</span> ret;</a>
<a class="sourceLine" id="cb47-36" data-line-number="36"> </a>
<a class="sourceLine" id="cb47-37" data-line-number="37">     pixel-&gt;freq[c] = cnt_c + step;</a>
<a class="sourceLine" id="cb47-38" data-line-number="38">     pixel-&gt;lookup[x] = cnt_x + step;</a>
<a class="sourceLine" id="cb47-39" data-line-number="39">     totfr += step;</a>
<a class="sourceLine" id="cb47-40" data-line-number="40">     <span class="cf">if</span> (totfr &gt; BOT) {</a>
<a class="sourceLine" id="cb47-41" data-line-number="41">         totfr = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb47-42" data-line-number="42">         <span class="cf">for</span> (i = <span class="dv">0</span>; i &lt; <span class="dv">256</span>; i++) {</a>
<a class="sourceLine" id="cb47-43" data-line-number="43">             <span class="dt">unsigned</span> nc = (pixel-&gt;freq[i] &gt;&gt; <span class="dv">1</span>) + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb47-44" data-line-number="44">             pixel-&gt;freq[i] = nc;</a>
<a class="sourceLine" id="cb47-45" data-line-number="45">             totfr += nc;</a>
<a class="sourceLine" id="cb47-46" data-line-number="46">         }</a>
<a class="sourceLine" id="cb47-47" data-line-number="47">         <span class="cf">for</span> (i = <span class="dv">0</span>; i &lt; <span class="dv">16</span>; i++) {</a>
<a class="sourceLine" id="cb47-48" data-line-number="48">             <span class="dt">unsigned</span> sum = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb47-49" data-line-number="49">             <span class="dt">unsigned</span> i16_17 = i &lt;&lt; <span class="dv">4</span>;</a>
<a class="sourceLine" id="cb47-50" data-line-number="50">             <span class="cf">for</span> (j = <span class="dv">0</span>; j &lt; <span class="dv">16</span>; j++)</a>
<a class="sourceLine" id="cb47-51" data-line-number="51">                 sum += pixel-&gt;freq[i16_17 + j];</a>
<a class="sourceLine" id="cb47-52" data-line-number="52">             pixel-&gt;lookup[i] = sum;</a>
<a class="sourceLine" id="cb47-53" data-line-number="53">         }</a>
<a class="sourceLine" id="cb47-54" data-line-number="54">     }</a>
<a class="sourceLine" id="cb47-55" data-line-number="55">     pixel-&gt;total_freq = totfr;</a>
<a class="sourceLine" id="cb47-56" data-line-number="56"> </a>
<a class="sourceLine" id="cb47-57" data-line-number="57">     *rval = c &amp; s-&gt;cbits;</a>
<a class="sourceLine" id="cb47-58" data-line-number="58"> </a>
<a class="sourceLine" id="cb47-59" data-line-number="59">     <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb47-60" data-line-number="60"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="http: make length/offset-related variables unsigned."></p>
<h3 id="http-make-lengthoffset-related-variables-unsigned.">3. <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-10190">http: make length/offset-related variables unsigned.</a></h3>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-10190"><strong>Description</strong></a></p>
<p>Heap-based buffer overflow in libavformat/http.c in FFmpeg before 2.8.10, 3.0.x before 3.0.5, 3.1.x before 3.1.6, and 3.2.x before 3.2.2 allows remote web servers to execute arbitrary code via a negative chunk size in an HTTP response.</p>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/2a05c8f813de6f2278827734bf8102291e7484aa"><strong>Patch code:</strong></a></p>
<p>Too many files edited, see <a href="https://github.com/FFmpeg/FFmpeg/commit/2a05c8f813de6f2278827734bf8102291e7484aa">here</a></p>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/2a05c8f813de6f2278827734bf8102291e7484aa"><strong>Full function:</strong></a></p>
<p>Too many files edited, see <a href="https://github.com/FFmpeg/FFmpeg/commit/2a05c8f813de6f2278827734bf8102291e7484aa">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="FFmpeg before 2017-01-24 has an out-of-bounds write caused by a heap-based buffer overflow"></p>
<h3 id="ffmpeg-before-2017-01-24-has-an-out-of-bounds-write-caused-by-a-heap-based-buffer-overflow">4. <a href="">FFmpeg before 2017-01-24 has an out-of-bounds write caused by a heap-based buffer overflow</a></h3>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7865"><strong>Description</strong></a></p>
<p>FFmpeg before 2017-01-24 has an out-of-bounds write caused by a heap-based buffer overflow related to the ipvideo_decode_block_opcode_0xA function in libavcodec/interplayvideo.c and the avcodec_align_dimensions2 function in libavcodec/utils.c.</p>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/2080bc33717955a0e4268e738acf8c1eeddbf8cb"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="dt">@@ -376,6 +376,10 @@ void avcodec_align_dimensions2(AVCodecContext *s, int *width, int *height,</span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2">            w_align = 4;</a>
<a class="sourceLine" id="cb48-3" data-line-number="3">            h_align = 4;</a>
<a class="sourceLine" id="cb48-4" data-line-number="4">        }</a>
<a class="sourceLine" id="cb48-5" data-line-number="5"><span class="va">+        if (s-&gt;codec_id == AV_CODEC_ID_INTERPLAY_VIDEO) {</span></a>
<a class="sourceLine" id="cb48-6" data-line-number="6"><span class="va">+            w_align = 8;</span></a>
<a class="sourceLine" id="cb48-7" data-line-number="7"><span class="va">+            h_align = 8;</span></a>
<a class="sourceLine" id="cb48-8" data-line-number="8"><span class="va">+        }</span></a>
<a class="sourceLine" id="cb48-9" data-line-number="9">        break;</a>
<a class="sourceLine" id="cb48-10" data-line-number="10">    case AV_PIX_FMT_PAL8:</a>
<a class="sourceLine" id="cb48-11" data-line-number="11">    case AV_PIX_FMT_BGR8:</a>
<a class="sourceLine" id="cb48-12" data-line-number="12"><span class="dt">@@ -385,7 +389,8 @@ void avcodec_align_dimensions2(AVCodecContext *s, int *width, int *height,</span></a>
<a class="sourceLine" id="cb48-13" data-line-number="13">            w_align = 4;</a>
<a class="sourceLine" id="cb48-14" data-line-number="14">            h_align = 4;</a>
<a class="sourceLine" id="cb48-15" data-line-number="15">        }</a>
<a class="sourceLine" id="cb48-16" data-line-number="16"><span class="st">-        if (s-&gt;codec_id == AV_CODEC_ID_JV) {</span></a>
<a class="sourceLine" id="cb48-17" data-line-number="17"><span class="va">+        if (s-&gt;codec_id == AV_CODEC_ID_JV ||</span></a>
<a class="sourceLine" id="cb48-18" data-line-number="18"><span class="va">+            s-&gt;codec_id == AV_CODEC_ID_INTERPLAY_VIDEO) {</span></a>
<a class="sourceLine" id="cb48-19" data-line-number="19">            w_align = 8;</a>
<a class="sourceLine" id="cb48-20" data-line-number="20">            h_align = 8;</a>
<a class="sourceLine" id="cb48-21" data-line-number="21">        }</a></code></pre></div>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/2080bc33717955a0e4268e738acf8c1eeddbf8cb#diff-d7031e4f689033d5546668b25eb9dd30R260"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/FFmpeg/FFmpeg/commit/2080bc33717955a0e4268e738acf8c1eeddbf8cb#diff-d7031e4f689033d5546668b25eb9dd30R260">here</a>, it has a lot of comparisons.</p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="FFmpeg before 2017-01-23 has an out-of-bounds write caused by a stack-based buffer overflow"></p>
<h3 id="ffmpeg-before-2017-01-23-has-an-out-of-bounds-write-caused-by-a-stack-based-buffer-overflow">5. <a href="">FFmpeg before 2017-01-23 has an out-of-bounds write caused by a stack-based buffer overflow</a></h3>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7866"><strong>Description</strong></a></p>
<p>FFmpeg before 2017-01-23 has an out-of-bounds write caused by a stack-based buffer overflow related to the decode_zbuf function in libavcodec/pngdec.c. References</p>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/e371f031b942d73e02c090170975561fabd5c264"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb49-1" data-line-number="1"><span class="dt">@@ -437,13 +437,13 @@ static int decode_zbuf(AVBPrint *bp, const uint8_t *data,</span></a>
<a class="sourceLine" id="cb49-2" data-line-number="2">    av_bprint_init(bp, 0, -1);</a>
<a class="sourceLine" id="cb49-3" data-line-number="3">     while (zstream.avail_in &gt; 0) {</a>
<a class="sourceLine" id="cb49-4" data-line-number="4"><span class="st">-        av_bprint_get_buffer(bp, 1, &amp;buf, &amp;buf_size);</span></a>
<a class="sourceLine" id="cb49-5" data-line-number="5"><span class="st">-        if (!buf_size) {</span></a>
<a class="sourceLine" id="cb49-6" data-line-number="6"><span class="va">+        av_bprint_get_buffer(bp, 2, &amp;buf, &amp;buf_size);</span></a>
<a class="sourceLine" id="cb49-7" data-line-number="7"><span class="va">+        if (buf_size &lt; 2) {</span></a>
<a class="sourceLine" id="cb49-8" data-line-number="8">            ret = AVERROR(ENOMEM);</a>
<a class="sourceLine" id="cb49-9" data-line-number="9">            goto fail;</a>
<a class="sourceLine" id="cb49-10" data-line-number="10">        }</a>
<a class="sourceLine" id="cb49-11" data-line-number="11">        zstream.next_out  = buf;</a>
<a class="sourceLine" id="cb49-12" data-line-number="12"><span class="st">-        zstream.avail_out = buf_size;</span></a>
<a class="sourceLine" id="cb49-13" data-line-number="13"><span class="va">+        zstream.avail_out = buf_size - 1;</span></a>
<a class="sourceLine" id="cb49-14" data-line-number="14">        ret = inflate(&amp;zstream, Z_PARTIAL_FLUSH);</a>
<a class="sourceLine" id="cb49-15" data-line-number="15">        if (ret != Z_OK &amp;&amp; ret != Z_STREAM_END) {</a></code></pre></div>
<p><a href="https://github.com/FFmpeg/FFmpeg/commit/e371f031b942d73e02c090170975561fabd5c264#diff-1205c376797026cb2296bd451f341c5eR422"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="dt">static</span> <span class="dt">int</span> decode_zbuf(AVBPrint *bp, <span class="dt">const</span> <span class="dt">uint8_t</span> *data,</a>
<a class="sourceLine" id="cb50-2" data-line-number="2">                        <span class="dt">const</span> <span class="dt">uint8_t</span> *data_end)</a>
<a class="sourceLine" id="cb50-3" data-line-number="3"> {</a>
<a class="sourceLine" id="cb50-4" data-line-number="4">     z_stream zstream;</a>
<a class="sourceLine" id="cb50-5" data-line-number="5">     <span class="dt">unsigned</span> <span class="dt">char</span> *buf;</a>
<a class="sourceLine" id="cb50-6" data-line-number="6">     <span class="dt">unsigned</span> buf_size;</a>
<a class="sourceLine" id="cb50-7" data-line-number="7">     <span class="dt">int</span> ret;</a>
<a class="sourceLine" id="cb50-8" data-line-number="8"> </a>
<a class="sourceLine" id="cb50-9" data-line-number="9">     zstream.zalloc = ff_png_zalloc;</a>
<a class="sourceLine" id="cb50-10" data-line-number="10">     zstream.zfree  = ff_png_zfree;</a>
<a class="sourceLine" id="cb50-11" data-line-number="11">     zstream.opaque = NULL;</a>
<a class="sourceLine" id="cb50-12" data-line-number="12">     <span class="cf">if</span> (inflateInit(&amp;zstream) != Z_OK)</a>
<a class="sourceLine" id="cb50-13" data-line-number="13">         <span class="cf">return</span> AVERROR_EXTERNAL;</a>
<a class="sourceLine" id="cb50-14" data-line-number="14">     zstream.next_in  = (<span class="dt">unsigned</span> <span class="dt">char</span> *)data;</a>
<a class="sourceLine" id="cb50-15" data-line-number="15">     zstream.avail_in = data_end - data;</a>
<a class="sourceLine" id="cb50-16" data-line-number="16">    av_bprint_init(bp, <span class="dv">0</span>, <span class="dv">-1</span>);</a>
<a class="sourceLine" id="cb50-17" data-line-number="17">     <span class="cf">while</span> (zstream.avail_in &gt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb50-18" data-line-number="18">        av_bprint_get_buffer(bp, <span class="dv">1</span>, &amp;buf, &amp;buf_size);</a>
<a class="sourceLine" id="cb50-19" data-line-number="19">        <span class="cf">if</span> (!buf_size) {</a>
<a class="sourceLine" id="cb50-20" data-line-number="20">        av_bprint_get_buffer(bp, <span class="dv">2</span>, &amp;buf, &amp;buf_size);</a>
<a class="sourceLine" id="cb50-21" data-line-number="21">        <span class="cf">if</span> (buf_size &lt; <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb50-22" data-line-number="22">            ret = AVERROR(ENOMEM);</a>
<a class="sourceLine" id="cb50-23" data-line-number="23">            <span class="cf">goto</span> fail;</a>
<a class="sourceLine" id="cb50-24" data-line-number="24">        }</a>
<a class="sourceLine" id="cb50-25" data-line-number="25">        zstream.next_out  = buf;</a>
<a class="sourceLine" id="cb50-26" data-line-number="26">        zstream.avail_out = buf_size;</a>
<a class="sourceLine" id="cb50-27" data-line-number="27">        zstream.avail_out = buf_size - <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb50-28" data-line-number="28">        ret = inflate(&amp;zstream, Z_PARTIAL_FLUSH);</a>
<a class="sourceLine" id="cb50-29" data-line-number="29">        <span class="cf">if</span> (ret != Z_OK &amp;&amp; ret != Z_STREAM_END) {</a>
<a class="sourceLine" id="cb50-30" data-line-number="30">            ret = AVERROR_EXTERNAL;</a>
<a class="sourceLine" id="cb50-31" data-line-number="31">             <span class="cf">goto</span> fail;</a>
<a class="sourceLine" id="cb50-32" data-line-number="32">         }</a>
<a class="sourceLine" id="cb50-33" data-line-number="33">         bp-&gt;len += zstream.next_out - buf;</a>
<a class="sourceLine" id="cb50-34" data-line-number="34">         <span class="cf">if</span> (ret == Z_STREAM_END)</a>
<a class="sourceLine" id="cb50-35" data-line-number="35">             <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb50-36" data-line-number="36">     }</a>
<a class="sourceLine" id="cb50-37" data-line-number="37">     inflateEnd(&amp;zstream);</a>
<a class="sourceLine" id="cb50-38" data-line-number="38">     bp-&gt;str[bp-&gt;len] = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb50-39" data-line-number="39">     <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb50-40" data-line-number="40"> </a>
<a class="sourceLine" id="cb50-41" data-line-number="41"> fail:</a>
<a class="sourceLine" id="cb50-42" data-line-number="42">     inflateEnd(&amp;zstream);</a>
<a class="sourceLine" id="cb50-43" data-line-number="43">     av_bprint_finalize(bp, NULL);</a>
<a class="sourceLine" id="cb50-44" data-line-number="44">     <span class="cf">return</span> ret;</a>
<a class="sourceLine" id="cb50-45" data-line-number="45"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="OpenCV"></p>
<h3 id="project-name-opencv">Project Name: <a href="https://github.com/opencv/opencv">OpenCV</a></h3>
<p><a name="Out of bounds write causes Segmentation Fault #9723"></p>
<h3 id="out-of-bounds-write-causes-segmentation-fault-9723">1. <a href="https://github.com/opencv/opencv/issues/9309">Out of bounds write causes Segmentation Fault #9723</a></h3>
<p><a href="https://github.com/opencv/opencv/issues/9723"><strong>Description</strong></a></p>
<p>In opencv/modules/imgcodecs/src/utils.cpp, functions FillUniColor and FillUniGray do not check the input length, which can lead to integer overflow. If the image is from remote, may lead to remote code execution or denial of service. This affects Opencv 3.3 and earlier.</p>
<p><a href="https://github.com/opencv/opencv/pull/9726/files"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="dt">@@ -375,6 +375,9 @@ decode_rle4_bad: ;</span></a>
<a class="sourceLine" id="cb51-2" data-line-number="2">                                                gray_palette[code] );</a>
<a class="sourceLine" id="cb51-3" data-line-number="3">                         line_end_flag = y - prev_y;</a>
<a class="sourceLine" id="cb51-4" data-line-number="4"><span class="va">+                         if( y &gt;= m_height )</span></a>
<a class="sourceLine" id="cb51-5" data-line-number="5"><span class="va">+                            break;</span></a>
<a class="sourceLine" id="cb51-6" data-line-number="6">                    }</a>
<a class="sourceLine" id="cb51-7" data-line-number="7">                    else if( code &gt; 2 ) // absolute mode</a>
<a class="sourceLine" id="cb51-8" data-line-number="8">                    {</a></code></pre></div>
<p><a href="https://github.com/opencv/opencv/pull/9726/files#diff-236c3294512b9353649b64ad8385e984R194"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/opencv/opencv/pull/9726/files#diff-236c3294512b9353649b64ad8385e984R194">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="A heap based buffer overflow happens in cv::Jpeg2KDecoder::readComponent8u #10541"></p>
<h3 id="a-heap-based-buffer-overflow-happens-in-cvjpeg2kdecoderreadcomponent8u-10541">1. <a href="https://github.com/opencv/opencv/issues/10541">A heap based buffer overflow happens in cv::Jpeg2KDecoder::readComponent8u #10541</a></h3>
<p><a href="https://github.com/opencv/opencv/issues/10541"><strong>Description</strong></a></p>
<p>In OpenCV 3.3.1, a heap-based buffer overflow happens in cv::Jpeg2KDecoder::readComponent8u in modules/imgcodecs/src/grfmt_jpeg2000.cpp when parsing a crafted image file.</p>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb52-1" data-line-number="1"><span class="dt">@@ -77,7 +77,8 @@ static JasperInitializer initialize_jasper;</span></a>
<a class="sourceLine" id="cb52-2" data-line-number="2"> Jpeg2KDecoder::Jpeg2KDecoder()</a>
<a class="sourceLine" id="cb52-3" data-line-number="3">{</a>
<a class="sourceLine" id="cb52-4" data-line-number="4"><span class="st">-    m_signature = &#39;\0&#39; + String() + &#39;\0&#39; + String() + &#39;\0&#39; + String(&quot;\x0cjP  \r\n\x87\n&quot;);</span></a>
<a class="sourceLine" id="cb52-5" data-line-number="5"><span class="va">+    static const unsigned char signature_[12] = { 0, 0, 0, 0x0c, &#39;j&#39;, &#39;P&#39;, &#39; &#39;, &#39; &#39;, 13, 10, 0x87, 10};</span></a>
<a class="sourceLine" id="cb52-6" data-line-number="6"><span class="va">+    m_signature = String((const char*)signature_, (const char*)signature_ + sizeof(signature_));</span></a>
<a class="sourceLine" id="cb52-7" data-line-number="7">    m_stream = 0;</a>
<a class="sourceLine" id="cb52-8" data-line-number="8">    m_image = 0;</a>
<a class="sourceLine" id="cb52-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb52-10" data-line-number="10"><span class="dt">@@ -121,6 +122,8 @@ bool  Jpeg2KDecoder::readHeader()</span></a>
<a class="sourceLine" id="cb52-11" data-line-number="11">        jas_image_t* image = jas_image_decode( stream, -1, 0 );</a>
<a class="sourceLine" id="cb52-12" data-line-number="12">        m_image = image;</a>
<a class="sourceLine" id="cb52-13" data-line-number="13">        if( image ) {</a>
<a class="sourceLine" id="cb52-14" data-line-number="14"><span class="va">+            CV_Assert(0 == (jas_image_tlx(image)) &amp;&amp; &quot;not supported&quot;);</span></a>
<a class="sourceLine" id="cb52-15" data-line-number="15"><span class="va">+            CV_Assert(0 == (jas_image_tly(image)) &amp;&amp; &quot;not supported&quot;);</span></a>
<a class="sourceLine" id="cb52-16" data-line-number="16">            m_width = jas_image_width( image );</a>
<a class="sourceLine" id="cb52-17" data-line-number="17">            m_height = jas_image_height( image );</a>
<a class="sourceLine" id="cb52-18" data-line-number="18"> @@ -130,14 +133,31 @@ bool  Jpeg2KDecoder::readHeader()</a>
<a class="sourceLine" id="cb52-19" data-line-number="19">            for( int i = 0; i &lt; numcmpts; i++ )</a>
<a class="sourceLine" id="cb52-20" data-line-number="20">            {</a>
<a class="sourceLine" id="cb52-21" data-line-number="21">                int depth_i = jas_image_cmptprec( image, i );</a>
<a class="sourceLine" id="cb52-22" data-line-number="22"><span class="va">+                CV_Assert(depth == 0 || depth == depth_i); // component data type mismatch</span></a>
<a class="sourceLine" id="cb52-23" data-line-number="23">                depth = MAX(depth, depth_i);</a>
<a class="sourceLine" id="cb52-24" data-line-number="24">                if( jas_image_cmpttype( image, i ) &gt; 2 )</a>
<a class="sourceLine" id="cb52-25" data-line-number="25">                    continue;</a>
<a class="sourceLine" id="cb52-26" data-line-number="26"><span class="va">+                int sgnd = jas_image_cmptsgnd(image, i);</span></a>
<a class="sourceLine" id="cb52-27" data-line-number="27"><span class="va">+                int xstart = jas_image_cmpttlx(image, i);</span></a>
<a class="sourceLine" id="cb52-28" data-line-number="28"><span class="va">+                int xend = jas_image_cmptbrx(image, i);</span></a>
<a class="sourceLine" id="cb52-29" data-line-number="29"><span class="va">+                int xstep = jas_image_cmpthstep(image, i);</span></a>
<a class="sourceLine" id="cb52-30" data-line-number="30"><span class="va">+                int ystart = jas_image_cmpttly(image, i);</span></a>
<a class="sourceLine" id="cb52-31" data-line-number="31"><span class="va">+                int yend = jas_image_cmptbry(image, i);</span></a>
<a class="sourceLine" id="cb52-32" data-line-number="32"><span class="va">+                int ystep = jas_image_cmptvstep(image, i);</span></a>
<a class="sourceLine" id="cb52-33" data-line-number="33"><span class="va">+                CV_Assert(sgnd == 0 &amp;&amp; &quot;not supported&quot;);</span></a>
<a class="sourceLine" id="cb52-34" data-line-number="34"><span class="va">+                CV_Assert(xstart == 0 &amp;&amp; &quot;not supported&quot;);</span></a>
<a class="sourceLine" id="cb52-35" data-line-number="35"><span class="va">+                CV_Assert(ystart == 0 &amp;&amp; &quot;not supported&quot;);</span></a>
<a class="sourceLine" id="cb52-36" data-line-number="36"><span class="va">+                CV_Assert(xstep == 1 &amp;&amp; &quot;not supported&quot;);</span></a>
<a class="sourceLine" id="cb52-37" data-line-number="37"><span class="va">+                CV_Assert(ystep == 1 &amp;&amp; &quot;not supported&quot;);</span></a>
<a class="sourceLine" id="cb52-38" data-line-number="38"><span class="va">+                CV_Assert(xend == m_width);</span></a>
<a class="sourceLine" id="cb52-39" data-line-number="39"><span class="va">+                CV_Assert(yend == m_height);</span></a>
<a class="sourceLine" id="cb52-40" data-line-number="40">                cntcmpts++;</a>
<a class="sourceLine" id="cb52-41" data-line-number="41">            }</a>
<a class="sourceLine" id="cb52-42" data-line-number="42">             if( cntcmpts )</a>
<a class="sourceLine" id="cb52-43" data-line-number="43">            {</a>
<a class="sourceLine" id="cb52-44" data-line-number="44"><span class="va">+                CV_Assert(depth == 8 || depth == 16);</span></a>
<a class="sourceLine" id="cb52-45" data-line-number="45"><span class="va">+                CV_Assert(cntcmpts == 1 || cntcmpts == 3);</span></a>
<a class="sourceLine" id="cb52-46" data-line-number="46">                m_type = CV_MAKETYPE(depth &lt;= 8 ? CV_8U : CV_16U, cntcmpts &gt; 1 ? 3 : 1);</a>
<a class="sourceLine" id="cb52-47" data-line-number="47">                result = true;</a>
<a class="sourceLine" id="cb52-48" data-line-number="48">            }</a>
<a class="sourceLine" id="cb52-49" data-line-number="49"><span class="dt">@@ -150,9 +170,14 @@ bool  Jpeg2KDecoder::readHeader()</span></a>
<a class="sourceLine" id="cb52-50" data-line-number="50">    return result;</a>
<a class="sourceLine" id="cb52-51" data-line-number="51">}</a>
<a class="sourceLine" id="cb52-52" data-line-number="52"><span class="va">+ static void Jpeg2KDecoder_close(Jpeg2KDecoder* ptr)</span></a>
<a class="sourceLine" id="cb52-53" data-line-number="53"><span class="va">+ {</span></a>
<a class="sourceLine" id="cb52-54" data-line-number="54"><span class="va">+    ptr-&gt;close();</span></a>
<a class="sourceLine" id="cb52-55" data-line-number="55"><span class="va">+ }</span></a>
<a class="sourceLine" id="cb52-56" data-line-number="56"> bool  Jpeg2KDecoder::readData( Mat&amp; img )</a>
<a class="sourceLine" id="cb52-57" data-line-number="57">{</a>
<a class="sourceLine" id="cb52-58" data-line-number="58"><span class="va">+    Ptr&lt;Jpeg2KDecoder&gt; close_this(this, Jpeg2KDecoder_close);</span></a>
<a class="sourceLine" id="cb52-59" data-line-number="59">    bool result = false;</a>
<a class="sourceLine" id="cb52-60" data-line-number="60">    int color = img.channels() &gt; 1;</a>
<a class="sourceLine" id="cb52-61" data-line-number="61">    uchar* data = img.ptr();</a>
<a class="sourceLine" id="cb52-62" data-line-number="62"><span class="dt">@@ -204,11 +229,16 @@ bool  Jpeg2KDecoder::readData( Mat&amp; img )</span></a>
<a class="sourceLine" id="cb52-63" data-line-number="63">                    result = true;</a>
<a class="sourceLine" id="cb52-64" data-line-number="64">                }</a>
<a class="sourceLine" id="cb52-65" data-line-number="65">                else</a>
<a class="sourceLine" id="cb52-66" data-line-number="66"><span class="st">-                    fprintf(stderr, &quot;JPEG 2000 LOADER ERROR: cannot convert colorspace\n&quot;);</span></a>
<a class="sourceLine" id="cb52-67" data-line-number="67"><span class="va">+                {</span></a>
<a class="sourceLine" id="cb52-68" data-line-number="68"><span class="va">+                     jas_cmprof_destroy(clrprof);</span></a>
<a class="sourceLine" id="cb52-69" data-line-number="69"><span class="va">+                     CV_Error(Error::StsError, &quot;JPEG 2000 LOADER ERROR: cannot convert colorspace&quot;);</span></a>
<a class="sourceLine" id="cb52-70" data-line-number="70"><span class="va">+                }</span></a>
<a class="sourceLine" id="cb52-71" data-line-number="71">                jas_cmprof_destroy( clrprof );</a>
<a class="sourceLine" id="cb52-72" data-line-number="72">            }</a>
<a class="sourceLine" id="cb52-73" data-line-number="73">            else</a>
<a class="sourceLine" id="cb52-74" data-line-number="74"><span class="st">-                fprintf(stderr, &quot;JPEG 2000 LOADER ERROR: unable to create colorspace\n&quot;);</span></a>
<a class="sourceLine" id="cb52-75" data-line-number="75"><span class="va">+            {</span></a>
<a class="sourceLine" id="cb52-76" data-line-number="76"><span class="va">+                CV_Error(Error::StsError, &quot;JPEG 2000 LOADER ERROR: unable to create colorspace&quot;);</span></a>
<a class="sourceLine" id="cb52-77" data-line-number="77"><span class="va">+            }</span></a>
<a class="sourceLine" id="cb52-78" data-line-number="78">        }</a>
<a class="sourceLine" id="cb52-79" data-line-number="79">        else</a>
<a class="sourceLine" id="cb52-80" data-line-number="80">            result = true;</a>
<a class="sourceLine" id="cb52-81" data-line-number="81"><span class="dt">@@ -257,8 +287,8 @@ bool  Jpeg2KDecoder::readData( Mat&amp; img )</span></a>
<a class="sourceLine" id="cb52-82" data-line-number="82">                                result = readComponent16u( ((unsigned short *)data) + i, buffer, validateToInt(step / 2), cmptlut[i], maxval, offset, ncmpts );</a>
<a class="sourceLine" id="cb52-83" data-line-number="83">                            if( !result )</a>
<a class="sourceLine" id="cb52-84" data-line-number="84">                            {</a>
<a class="sourceLine" id="cb52-85" data-line-number="85"><span class="st">-                                i = ncmpts;</span></a>
<a class="sourceLine" id="cb52-86" data-line-number="86"><span class="st">-                                result = false;</span></a>
<a class="sourceLine" id="cb52-87" data-line-number="87"><span class="va">+                                jas_matrix_destroy( buffer );</span></a>
<a class="sourceLine" id="cb52-88" data-line-number="88"><span class="va">+                                CV_Error(Error::StsError, &quot;JPEG2000 LOADER ERROR: failed to read component&quot;);</span></a>
<a class="sourceLine" id="cb52-89" data-line-number="89">                            }</a>
<a class="sourceLine" id="cb52-90" data-line-number="90">                        }</a>
<a class="sourceLine" id="cb52-91" data-line-number="91">                        jas_matrix_destroy( buffer );</a>
<a class="sourceLine" id="cb52-92" data-line-number="92"><span class="dt">@@ -267,10 +297,12 @@ bool  Jpeg2KDecoder::readData( Mat&amp; img )</span></a>
<a class="sourceLine" id="cb52-93" data-line-number="93">            }</a>
<a class="sourceLine" id="cb52-94" data-line-number="94">        }</a>
<a class="sourceLine" id="cb52-95" data-line-number="95">        else</a>
<a class="sourceLine" id="cb52-96" data-line-number="96"><span class="st">-            fprintf(stderr, &quot;JPEG2000 LOADER ERROR: colorspace conversion failed\n&quot; );</span></a>
<a class="sourceLine" id="cb52-97" data-line-number="97"><span class="va">+        {</span></a>
<a class="sourceLine" id="cb52-98" data-line-number="98"><span class="va">+            CV_Error(Error::StsError, &quot;JPEG2000 LOADER ERROR: colorspace conversion failed&quot;);</span></a>
<a class="sourceLine" id="cb52-99" data-line-number="99"><span class="va">+        }</span></a>
<a class="sourceLine" id="cb52-100" data-line-number="100">    }</a>
<a class="sourceLine" id="cb52-101" data-line-number="101"><span class="st">-     close();</span></a>
<a class="sourceLine" id="cb52-102" data-line-number="102"><span class="va">+    CV_Assert(result == true);</span></a>
<a class="sourceLine" id="cb52-103" data-line-number="103"> #ifndef _WIN32</a>
<a class="sourceLine" id="cb52-104" data-line-number="104">    if (!clr.empty())</a></code></pre></div>
<p><a href=""><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c"><code class="sourceCode c"></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="json-c"></p>
<h3 id="project-name-json-c">Project Name: <a href="https://github.com/json-c/json-c">json-c</a></h3>
<p><a name="Empty strings and unicode zero values break json parsing. #53"></p>
<h3 id="empty-strings-and-unicode-zero-values-break-json-parsing.-53">1. <a href="https://github.com/json-c/json-c/issues/53">Empty strings and unicode zero values break json parsing. #53</a></h3>
<p><a href="https://github.com/json-c/json-c/issues/53"><strong>Description</strong></a></p>
<p>Package: libjson0 Version: 0.10-1.1 Severity: important</p>
<p>If the input JSON contains empty value (i.e. &quot;&quot;) The internal string buffer is unterminated and unexpected behaviour occours.</p>
If the unicode value
</body>
</html>
