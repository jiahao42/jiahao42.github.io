<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Bug reports</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../style.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Bug reports</h1>
</header>
<ul>
<li><a href="#cJSON">cJSON</a>
<ul>
<li><a href="#Bug%20in%20cJSON.c%20cJSON_SetNumberHelper%20#138">Bug in cJSON.c cJSON_SetNumberHelper #138</a></li>
<li><a href="#Bug%20in%20cJSON_AddItemToObject%20#106">Bug in cJSON_AddItemToObject #106</a></li>
<li><a href="#Invalid%20pointer%20returned%20if%20reallocate%20fails%20in%20ensure%20function%20#189">Invalid pointer returned if reallocate fails in ensure function #189</a></li>
<li><a href="#String%20deallocated%20before%20use%20#248">String deallocated before use #248</a></li>
</ul></li>
<li><a href="#iniparser">iniparser</a>
<ul>
<li>ini file parser</li>
<li><a href="#Empty%20string%20with%20quotes.%20#70">Empty string with quotes. #70</a></li>
</ul></li>
<li><a href="#http-parser">http-parser</a>
<ul>
<li><a href="#Heap%20out-of-bounds%20read%20in%20strtoul%20(68345541)">Heap out-of-bounds read in strtoul (68345541)</a></li>
</ul></li>
<li><a href="#myhtml">myhtml</a>
<ul>
<li>Fast C/C++ HTML 5 Parser. Using threads.</li>
<li><a href="#fix%20charef%20parsing%20#152">fix charef parsing #152</a></li>
</ul></li>
<li><a href="#json-parser">json-parser</a>
<ul>
<li><a href="#heap%20buffer%20overflow%20on%20some%20inputs%20#68">heap buffer overflow on some inputs #68</a></li>
</ul></li>
<li><a href="#mongoose">mongoose</a>
<ul>
<li>Mongoose Embedded Web Server Library - Mongoose is more than an embedded webserver. It is a multi-protocol embedded networking library with functions including TCP, HTTP client and server, WebSocket client and server, MQTT client and broker and much more.</li>
<li><a href="#websocket%20client%20bug%20#631">websocket client bug #631</a></li>
</ul></li>
<li><a href="#Firefox">Firefox</a>
<ul>
<li><a href="#CVE-2018-5176">Iframe injection &amp; content spoofing &amp; scripts execution via json viewer</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5176">CVE-2018-5176</a></li>
</ul></li>
</ul></li>
<li><a href="#poco">poco</a>
<ul>
<li>The POCO C++ Libraries are powerful cross-platform C++ libraries for building network- and internet-based applications that run on desktop, server, mobile, IoT, and embedded systems.</li>
<li><a href="#Zip%20Decompress%20Parent%20Path%20Injection%20#1968">Zip Decompress Parent Path Injection #1968</a></li>
</ul></li>
<li><a href="#CImg">CImg</a>
<ul>
<li>The CImg Library is a small and open-source C++ toolkit for image processing.</li>
<li><a href="#other%20testcases%20lead%20to%20heap%20overflow%20by%20loading%20crafted%20images%20#185">other testcases lead to heap overflow by loading crafted images #185</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-7640">CVE-2018-7640</a></li>
</ul></li>
</ul></li>
<li><a href="#ImageMagick">ImageMagick</a>
<ul>
<li>ImageMagick is a free and open-source software suite for displaying, converting, and editing raster image and vector image files.</li>
<li><a href="#heap-buffer-overflow%20in%20SVGStripString%20of%20svg.c%20#1336">heap-buffer-overflow in SVGStripString of svg.c #1336</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-18023">CVE-2018-18023</a></li>
</ul></li>
<li><a href="#heap-buffer-overflow%20in%20EncodeImage%20of%20pict.c%20#1335">heap-buffer-overflow in EncodeImage of pict.c #1335</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-18025">CVE-2018-18025</a></li>
</ul></li>
<li><a href="#heap-buffer-overflow%20in%20MagickCore%20#1156">heap-buffer-overflow in MagickCore #1156</a>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11625">CVE-2018-11625</a></li>
</ul></li>
</ul></li>
</ul>
<p><a name="cJSON"></p>
<h3 id="project-name-cjson">Project Name: <a href="https://github.com/DaveGamble/cJSON">cJSON</a></h3>
<p><a name="Bug in cJSON.c cJSON_SetNumberHelper #138"></p>
<h3 id="bug-in-cjson.c-cjson_setnumberhelper-138">1. <a href="https://github.com/DaveGamble/cJSON/issues/138">Bug in cJSON.c cJSON_SetNumberHelper #138</a></h3>
<p><a href="https://github.com/DaveGamble/cJSON/issues/138"><strong>Description</strong></a></p>
<blockquote>
<p>cJSON.c line 231 : object-&gt;valueint = cJSON_Number;</p>
<p>may be it is type?</p>
<p>object-&gt;type = cJSON_Number; object-&gt;valueint = number;</p>
</blockquote>
<p><a href="https://github.com/DaveGamble/cJSON/commit/ef34500693e8c4a2849d41a4bd66fd19c9ec46c2"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb1-1" data-line-number="1">    {</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="st">-        object-&gt;valueint = cJSON_Number;</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="va">+        object-&gt;valueint = (int)number;</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    }</a></code></pre></div>
<p><a href="https://github.com/DaveGamble/cJSON/commit/ef34500693e8c4a2849d41a4bd66fd19c9ec46c2"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb2-1" data-line-number="1"> <span class="co">/* don&#39;t ask me, but the original cJSON_SetNumberValue returns an integer or double */</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"> CJSON_PUBLIC(<span class="dt">double</span>) cJSON_SetNumberHelper(cJSON *object, <span class="dt">double</span> number)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"> {</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">     <span class="cf">if</span> (number &gt;= INT_MAX)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">     {</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">         object-&gt;valueint = INT_MAX;</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">     }</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">     <span class="cf">else</span> <span class="cf">if</span> (number &lt;= INT_MIN)</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">     {</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">         object-&gt;valueint = INT_MIN;</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">    }</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    {</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">        object-&gt;valueint = (<span class="dt">int</span>)number;</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">    }</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">     <span class="cf">return</span> object-&gt;valuedouble = number;</a>
<a class="sourceLine" id="cb2-17" data-line-number="17"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<p>Should be able to discovered by comparing to the output of other JSON parser</p>
<hr />
<p><a name="Bug in cJSON_AddItemToObject #106"></p>
<h3 id="bug-in-cjson_additemtoobject-106">2. <a href="https://github.com/DaveGamble/cJSON/issues/106">Bug in cJSON_AddItemToObject #106</a></h3>
<p><a href="https://github.com/DaveGamble/cJSON/issues/106"><strong>Description</strong></a></p>
<blockquote>
<p>In cJSON_AddItemToObject,</p>
<p>/* free old key and set new one */ if (item-&gt;string) { cJSON_free(item-&gt;string); }</p>
<p>Shouldn’t this be:</p>
<p>if (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; item-&gt;string) { cJSON_free(item-&gt;string); }</p>
<p>Thanks! Diego.</p>
</blockquote>
<p><a href="https://github.com/DaveGamble/cJSON/commit/702fd95af3408b157167bfd30728c66a212aeae7"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb3-1" data-line-number="1">    /* free old key and set new one */</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="st">-    if (item-&gt;string)</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="va">+    if (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; item-&gt;string)</span></a></code></pre></div>
<p><a href="https://github.com/DaveGamble/cJSON/commit/702fd95af3408b157167bfd30728c66a212aeae7"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" data-line-number="1"> <span class="dt">void</span>   cJSON_AddItemToObject(cJSON *object, <span class="dt">const</span> <span class="dt">char</span> *string, cJSON *item)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"> {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">     <span class="cf">if</span> (!item)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">     {</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">         <span class="cf">return</span>;</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    }</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">     <span class="co">/* free old key and set new one */</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    <span class="cf">if</span> (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; item-&gt;string)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">    {</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">        cJSON_free(item-&gt;string);</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">    }</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">     item-&gt;string = (<span class="dt">char</span>*)cJSON_strdup((<span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span>*)string);</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"> </a>
<a class="sourceLine" id="cb4-14" data-line-number="14">     cJSON_AddItemToArray(object,item);</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<p>Should be able to discovered given certain input</p>
<hr />
<p><a name="Invalid pointer returned if reallocate fails in ensure function #189"></p>
<h3 id="invalid-pointer-returned-if-reallocate-fails-in-ensure-function-189">3. <a href="https://github.com/DaveGamble/cJSON/issues/189">Invalid pointer returned if reallocate fails in ensure function #189</a></h3>
<p><a href="https://github.com/DaveGamble/cJSON/issues/189"><strong>Description</strong></a></p>
<blockquote>
<p>Q: The calls to reallocate is assumed to return a valid pointer. If it fails, NULL should be returned instead of newbuffer + p-&gt;offset.</p>
</blockquote>
<blockquote>
<p>A: This is definitely a bug and most likely also a security issue, since an attacker could make realloc fail at exactly the right moment while also providing a big JSON (big offset), thereby potentially producing a pointer to an arbitrary memory address that will be written to by cJSON later on.</p>
</blockquote>
<p><a href="https://github.com/DaveGamble/cJSON/commit/954d61e5e7cb9dc6c480fc28ac1cdceca07dd5bd"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="va">+        if (newbuffer == NULL)</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="va">+        {</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="va">+            p-&gt;hooks.deallocate(p-&gt;buffer);</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="va">+            p-&gt;length = 0;</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="va">+            p-&gt;buffer = NULL;</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="va">+             return NULL;</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="va">+        }</span></a></code></pre></div>
<p><a href="https://github.com/DaveGamble/cJSON/commit/954d61e5e7cb9dc6c480fc28ac1cdceca07dd5bd"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" data-line-number="1"> <span class="co">/* realloc printbuffer if necessary to have at least &quot;needed&quot; bytes more */</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"> <span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">char</span>* ensure(printbuffer * <span class="dt">const</span> p, <span class="dt">size_t</span> needed)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"> {</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">     <span class="dt">unsigned</span> <span class="dt">char</span> *newbuffer = NULL;</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">     <span class="dt">size_t</span> newsize = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb6-7" data-line-number="7">     <span class="cf">if</span> ((p == NULL) || (p-&gt;buffer == NULL))</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">     {</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">         <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">     }</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"> </a>
<a class="sourceLine" id="cb6-12" data-line-number="12">     <span class="cf">if</span> ((p-&gt;length &gt; <span class="dv">0</span>) &amp;&amp; (p-&gt;offset &gt;= p-&gt;length))</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">     {</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">         <span class="co">/* make sure that offset is valid */</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">         <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">     }</a>
<a class="sourceLine" id="cb6-17" data-line-number="17"> </a>
<a class="sourceLine" id="cb6-18" data-line-number="18">     <span class="cf">if</span> (needed &gt; INT_MAX)</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">     {</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">         <span class="co">/* sizes bigger than INT_MAX are currently not supported */</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21">         <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">     }</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"> </a>
<a class="sourceLine" id="cb6-24" data-line-number="24">     needed += p-&gt;offset + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">     <span class="cf">if</span> (needed &lt;= p-&gt;length)</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">     {</a>
<a class="sourceLine" id="cb6-27" data-line-number="27">         <span class="cf">return</span> p-&gt;buffer + p-&gt;offset;</a>
<a class="sourceLine" id="cb6-28" data-line-number="28">     }</a>
<a class="sourceLine" id="cb6-29" data-line-number="29"> </a>
<a class="sourceLine" id="cb6-30" data-line-number="30">     <span class="cf">if</span> (p-&gt;noalloc) {</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">         <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-32" data-line-number="32">     }</a>
<a class="sourceLine" id="cb6-33" data-line-number="33"> </a>
<a class="sourceLine" id="cb6-34" data-line-number="34">     <span class="co">/* calculate new buffer size */</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35">     <span class="cf">if</span> (needed &gt; (INT_MAX / <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb6-36" data-line-number="36">     {</a>
<a class="sourceLine" id="cb6-37" data-line-number="37">         <span class="co">/* overflow of int, use INT_MAX if possible */</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38">         <span class="cf">if</span> (needed &lt;= INT_MAX)</a>
<a class="sourceLine" id="cb6-39" data-line-number="39">         {</a>
<a class="sourceLine" id="cb6-40" data-line-number="40">             newsize = INT_MAX;</a>
<a class="sourceLine" id="cb6-41" data-line-number="41">         }</a>
<a class="sourceLine" id="cb6-42" data-line-number="42">         <span class="cf">else</span></a>
<a class="sourceLine" id="cb6-43" data-line-number="43">         {</a>
<a class="sourceLine" id="cb6-44" data-line-number="44">             <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-45" data-line-number="45">         }</a>
<a class="sourceLine" id="cb6-46" data-line-number="46">     }</a>
<a class="sourceLine" id="cb6-47" data-line-number="47">     <span class="cf">else</span></a>
<a class="sourceLine" id="cb6-48" data-line-number="48">     {</a>
<a class="sourceLine" id="cb6-49" data-line-number="49">         newsize = needed * <span class="dv">2</span>;</a>
<a class="sourceLine" id="cb6-50" data-line-number="50">     }</a>
<a class="sourceLine" id="cb6-51" data-line-number="51"> </a>
<a class="sourceLine" id="cb6-52" data-line-number="52">     <span class="cf">if</span> (p-&gt;hooks.reallocate != NULL)</a>
<a class="sourceLine" id="cb6-53" data-line-number="53">    {</a>
<a class="sourceLine" id="cb6-54" data-line-number="54">        <span class="co">/* reallocate with realloc if available */</span></a>
<a class="sourceLine" id="cb6-55" data-line-number="55">        newbuffer = (<span class="dt">unsigned</span> <span class="dt">char</span>*)p-&gt;hooks.reallocate(p-&gt;buffer, newsize);</a>
<a class="sourceLine" id="cb6-56" data-line-number="56">        <span class="cf">if</span> (newbuffer == NULL)</a>
<a class="sourceLine" id="cb6-57" data-line-number="57">        {</a>
<a class="sourceLine" id="cb6-58" data-line-number="58">            p-&gt;hooks.deallocate(p-&gt;buffer);</a>
<a class="sourceLine" id="cb6-59" data-line-number="59">            p-&gt;length = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb6-60" data-line-number="60">            p-&gt;buffer = NULL;</a>
<a class="sourceLine" id="cb6-61" data-line-number="61">             <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-62" data-line-number="62">        }</a>
<a class="sourceLine" id="cb6-63" data-line-number="63">    }</a>
<a class="sourceLine" id="cb6-64" data-line-number="64">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb6-65" data-line-number="65">    {</a>
<a class="sourceLine" id="cb6-66" data-line-number="66">         <span class="co">/* otherwise reallocate manually */</span></a>
<a class="sourceLine" id="cb6-67" data-line-number="67">         newbuffer = (<span class="dt">unsigned</span> <span class="dt">char</span>*)p-&gt;hooks.allocate(newsize);</a>
<a class="sourceLine" id="cb6-68" data-line-number="68">         <span class="cf">if</span> (!newbuffer)</a>
<a class="sourceLine" id="cb6-69" data-line-number="69">         {</a>
<a class="sourceLine" id="cb6-70" data-line-number="70">             p-&gt;hooks.deallocate(p-&gt;buffer);</a>
<a class="sourceLine" id="cb6-71" data-line-number="71">             p-&gt;length = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb6-72" data-line-number="72">             p-&gt;buffer = NULL;</a>
<a class="sourceLine" id="cb6-73" data-line-number="73"> </a>
<a class="sourceLine" id="cb6-74" data-line-number="74">             <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb6-75" data-line-number="75">         }</a>
<a class="sourceLine" id="cb6-76" data-line-number="76">         <span class="cf">if</span> (newbuffer)</a>
<a class="sourceLine" id="cb6-77" data-line-number="77">         {</a>
<a class="sourceLine" id="cb6-78" data-line-number="78">             memcpy(newbuffer, p-&gt;buffer, p-&gt;offset + <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb6-79" data-line-number="79">         }</a>
<a class="sourceLine" id="cb6-80" data-line-number="80">         p-&gt;hooks.deallocate(p-&gt;buffer);</a>
<a class="sourceLine" id="cb6-81" data-line-number="81">     }</a>
<a class="sourceLine" id="cb6-82" data-line-number="82">     p-&gt;length = newsize;</a>
<a class="sourceLine" id="cb6-83" data-line-number="83">     p-&gt;buffer = newbuffer;</a>
<a class="sourceLine" id="cb6-84" data-line-number="84"> </a>
<a class="sourceLine" id="cb6-85" data-line-number="85">     <span class="cf">return</span> newbuffer + p-&gt;offset;</a>
<a class="sourceLine" id="cb6-86" data-line-number="86"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<p>This is a security issue.</p>
<hr />
<p><a name="String deallocated before use #248"></p>
<h3 id="string-deallocated-before-use-248">4. <a href="https://github.com/DaveGamble/cJSON/issues/248">String deallocated before use #248</a></h3>
<p><a href="https://github.com/DaveGamble/cJSON/issues/248"><strong>Description:</strong></a></p>
<blockquote>
<p>add_item_to_object: Fix use-after-free when string is aliased</p>
<p>If the <code>string</code> property of the item that is added is an alias to the <code>string</code> parameter of <code>add_item_to_object</code>, and <code>constant</code> is false, <code>cJSON_strdup</code> would access the string after it has been freed.</p>
</blockquote>
<p><a href="https://github.com/FSMaxB/cJSON/commit/22a7d04fa004462e0dca35c3cc7809bea38e65f9"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb7-1" data-line-number="1">static cJSON_bool add_item_to_object(cJSON * const object, const char * const string, cJSON * const item, const internal_hooks * const hooks, const cJSON_bool constant_key)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="va">+    char *new_key = NULL;</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="va">+    int new_type = cJSON_Invalid;</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">     if ((object == NULL) || (string == NULL) || (item == NULL))</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    {</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">        return false;</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">    }</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="st">-     if (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; (item-&gt;string != NULL))</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="st">-    {</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="st">-        hooks-&gt;deallocate(item-&gt;string);</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="st">-    }</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">     if (constant_key)</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">    {</a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="st">-        item-&gt;string = (char*)cast_away_const(string);</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="st">-        item-&gt;type |= cJSON_StringIsConst;</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="va">+        new_key = (char*)cast_away_const(string);</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="va">+        new_type = item-&gt;type | cJSON_StringIsConst;</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">    }</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">    else</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">    {</a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="st">-        char *key = (char*)cJSON_strdup((const unsigned char*)string, hooks);</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="st">-        if (key == NULL)</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="va">+        new_key = (char*)cJSON_strdup((const unsigned char*)string, hooks);</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25"><span class="va">+        if (new_key == NULL)</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">        {</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">            return false;</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">        }</a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="st">-         item-&gt;string = key;</span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30"><span class="st">-        item-&gt;type &amp;= ~cJSON_StringIsConst;</span></a>
<a class="sourceLine" id="cb7-31" data-line-number="31"><span class="va">+        new_type = item-&gt;type &amp; ~cJSON_StringIsConst;</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32">    }</a>
<a class="sourceLine" id="cb7-33" data-line-number="33"><span class="va">+     if (!(item-&gt;type &amp; cJSON_StringIsConst) &amp;&amp; (item-&gt;string != NULL))</span></a>
<a class="sourceLine" id="cb7-34" data-line-number="34"><span class="va">+    {</span></a>
<a class="sourceLine" id="cb7-35" data-line-number="35"><span class="va">+        hooks-&gt;deallocate(item-&gt;string);</span></a>
<a class="sourceLine" id="cb7-36" data-line-number="36"><span class="va">+    }</span></a>
<a class="sourceLine" id="cb7-37" data-line-number="37"><span class="va">+     item-&gt;string = new_key;</span></a>
<a class="sourceLine" id="cb7-38" data-line-number="38"><span class="va">+    item-&gt;type = new_type;</span></a>
<a class="sourceLine" id="cb7-39" data-line-number="39">     return add_item_to_array(object, item);</a>
<a class="sourceLine" id="cb7-40" data-line-number="40">}</a></code></pre></div>
<p><a href="https://github.com/FSMaxB/cJSON/commit/22a7d04fa004462e0dca35c3cc7809bea38e65f9"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">// The same as above</span></a></code></pre></div>
<p><strong>Comments</strong>:</p>
<p>This is a security issue</p>
<hr />
<p><a name="iniparser"></p>
<h3 id="project-name-iniparser">Project Name: <a href="https://github.com/ndevilla/iniparser/">iniparser</a></h3>
<p><a name="Empty string with quotes. #70"></p>
<h3 id="empty-string-with-quotes.-70">1. <a href="https://github.com/ndevilla/iniparser/issues/70">Empty string with quotes. #70</a></h3>
<p><a href="https://github.com/ndevilla/iniparser/issues/70"><strong>Description:</strong></a></p>
<blockquote>
<p>for example: <code>filter = &quot;&quot;</code></p>
</blockquote>
<blockquote>
<p>this code can’t handle it</p>
</blockquote>
<pre><code>} else if (sscanf (line, &quot;%[^=] = \&quot;%[^\&quot;]\&quot;&quot;, key, value) == 2
       ||  sscanf (line, &quot;%[^=] = &#39;%[^\&#39;]&#39;&quot;,   key, value) == 2) {</code></pre>
<blockquote>
<p>this string will be processed in</p>
</blockquote>
<pre><code>} else if (sscanf (line, &quot;%[^=] = %[^;#]&quot;, key, value) == 2) {</code></pre>
<blockquote>
<p>the condition</p>
</blockquote>
<pre><code>if (!strcmp(value, &quot;\&quot;\&quot;&quot;) || (!strcmp(value, &quot;&#39;&#39;&quot;))) {
        value[0]=0 ;
}</code></pre>
<blockquote>
<p>will not be processed.</p>
</blockquote>
<blockquote>
<p>result: load = &quot;&quot; save = &quot;&quot;&quot;&quot; load = &quot;&quot;&quot;&quot; save = &quot;&quot;&quot;&quot;&quot;&quot; etc.</p>
</blockquote>
<p><a href="https://github.com/ndevilla/iniparser/commit/54716a77d621373ad3428170af6dacf9f106c264"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="va">+         sta = LINE_VALUE ;</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="va">+     } else if (sscanf (line, &quot;%[^=] = %[^;#]&quot;, key, value) == 2) {</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="va">+         /* Usual key=value without quotes, with or + without comments */</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="va">+         strstrip(key);</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="va">+         strlwc(key, key, len);</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="va">+         strstrip(value);</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">        /*</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">         * sscanf cannot handle &#39;&#39; or &quot;&quot; as empty values</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">         * this is done here</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">         */</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">        if (!strcmp(value, &quot;\&quot;\&quot;&quot;) || (!strcmp(value, &quot;&#39;&#39;&quot;))) {</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">            value[0]=0 ;</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">        }</a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="st">-        sta = LINE_VALUE ;</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="st">-    } else if (sscanf (line, &quot;%[^=] = %[^;#]&quot;, key, value) == 2) {</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="st">-        /* Usual key=value without quotes, with or without comments */</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="st">-        strstrip(key);</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="st">-        strlwc(key, key, len);</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="st">-        strstrip(value);</span></a></code></pre></div>
<p><a href="https://github.com/ndevilla/iniparser/commit/54716a77d621373ad3428170af6dacf9f106c264"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb13-1" data-line-number="1"> <span class="co">/*-------------------------------------------------------------------------*/</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"> <span class="co">/**</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">   </span><span class="an">@brief</span><span class="co">    Load a single line from an INI file</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">   </span><span class="an">@param</span><span class="co">    </span><span class="cv">input_line</span><span class="co">  Input line, may be concatenated multi-line input</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">   </span><span class="an">@param</span><span class="co">    </span><span class="cv">section</span><span class="co">     Output space to store section</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">   </span><span class="an">@param</span><span class="co">    </span><span class="cv">key</span><span class="co">         Output space to store key</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">   </span><span class="an">@param</span><span class="co">    </span><span class="cv">value</span><span class="co">       Output space to store value</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">   </span><span class="an">@return</span><span class="co">   line_status value</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">  */</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"> <span class="co">/*--------------------------------------------------------------------------*/</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"> <span class="dt">static</span> line_status iniparser_line(</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">     <span class="dt">const</span> <span class="dt">char</span> * input_line,</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">     <span class="dt">char</span> * section,</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">     <span class="dt">char</span> * key,</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">     <span class="dt">char</span> * value)</a>
<a class="sourceLine" id="cb13-16" data-line-number="16"> {</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">     line_status sta ;</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">     <span class="dt">char</span> * line = NULL;</a>
<a class="sourceLine" id="cb13-19" data-line-number="19">     <span class="dt">size_t</span>      len ;</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"> </a>
<a class="sourceLine" id="cb13-21" data-line-number="21">     line = xstrdup(input_line);</a>
<a class="sourceLine" id="cb13-22" data-line-number="22">     len = strstrip(line);</a>
<a class="sourceLine" id="cb13-23" data-line-number="23"> </a>
<a class="sourceLine" id="cb13-24" data-line-number="24">     sta = LINE_UNPROCESSED ;</a>
<a class="sourceLine" id="cb13-25" data-line-number="25">     <span class="cf">if</span> (len&lt;<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb13-26" data-line-number="26">         <span class="co">/* Empty line */</span></a>
<a class="sourceLine" id="cb13-27" data-line-number="27">         sta = LINE_EMPTY ;</a>
<a class="sourceLine" id="cb13-28" data-line-number="28">     } <span class="cf">else</span> <span class="cf">if</span> (line[<span class="dv">0</span>]==<span class="ch">&#39;#&#39;</span> || line[<span class="dv">0</span>]==<span class="ch">&#39;;&#39;</span>) {</a>
<a class="sourceLine" id="cb13-29" data-line-number="29">         <span class="co">/* Comment line */</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30">         sta = LINE_COMMENT ;</a>
<a class="sourceLine" id="cb13-31" data-line-number="31">     } <span class="cf">else</span> <span class="cf">if</span> (line[<span class="dv">0</span>]==<span class="ch">&#39;[&#39;</span> &amp;&amp; line[len<span class="dv">-1</span>]==<span class="ch">&#39;]&#39;</span>) {</a>
<a class="sourceLine" id="cb13-32" data-line-number="32">         <span class="co">/* Section name */</span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33">         sscanf(line, <span class="st">&quot;[%[^]]&quot;</span>, section);</a>
<a class="sourceLine" id="cb13-34" data-line-number="34">         strstrip(section);</a>
<a class="sourceLine" id="cb13-35" data-line-number="35">         strlwc(section, section, len);</a>
<a class="sourceLine" id="cb13-36" data-line-number="36">         sta = LINE_SECTION ;</a>
<a class="sourceLine" id="cb13-37" data-line-number="37">     } <span class="cf">else</span> <span class="cf">if</span> (sscanf (line, <span class="st">&quot;%[^=] = </span><span class="sc">\&quot;</span><span class="st">%[^</span><span class="sc">\&quot;</span><span class="st">]</span><span class="sc">\&quot;</span><span class="st">&quot;</span>, key, value) == <span class="dv">2</span></a>
<a class="sourceLine" id="cb13-38" data-line-number="38">            ||  sscanf (line, <span class="st">&quot;%[^=] = &#39;%[^</span><span class="sc">\&#39;</span><span class="st">]&#39;&quot;</span>,   key, value) == <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb13-39" data-line-number="39">         <span class="co">/* Usual key=value with quotes, with or without comments */</span></a>
<a class="sourceLine" id="cb13-40" data-line-number="40">        strstrip(key);</a>
<a class="sourceLine" id="cb13-41" data-line-number="41">        strlwc(key, key, len);</a>
<a class="sourceLine" id="cb13-42" data-line-number="42">        <span class="co">/* Don&#39;t strip spaces from values surrounded with quotes */</span></a>
<a class="sourceLine" id="cb13-43" data-line-number="43">        sta = LINE_VALUE ;</a>
<a class="sourceLine" id="cb13-44" data-line-number="44">    } <span class="cf">else</span> <span class="cf">if</span> (sscanf (line, <span class="st">&quot;%[^=] = %[^;#]&quot;</span>, key, value) == <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb13-45" data-line-number="45">        <span class="co">/* Usual key=value without quotes, with or without comments */</span></a>
<a class="sourceLine" id="cb13-46" data-line-number="46">        strstrip(key);</a>
<a class="sourceLine" id="cb13-47" data-line-number="47">        strlwc(key, key, len);</a>
<a class="sourceLine" id="cb13-48" data-line-number="48">        strstrip(value);</a>
<a class="sourceLine" id="cb13-49" data-line-number="49">        <span class="co">/*</span></a>
<a class="sourceLine" id="cb13-50" data-line-number="50"><span class="co">         * sscanf cannot handle &#39;&#39; or &quot;&quot; as empty values</span></a>
<a class="sourceLine" id="cb13-51" data-line-number="51"><span class="co">         * this is done here</span></a>
<a class="sourceLine" id="cb13-52" data-line-number="52"><span class="co">         */</span></a>
<a class="sourceLine" id="cb13-53" data-line-number="53">        <span class="cf">if</span> (!strcmp(value, <span class="st">&quot;</span><span class="sc">\&quot;\&quot;</span><span class="st">&quot;</span>) || (!strcmp(value, <span class="st">&quot;&#39;&#39;&quot;</span>))) {</a>
<a class="sourceLine" id="cb13-54" data-line-number="54">            value[<span class="dv">0</span>]=<span class="dv">0</span> ;</a>
<a class="sourceLine" id="cb13-55" data-line-number="55">        }</a>
<a class="sourceLine" id="cb13-56" data-line-number="56">        sta = LINE_VALUE ;</a>
<a class="sourceLine" id="cb13-57" data-line-number="57">    } <span class="cf">else</span> <span class="cf">if</span> (sscanf (line, <span class="st">&quot;%[^=] = %[^;#]&quot;</span>, key, value) == <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb13-58" data-line-number="58">        <span class="co">/* Usual key=value without quotes, with or without comments */</span></a>
<a class="sourceLine" id="cb13-59" data-line-number="59">        strstrip(key);</a>
<a class="sourceLine" id="cb13-60" data-line-number="60">        strlwc(key, key, len);</a>
<a class="sourceLine" id="cb13-61" data-line-number="61">        strstrip(value);</a>
<a class="sourceLine" id="cb13-62" data-line-number="62">         sta = LINE_VALUE ;</a>
<a class="sourceLine" id="cb13-63" data-line-number="63">    } <span class="cf">else</span> <span class="cf">if</span> (sscanf(line, <span class="st">&quot;%[^=] = %[;#]&quot;</span>, key, value)==<span class="dv">2</span></a>
<a class="sourceLine" id="cb13-64" data-line-number="64">           ||  sscanf(line, <span class="st">&quot;%[^=] %[=]&quot;</span>, key, value) == <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb13-65" data-line-number="65">         <span class="co">/*</span></a>
<a class="sourceLine" id="cb13-66" data-line-number="66"><span class="co">          * Special cases:</span></a>
<a class="sourceLine" id="cb13-67" data-line-number="67"><span class="co">          * key=</span></a>
<a class="sourceLine" id="cb13-68" data-line-number="68"><span class="co">          * key=;</span></a>
<a class="sourceLine" id="cb13-69" data-line-number="69"><span class="co">          * key=#</span></a>
<a class="sourceLine" id="cb13-70" data-line-number="70"><span class="co">          */</span></a>
<a class="sourceLine" id="cb13-71" data-line-number="71">         strstrip(key);</a>
<a class="sourceLine" id="cb13-72" data-line-number="72">         strlwc(key, key, len);</a>
<a class="sourceLine" id="cb13-73" data-line-number="73">         value[<span class="dv">0</span>]=<span class="dv">0</span> ;</a>
<a class="sourceLine" id="cb13-74" data-line-number="74">         sta = LINE_VALUE ;</a>
<a class="sourceLine" id="cb13-75" data-line-number="75">     } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb13-76" data-line-number="76">         <span class="co">/* Generate syntax error */</span></a>
<a class="sourceLine" id="cb13-77" data-line-number="77">         sta = LINE_ERROR ;</a>
<a class="sourceLine" id="cb13-78" data-line-number="78">     }</a>
<a class="sourceLine" id="cb13-79" data-line-number="79"> </a>
<a class="sourceLine" id="cb13-80" data-line-number="80">     free(line);</a>
<a class="sourceLine" id="cb13-81" data-line-number="81">     <span class="cf">return</span> sta ;</a>
<a class="sourceLine" id="cb13-82" data-line-number="82"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="http-parser"></p>
<h2 id="project-name-http-parser">Project Name: <a href="https://github.com/nodejs/http-parser/">http-parser</a></h2>
<p><a name="Heap out-of-bounds read in strtoul (68345541)"></p>
<h3 id="heap-out-of-bounds-read-in-strtoul-68345541-408">1. <a href="https://github.com/nodejs/http-parser/issues/408">Heap out-of-bounds read in strtoul (68345541) #408</a></h3>
<p><a href="https://github.com/nodejs/http-parser/issues/408"><strong>Description:</strong></a></p>
<blockquote>
<p>src: fix out-of-bounds read through <code>strtoul</code></p>
</blockquote>
<blockquote>
<p><code>strtoul</code> will attempt to lookup the next digit up until it will stumble upon an invalid one. However, for an unterminated string as an input value, this results in out-of-bounds read.</p>
</blockquote>
<blockquote>
<p>Remove <code>strtoul</code> call, and replace it with simple loop.</p>
</blockquote>
<p><a href="https://github.com/nodejs/http-parser/commit/9ce7316de31f90d8485706a1ab8ef623404c2d8c"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb14-1" data-line-number="1">  if (u-&gt;field_set &amp; (1 &lt;&lt; UF_PORT)) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">-     /* Don&#39;t bother with endp; we&#39;ve already validated the string */</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">-     unsigned long v = strtoul(buf + u-&gt;field_data[UF_PORT] .off, NULL, 10);</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">-      /* Ports have a max value of 2^16 */</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">-     if (v &gt; 0xffff) {</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">-       return 1;</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="va">+     uint16_t off;</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="va">+     uint16_t len;</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="va">+     const char* p;</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="va">+     const char* end;</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="va">+     unsigned long v;</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="va">+      off = u-&gt;field_data[UF_PORT].off;</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="va">+     len = u-&gt;field_data[UF_PORT].len;</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="va">+     end = buf + off + len;</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="va">+      /* NOTE: The characters are already validated and are in the [0-9] range */</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="va">+     assert(off + len &lt;= buflen &amp;&amp; &quot;Port number overflow&quot;);</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="va">+     v = 0;</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="va">+     for (p = buf + off; p &lt; end; p++) {</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="va">+       v *= 10;</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="va">+       v += *p - &#39;0&#39;;</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="va">+        /* Ports have a max value of 2^16 */</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="va">+       if (v &gt; 0xffff) {</span></a>
<a class="sourceLine" id="cb14-23" data-line-number="23"><span class="va">+         return 1;</span></a>
<a class="sourceLine" id="cb14-24" data-line-number="24"><span class="va">+       }</span></a>
<a class="sourceLine" id="cb14-25" data-line-number="25">    }</a></code></pre></div>
<p><a href="https://github.com/nodejs/http-parser/commit/9ce7316de31f90d8485706a1ab8ef623404c2d8c"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb15-1" data-line-number="1"> <span class="dt">void</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"> http_parser_url_init(<span class="kw">struct</span> http_parser_url *u) {</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">   memset(u, <span class="dv">0</span>, <span class="kw">sizeof</span>(*u));</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"> }</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"> </a>
<a class="sourceLine" id="cb15-6" data-line-number="6"> <span class="dt">int</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"> http_parser_parse_url(<span class="dt">const</span> <span class="dt">char</span> *buf, <span class="dt">size_t</span> buflen, <span class="dt">int</span> is_connect,</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">                       <span class="kw">struct</span> http_parser_url *u)</a>
<a class="sourceLine" id="cb15-9" data-line-number="9"> {</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">   <span class="kw">enum</span> state s;</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">   <span class="dt">const</span> <span class="dt">char</span> *p;</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">   <span class="kw">enum</span> http_parser_url_fields uf, old_uf;</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">   <span class="dt">int</span> found_at = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb15-14" data-line-number="14"> </a>
<a class="sourceLine" id="cb15-15" data-line-number="15">   u-&gt;port = u-&gt;field_set = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">   s = is_connect ? s_req_server_start : s_req_spaces_before_url;</a>
<a class="sourceLine" id="cb15-17" data-line-number="17">   old_uf = UF_MAX;</a>
<a class="sourceLine" id="cb15-18" data-line-number="18"> </a>
<a class="sourceLine" id="cb15-19" data-line-number="19">   <span class="cf">for</span> (p = buf; p &lt; buf + buflen; p++) {</a>
<a class="sourceLine" id="cb15-20" data-line-number="20">     s = parse_url_char(s, *p);</a>
<a class="sourceLine" id="cb15-21" data-line-number="21"> </a>
<a class="sourceLine" id="cb15-22" data-line-number="22">     <span class="co">/* Figure out the next field that we&#39;re operating on */</span></a>
<a class="sourceLine" id="cb15-23" data-line-number="23">     <span class="cf">switch</span> (s) {</a>
<a class="sourceLine" id="cb15-24" data-line-number="24">       <span class="cf">case</span> s_dead:</a>
<a class="sourceLine" id="cb15-25" data-line-number="25">         <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-26" data-line-number="26"> </a>
<a class="sourceLine" id="cb15-27" data-line-number="27">       <span class="co">/* Skip delimeters */</span></a>
<a class="sourceLine" id="cb15-28" data-line-number="28">       <span class="cf">case</span> s_req_schema_slash:</a>
<a class="sourceLine" id="cb15-29" data-line-number="29">       <span class="cf">case</span> s_req_schema_slash_slash:</a>
<a class="sourceLine" id="cb15-30" data-line-number="30">       <span class="cf">case</span> s_req_server_start:</a>
<a class="sourceLine" id="cb15-31" data-line-number="31">       <span class="cf">case</span> s_req_query_string_start:</a>
<a class="sourceLine" id="cb15-32" data-line-number="32">       <span class="cf">case</span> s_req_fragment_start:</a>
<a class="sourceLine" id="cb15-33" data-line-number="33">         <span class="cf">continue</span>;</a>
<a class="sourceLine" id="cb15-34" data-line-number="34"> </a>
<a class="sourceLine" id="cb15-35" data-line-number="35">       <span class="cf">case</span> s_req_schema:</a>
<a class="sourceLine" id="cb15-36" data-line-number="36">         uf = UF_SCHEMA;</a>
<a class="sourceLine" id="cb15-37" data-line-number="37">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-38" data-line-number="38"> </a>
<a class="sourceLine" id="cb15-39" data-line-number="39">       <span class="cf">case</span> s_req_server_with_at:</a>
<a class="sourceLine" id="cb15-40" data-line-number="40">         found_at = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-41" data-line-number="41"> </a>
<a class="sourceLine" id="cb15-42" data-line-number="42">       <span class="co">/* FALLTHROUGH */</span></a>
<a class="sourceLine" id="cb15-43" data-line-number="43">       <span class="cf">case</span> s_req_server:</a>
<a class="sourceLine" id="cb15-44" data-line-number="44">         uf = UF_HOST;</a>
<a class="sourceLine" id="cb15-45" data-line-number="45">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-46" data-line-number="46"> </a>
<a class="sourceLine" id="cb15-47" data-line-number="47">       <span class="cf">case</span> s_req_path:</a>
<a class="sourceLine" id="cb15-48" data-line-number="48">         uf = UF_PATH;</a>
<a class="sourceLine" id="cb15-49" data-line-number="49">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-50" data-line-number="50"> </a>
<a class="sourceLine" id="cb15-51" data-line-number="51">       <span class="cf">case</span> s_req_query_string:</a>
<a class="sourceLine" id="cb15-52" data-line-number="52">         uf = UF_QUERY;</a>
<a class="sourceLine" id="cb15-53" data-line-number="53">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-54" data-line-number="54"> </a>
<a class="sourceLine" id="cb15-55" data-line-number="55">       <span class="cf">case</span> s_req_fragment:</a>
<a class="sourceLine" id="cb15-56" data-line-number="56">         uf = UF_FRAGMENT;</a>
<a class="sourceLine" id="cb15-57" data-line-number="57">         <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb15-58" data-line-number="58"> </a>
<a class="sourceLine" id="cb15-59" data-line-number="59">       <span class="cf">default</span>:</a>
<a class="sourceLine" id="cb15-60" data-line-number="60">         assert(!<span class="st">&quot;Unexpected state&quot;</span>);</a>
<a class="sourceLine" id="cb15-61" data-line-number="61">         <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-62" data-line-number="62">     }</a>
<a class="sourceLine" id="cb15-63" data-line-number="63"> </a>
<a class="sourceLine" id="cb15-64" data-line-number="64">     <span class="co">/* Nothing&#39;s changed; soldier on */</span></a>
<a class="sourceLine" id="cb15-65" data-line-number="65">     <span class="cf">if</span> (uf == old_uf) {</a>
<a class="sourceLine" id="cb15-66" data-line-number="66">       u-&gt;field_data[uf].len++;</a>
<a class="sourceLine" id="cb15-67" data-line-number="67">       <span class="cf">continue</span>;</a>
<a class="sourceLine" id="cb15-68" data-line-number="68">     }</a>
<a class="sourceLine" id="cb15-69" data-line-number="69"> </a>
<a class="sourceLine" id="cb15-70" data-line-number="70">     u-&gt;field_data[uf].off = p - buf;</a>
<a class="sourceLine" id="cb15-71" data-line-number="71">     u-&gt;field_data[uf].len = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-72" data-line-number="72"> </a>
<a class="sourceLine" id="cb15-73" data-line-number="73">     u-&gt;field_set |= (<span class="dv">1</span> &lt;&lt; uf);</a>
<a class="sourceLine" id="cb15-74" data-line-number="74">     old_uf = uf;</a>
<a class="sourceLine" id="cb15-75" data-line-number="75">   }</a>
<a class="sourceLine" id="cb15-76" data-line-number="76"> </a>
<a class="sourceLine" id="cb15-77" data-line-number="77">   <span class="co">/* host must be present if there is a schema */</span></a>
<a class="sourceLine" id="cb15-78" data-line-number="78">   <span class="co">/* parsing http:///toto will fail */</span></a>
<a class="sourceLine" id="cb15-79" data-line-number="79">   <span class="cf">if</span> ((u-&gt;field_set &amp; (<span class="dv">1</span> &lt;&lt; UF_SCHEMA)) &amp;&amp;</a>
<a class="sourceLine" id="cb15-80" data-line-number="80">       (u-&gt;field_set &amp; (<span class="dv">1</span> &lt;&lt; UF_HOST)) == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb15-81" data-line-number="81">     <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-82" data-line-number="82">   }</a>
<a class="sourceLine" id="cb15-83" data-line-number="83"> </a>
<a class="sourceLine" id="cb15-84" data-line-number="84">   <span class="cf">if</span> (u-&gt;field_set &amp; (<span class="dv">1</span> &lt;&lt; UF_HOST)) {</a>
<a class="sourceLine" id="cb15-85" data-line-number="85">     <span class="cf">if</span> (http_parse_host(buf, u, found_at) != <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb15-86" data-line-number="86">       <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-87" data-line-number="87">     }</a>
<a class="sourceLine" id="cb15-88" data-line-number="88">   }</a>
<a class="sourceLine" id="cb15-89" data-line-number="89"> </a>
<a class="sourceLine" id="cb15-90" data-line-number="90">   <span class="co">/* CONNECT requests can only contain &quot;hostname:port&quot; */</span></a>
<a class="sourceLine" id="cb15-91" data-line-number="91">   <span class="cf">if</span> (is_connect &amp;&amp; u-&gt;field_set != ((<span class="dv">1</span> &lt;&lt; UF_HOST)|(<span class="dv">1</span> &lt;&lt; UF_PORT))) {</a>
<a class="sourceLine" id="cb15-92" data-line-number="92">     <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-93" data-line-number="93">  }</a>
<a class="sourceLine" id="cb15-94" data-line-number="94">   <span class="cf">if</span> (u-&gt;field_set &amp; (<span class="dv">1</span> &lt;&lt; UF_PORT)) {</a>
<a class="sourceLine" id="cb15-95" data-line-number="95">    <span class="co">/* Don&#39;t bother with endp; we&#39;ve already validated the string */</span></a>
<a class="sourceLine" id="cb15-96" data-line-number="96">    <span class="dt">unsigned</span> <span class="dt">long</span> v = strtoul(buf + u-&gt;field_data[UF_PORT].off, NULL, <span class="dv">10</span>);</a>
<a class="sourceLine" id="cb15-97" data-line-number="97">     <span class="co">/* Ports have a max value of 2^16 */</span></a>
<a class="sourceLine" id="cb15-98" data-line-number="98">    <span class="cf">if</span> (v &gt; <span class="bn">0xffff</span>) {</a>
<a class="sourceLine" id="cb15-99" data-line-number="99">      <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-100" data-line-number="100">    <span class="dt">uint16_t</span> off;</a>
<a class="sourceLine" id="cb15-101" data-line-number="101">    <span class="dt">uint16_t</span> len;</a>
<a class="sourceLine" id="cb15-102" data-line-number="102">    <span class="dt">const</span> <span class="dt">char</span>* p;</a>
<a class="sourceLine" id="cb15-103" data-line-number="103">    <span class="dt">const</span> <span class="dt">char</span>* end;</a>
<a class="sourceLine" id="cb15-104" data-line-number="104">    <span class="dt">unsigned</span> <span class="dt">long</span> v;</a>
<a class="sourceLine" id="cb15-105" data-line-number="105">     off = u-&gt;field_data[UF_PORT].off;</a>
<a class="sourceLine" id="cb15-106" data-line-number="106">    len = u-&gt;field_data[UF_PORT].len;</a>
<a class="sourceLine" id="cb15-107" data-line-number="107">    end = buf + off + len;</a>
<a class="sourceLine" id="cb15-108" data-line-number="108">     <span class="co">/* </span><span class="al">NOTE</span><span class="co">: The characters are already validated and are in the [0-9] range */</span></a>
<a class="sourceLine" id="cb15-109" data-line-number="109">    assert(off + len &lt;= buflen &amp;&amp; <span class="st">&quot;Port number overflow&quot;</span>);</a>
<a class="sourceLine" id="cb15-110" data-line-number="110">    v = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb15-111" data-line-number="111">    <span class="cf">for</span> (p = buf + off; p &lt; end; p++) {</a>
<a class="sourceLine" id="cb15-112" data-line-number="112">      v *= <span class="dv">10</span>;</a>
<a class="sourceLine" id="cb15-113" data-line-number="113">      v += *p - <span class="ch">&#39;0&#39;</span>;</a>
<a class="sourceLine" id="cb15-114" data-line-number="114">       <span class="co">/* Ports have a max value of 2^16 */</span></a>
<a class="sourceLine" id="cb15-115" data-line-number="115">      <span class="cf">if</span> (v &gt; <span class="bn">0xffff</span>) {</a>
<a class="sourceLine" id="cb15-116" data-line-number="116">        <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-117" data-line-number="117">      }</a>
<a class="sourceLine" id="cb15-118" data-line-number="118">    }</a>
<a class="sourceLine" id="cb15-119" data-line-number="119">     u-&gt;port = (<span class="dt">uint16_t</span>) v;</a>
<a class="sourceLine" id="cb15-120" data-line-number="120">   }</a>
<a class="sourceLine" id="cb15-121" data-line-number="121"> </a>
<a class="sourceLine" id="cb15-122" data-line-number="122">   <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb15-123" data-line-number="123"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="myhtml"></p>
<h3 id="project-name-myhtml">Project Name: <a href="https://github.com/lexborisov/myhtml/">myhtml</a></h3>
<p><a name="fix charef parsing #152"></p>
<h3 id="fix-charef-parsing-152httpsgithub.comlexborisovmyhtmlpull152">1. [fix charef parsing #152]](https://github.com/lexborisov/myhtml/pull/152)</h3>
<p><a href="https://github.com/lexborisov/myhtml/pull/152"><strong>Description</strong></a></p>
<blockquote>
<p>fix bugs like this:<br />
&amp;redirect =&gt; ®direct</p>
</blockquote>
<p><a href="https://github.com/lexborisov/myhtml/pull/152"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="st">-    if(named_character_references[pos].codepoints_len)</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">-        return &amp;named_character_references[pos];</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="st">-    else if(result-&gt;last_entry) {</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="va">+    if(result-&gt;last_entry) {</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">        *offset = result-&gt;last_offset;</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">        return result-&gt;last_entry;</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    }</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">    </a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="st">-    return &amp;named_character_references[pos];</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="va">+    return &amp;named_character_references[0];</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">}</a></code></pre></div>
<p><a href="https://github.com/lexborisov/myhtml/pull/152"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb17-1" data-line-number="1"> <span class="dt">const</span> charef_entry_t * myhtml_charef_find_by_pos(<span class="dt">size_t</span> pos, <span class="dt">const</span> <span class="dt">char</span> *begin, <span class="dt">size_t</span> *offset, <span class="dt">size_t</span> size, charef_entry_result_t *result)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"> {</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">     <span class="dt">unsigned</span> <span class="dt">const</span> <span class="dt">char</span>* u_begin = (<span class="dt">unsigned</span> <span class="dt">const</span> <span class="dt">char</span>*)begin;</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">     </a>
<a class="sourceLine" id="cb17-5" data-line-number="5">     <span class="cf">if</span>(u_begin[*offset] == <span class="ch">&#39;&amp;&#39;</span>) {</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">         result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">         </a>
<a class="sourceLine" id="cb17-8" data-line-number="8">         <span class="cf">if</span>(result-&gt;curr_entry-&gt;codepoints_len)</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">             <span class="cf">return</span> result-&gt;curr_entry;</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">         <span class="cf">else</span> <span class="cf">if</span>(result-&gt;last_entry) {</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">             *offset = result-&gt;last_offset;</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">             <span class="cf">return</span> result-&gt;last_entry;</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">         }</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">         </a>
<a class="sourceLine" id="cb17-15" data-line-number="15">         <span class="cf">return</span> &amp;named_character_references[<span class="dv">0</span>];</a>
<a class="sourceLine" id="cb17-16" data-line-number="16">     }</a>
<a class="sourceLine" id="cb17-17" data-line-number="17">     </a>
<a class="sourceLine" id="cb17-18" data-line-number="18">     result-&gt;is_done = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb17-19" data-line-number="19">     </a>
<a class="sourceLine" id="cb17-20" data-line-number="20">     <span class="cf">while</span> (named_character_references[pos].ch)</a>
<a class="sourceLine" id="cb17-21" data-line-number="21">     {</a>
<a class="sourceLine" id="cb17-22" data-line-number="22">         <span class="cf">if</span>(named_character_references[pos].ch == u_begin[*offset])</a>
<a class="sourceLine" id="cb17-23" data-line-number="23">         {</a>
<a class="sourceLine" id="cb17-24" data-line-number="24">             <span class="cf">if</span>(u_begin[*offset] == <span class="ch">&#39;;&#39;</span>) {</a>
<a class="sourceLine" id="cb17-25" data-line-number="25">                 result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-26" data-line-number="26">                 </a>
<a class="sourceLine" id="cb17-27" data-line-number="27">                 result-&gt;curr_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-28" data-line-number="28">                 <span class="cf">return</span> result-&gt;curr_entry;</a>
<a class="sourceLine" id="cb17-29" data-line-number="29">             }</a>
<a class="sourceLine" id="cb17-30" data-line-number="30">             </a>
<a class="sourceLine" id="cb17-31" data-line-number="31">             (*offset)++;</a>
<a class="sourceLine" id="cb17-32" data-line-number="32">             </a>
<a class="sourceLine" id="cb17-33" data-line-number="33">             <span class="cf">if</span>(named_character_references[pos].next == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb17-34" data-line-number="34">                 result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-35" data-line-number="35">                 <span class="cf">return</span> &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-36" data-line-number="36">             }</a>
<a class="sourceLine" id="cb17-37" data-line-number="37">             </a>
<a class="sourceLine" id="cb17-38" data-line-number="38">             <span class="cf">if</span>(*offset &gt;= size)</a>
<a class="sourceLine" id="cb17-39" data-line-number="39">             {</a>
<a class="sourceLine" id="cb17-40" data-line-number="40">                 result-&gt;curr_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-41" data-line-number="41">                 </a>
<a class="sourceLine" id="cb17-42" data-line-number="42">                 <span class="cf">if</span>(named_character_references[pos].codepoints_len) {</a>
<a class="sourceLine" id="cb17-43" data-line-number="43">                     result-&gt;last_offset = *offset;</a>
<a class="sourceLine" id="cb17-44" data-line-number="44">                     result-&gt;last_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-45" data-line-number="45">                 }</a>
<a class="sourceLine" id="cb17-46" data-line-number="46">                 </a>
<a class="sourceLine" id="cb17-47" data-line-number="47">                 <span class="cf">return</span> result-&gt;curr_entry;</a>
<a class="sourceLine" id="cb17-48" data-line-number="48">             }</a>
<a class="sourceLine" id="cb17-49" data-line-number="49">             </a>
<a class="sourceLine" id="cb17-50" data-line-number="50">             <span class="cf">if</span>(u_begin[*offset] == <span class="ch">&#39;&amp;&#39;</span>) {</a>
<a class="sourceLine" id="cb17-51" data-line-number="51">                 result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-52" data-line-number="52">                 result-&gt;curr_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-53" data-line-number="53">                 </a>
<a class="sourceLine" id="cb17-54" data-line-number="54">                 <span class="cf">if</span>(result-&gt;curr_entry-&gt;codepoints_len)</a>
<a class="sourceLine" id="cb17-55" data-line-number="55">                     <span class="cf">return</span> result-&gt;curr_entry;</a>
<a class="sourceLine" id="cb17-56" data-line-number="56">                 <span class="cf">else</span> <span class="cf">if</span>(result-&gt;last_entry) {</a>
<a class="sourceLine" id="cb17-57" data-line-number="57">                     *offset = result-&gt;last_offset;</a>
<a class="sourceLine" id="cb17-58" data-line-number="58">                     <span class="cf">return</span> result-&gt;last_entry;</a>
<a class="sourceLine" id="cb17-59" data-line-number="59">                 }</a>
<a class="sourceLine" id="cb17-60" data-line-number="60">                 </a>
<a class="sourceLine" id="cb17-61" data-line-number="61">                 <span class="cf">return</span> &amp;named_character_references[<span class="dv">0</span>];</a>
<a class="sourceLine" id="cb17-62" data-line-number="62">             }</a>
<a class="sourceLine" id="cb17-63" data-line-number="63">             </a>
<a class="sourceLine" id="cb17-64" data-line-number="64">             <span class="cf">if</span>(named_character_references[pos].codepoints_len) {</a>
<a class="sourceLine" id="cb17-65" data-line-number="65">                 result-&gt;last_offset = *offset;</a>
<a class="sourceLine" id="cb17-66" data-line-number="66">                 result-&gt;last_entry = &amp;named_character_references[pos];</a>
<a class="sourceLine" id="cb17-67" data-line-number="67">             }</a>
<a class="sourceLine" id="cb17-68" data-line-number="68">             </a>
<a class="sourceLine" id="cb17-69" data-line-number="69">             pos = named_character_references[pos].next;</a>
<a class="sourceLine" id="cb17-70" data-line-number="70">         }</a>
<a class="sourceLine" id="cb17-71" data-line-number="71">         <span class="cf">else</span> <span class="cf">if</span>(u_begin[*offset] &gt; named_character_references[pos].ch) {</a>
<a class="sourceLine" id="cb17-72" data-line-number="72">             pos++;</a>
<a class="sourceLine" id="cb17-73" data-line-number="73">         }</a>
<a class="sourceLine" id="cb17-74" data-line-number="74">         <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb17-75" data-line-number="75">             <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb17-76" data-line-number="76">         }</a>
<a class="sourceLine" id="cb17-77" data-line-number="77">     }</a>
<a class="sourceLine" id="cb17-78" data-line-number="78">    </a>
<a class="sourceLine" id="cb17-79" data-line-number="79">    result-&gt;is_done = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb17-80" data-line-number="80">    </a>
<a class="sourceLine" id="cb17-81" data-line-number="81">    <span class="cf">if</span>(result-&gt;last_entry) {</a>
<a class="sourceLine" id="cb17-82" data-line-number="82">        *offset = result-&gt;last_offset;</a>
<a class="sourceLine" id="cb17-83" data-line-number="83">        <span class="cf">return</span> result-&gt;last_entry;</a>
<a class="sourceLine" id="cb17-84" data-line-number="84">    }</a>
<a class="sourceLine" id="cb17-85" data-line-number="85">    <span class="cf">return</span> &amp;named_character_references[<span class="dv">0</span>];</a>
<a class="sourceLine" id="cb17-86" data-line-number="86">}</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="json-parser"></p>
<h3 id="project-name-json-parser">Project Name: <a href="https://github.com/udp/json-parser/">json-parser</a></h3>
<p><a name="heap buffer overflow on some inputs #68"></p>
<h3 id="heap-buffer-overflow-on-some-inputs-68">1. <a href="https://github.com/udp/json-parser/issues/68">heap buffer overflow on some inputs #68</a></h3>
<p><a href="https://github.com/udp/json-parser/issues/68"><strong>Description</strong></a></p>
<blockquote>
<p>Explanation if you need it for your thesis: When json-parser reads a unicode character, it reads 4 or 6 characters immediately without going back around the main loop which usually processes one byte at a time. To prevent this from causing a buffer overrun, there was an error condition if end - state.ptr &lt; 4 to check that 4 bytes were actually available to read. However, this check was performed on the ‘u’ character of the , which would return &gt;= 4 even if the input truncated at . To fix this, the error condition has been changed to end - state.ptr &lt;= 4.</p>
</blockquote>
<p><a href="https://github.com/udp/json-parser/commit/b42439a2927a879f40698e4861e727c4265c13e6"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="st">-                    if (end - state.ptr &lt; 4 || </span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="va">+                    if (end - state.ptr &lt;= 4 || </span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">                        (uc_b1 = hex_value (*++ state.ptr)) == 0xFF ||</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">                        (uc_b2 = hex_value (*++ state.ptr)) == 0xFF ||</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">                        (uc_b3 = hex_value (*++ state.ptr)) == 0xFF ||</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">                         (uc_b4 = hex_value (*++ state.ptr)) == 0xFF)</a>
<a class="sourceLine" id="cb18-7" data-line-number="7">                     {</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">                         sprintf (error, &quot;Invalid character value `%c` (at %d:%d)&quot;, b, line_and_col);</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">                         goto e_failed;</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">                     }</a>
<a class="sourceLine" id="cb18-11" data-line-number="11"> </a>
<a class="sourceLine" id="cb18-12" data-line-number="12">                     uc_b1 = (uc_b1 &lt;&lt; 4) | uc_b2;</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">                     uc_b2 = (uc_b3 &lt;&lt; 4) | uc_b4;</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">                     uchar = (uc_b1 &lt;&lt; 8) | uc_b2;</a>
<a class="sourceLine" id="cb18-15" data-line-number="15"> </a>
<a class="sourceLine" id="cb18-16" data-line-number="16">                    if ((uchar &amp; 0xF800) == 0xD800) {</a>
<a class="sourceLine" id="cb18-17" data-line-number="17">                        json_uchar uchar2;</a>
<a class="sourceLine" id="cb18-18" data-line-number="18">                        </a>
<a class="sourceLine" id="cb18-19" data-line-number="19">                        if (end - state.ptr &lt; 6 || (*++ state.ptr) != &#39;\\&#39; || (*++ state.ptr) != &#39;u&#39; ||</a>
<a class="sourceLine" id="cb18-20" data-line-number="20"><span class="st">-                        if (end - state.ptr &lt;= 6 || (*++ state.ptr) != &#39;\\&#39; || (*++ state.ptr) != &#39;u&#39; ||</span></a>
<a class="sourceLine" id="cb18-21" data-line-number="21"><span class="va">+                            (uc_b1 = hex_value (*++ state.ptr)) == 0xFF ||</span></a>
<a class="sourceLine" id="cb18-22" data-line-number="22">                            (uc_b2 = hex_value (*++ state.ptr)) == 0xFF ||</a></code></pre></div>
<p><a href="https://github.com/udp/json-parser/blob/b42439a2927a879f40698e4861e727c4265c13e6/json.c#L221"><strong>Full function:</strong></a></p>
<p>Too long, omitted, see <a href="https://github.com/udp/json-parser/blob/b42439a2927a879f40698e4861e727c4265c13e6/json.c#L221">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="mongoose"></p>
<h3 id="project-name-mongoose">Project Name: <a href="https://github.com/cesanta/mongoose">mongoose</a></h3>
<p><a name="websocket client bug #631"></p>
<h3 id="websocket-client-bug-631">1. <a href="https://github.com/cesanta/mongoose/issues/631">websocket client bug #631</a></h3>
<p><a href="https://github.com/cesanta/mongoose/issues/631"><strong>Description</strong></a></p>
<blockquote>
<p>the function mg_http_common_url_parse(…) has a bug，when parse url, such as: ws://localhost:8080/ws =&gt; host=locahost:8080, path=/ws now result is =&gt; host=localhost:8080, path=ws (that is error,not leading /)</p>
</blockquote>
<blockquote>
<p>the error occur because on the functio,code is:</p>
</blockquote>
<pre><code>if (*url == &#39;/&#39;) {
  url++;     ==&gt; that is error
  break;
}</code></pre>
<blockquote>
<p>Fix url path parsing</p>
</blockquote>
<blockquote>
<p>The url parser had two bugs:</p>
</blockquote>
<ul>
<li><p><code>http://example.com</code> -&gt; <code>GET // HTTP/1.1</code></p></li>
<li><p><code>foo://bar/baz</code> -&gt; path is <code>&quot;baz&quot;</code> instead of <code>&quot;/baz&quot;</code></p></li>
</ul>
<blockquote>
<p>Now the path returned by <code>mg_http_common_url_parse</code> always starts with <code>/</code>.</p>
</blockquote>
<p><a href="https://github.com/cesanta/mongoose/commit/29d6c4ac04d4eb5c7eca295a77c8df47fb04f12f"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="dt">@@ -7540,7 +7540,6 @@ static int mg_http_common_url_parse(const char *url, const char *schema,</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">      return -1;</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">    }</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">    if (*url == &#39;/&#39;) {</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="st">-      url++;</span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">      break;</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">    }</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">    if (*url == &#39;:&#39;) *port_i = addr_len;</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="dt">@@ -7632,7 +7631,7 @@ struct mg_connection *mg_connect_http(struct mg_mgr *mgr,</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10">    /* If the port was addred by us, restore the original host. */</a>
<a class="sourceLine" id="cb20-11" data-line-number="11">    if (port_i &gt;= 0) addr[port_i] = &#39;\0&#39;;</a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="st">-    mg_printf(nc, &quot;%s /%s HTTP/1.1\r\nHost: %s\r\nContent-Length: %&quot; SIZE_T_FMT</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="va">+    mg_printf(nc, &quot;%s %s HTTP/1.1\r\nHost: %s\r\nContent-Length: %&quot; SIZE_T_FMT</span></a></code></pre></div>
<p><a href="https://github.com/cesanta/mongoose/commit/29d6c4ac04d4eb5c7eca295a77c8df47fb04f12f"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb21-1" data-line-number="1"> <span class="dt">static</span> <span class="dt">int</span> mg_http_common_url_parse(<span class="dt">const</span> <span class="dt">char</span> *url, <span class="dt">const</span> <span class="dt">char</span> *schema,</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">                                     <span class="dt">const</span> <span class="dt">char</span> *schema_tls, <span class="dt">int</span> *use_ssl,</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">                                     <span class="dt">char</span> **addr, <span class="dt">int</span> *port_i,</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">                                     <span class="dt">const</span> <span class="dt">char</span> **path) {</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">   <span class="dt">int</span> addr_len = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb21-7" data-line-number="7">   <span class="cf">if</span> (memcmp(url, schema, strlen(schema)) == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">     url += strlen(schema);</a>
<a class="sourceLine" id="cb21-9" data-line-number="9">   } <span class="cf">else</span> <span class="cf">if</span> (memcmp(url, schema_tls, strlen(schema_tls)) == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb21-10" data-line-number="10">     url += strlen(schema_tls);</a>
<a class="sourceLine" id="cb21-11" data-line-number="11">     *use_ssl = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb21-12" data-line-number="12"> <span class="pp">#ifndef MG_ENABLE_SSL</span></a>
<a class="sourceLine" id="cb21-13" data-line-number="13">     <span class="cf">return</span> <span class="dv">-1</span>; <span class="co">/* SSL is not enabled, cannot do HTTPS URLs */</span></a>
<a class="sourceLine" id="cb21-14" data-line-number="14"> <span class="pp">#endif</span></a>
<a class="sourceLine" id="cb21-15" data-line-number="15">   }</a>
<a class="sourceLine" id="cb21-16" data-line-number="16"> </a>
<a class="sourceLine" id="cb21-17" data-line-number="17">   <span class="cf">while</span> (*url != &#39;\<span class="dv">0</span>&#39;) {</a>
<a class="sourceLine" id="cb21-18" data-line-number="18">     *addr = (<span class="dt">char</span> *) MG_REALLOC(*addr, addr_len + <span class="dv">5</span> <span class="co">/* space for port too. */</span>);</a>
<a class="sourceLine" id="cb21-19" data-line-number="19">     <span class="cf">if</span> (*addr == NULL) {</a>
<a class="sourceLine" id="cb21-20" data-line-number="20">       DBG((<span class="st">&quot;OOM&quot;</span>));</a>
<a class="sourceLine" id="cb21-21" data-line-number="21">      <span class="cf">return</span> <span class="dv">-1</span>;</a>
<a class="sourceLine" id="cb21-22" data-line-number="22">    }</a>
<a class="sourceLine" id="cb21-23" data-line-number="23">    <span class="cf">if</span> (*url == <span class="ch">&#39;/&#39;</span>) {</a>
<a class="sourceLine" id="cb21-24" data-line-number="24">      url++;</a>
<a class="sourceLine" id="cb21-25" data-line-number="25">      <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb21-26" data-line-number="26">    }</a>
<a class="sourceLine" id="cb21-27" data-line-number="27">    <span class="cf">if</span> (*url == <span class="ch">&#39;:&#39;</span>) *port_i = addr_len;</a>
<a class="sourceLine" id="cb21-28" data-line-number="28">@@ <span class="dv">-7632</span>,<span class="dv">7</span> +<span class="dv">7631</span>,<span class="dv">7</span> @@ <span class="kw">struct</span> mg_connection *mg_connect_http(<span class="kw">struct</span> mg_mgr *mgr,</a>
<a class="sourceLine" id="cb21-29" data-line-number="29">    <span class="co">/* If the port was addred by us, restore the original host. */</span></a>
<a class="sourceLine" id="cb21-30" data-line-number="30">    <span class="cf">if</span> (port_i &gt;= <span class="dv">0</span>) addr[port_i] = &#39;\<span class="dv">0</span>&#39;;</a>
<a class="sourceLine" id="cb21-31" data-line-number="31">     mg_printf(nc, <span class="st">&quot;%s /%s HTTP/1.1</span><span class="sc">\r\n</span><span class="st">Host: %s</span><span class="sc">\r\n</span><span class="st">Content-Length: %&quot;</span> SIZE_T_FMT</a>
<a class="sourceLine" id="cb21-32" data-line-number="32">    mg_printf(nc, <span class="st">&quot;%s %s HTTP/1.1</span><span class="sc">\r\n</span><span class="st">Host: %s</span><span class="sc">\r\n</span><span class="st">Content-Length: %&quot;</span> SIZE_T_FMT</a>
<a class="sourceLine" id="cb21-33" data-line-number="33">                  <span class="st">&quot;</span><span class="sc">\r\n</span><span class="st">%s</span><span class="sc">\r\n</span><span class="st">%s&quot;</span>,</a>
<a class="sourceLine" id="cb21-34" data-line-number="34">              post_data == NULL ? <span class="st">&quot;GET&quot;</span> : <span class="st">&quot;POST&quot;</span>, path, addr,</a>
<a class="sourceLine" id="cb21-35" data-line-number="35">              post_data == NULL ? <span class="dv">0</span> : strlen(post_data),</a>
<a class="sourceLine" id="cb21-36" data-line-number="36">               extra_headers == NULL ? <span class="st">&quot;&quot;</span> : extra_headers,</a>
<a class="sourceLine" id="cb21-37" data-line-number="37">               post_data == NULL ? <span class="st">&quot;&quot;</span> : post_data);</a>
<a class="sourceLine" id="cb21-38" data-line-number="38">   }</a>
<a class="sourceLine" id="cb21-39" data-line-number="39"> </a>
<a class="sourceLine" id="cb21-40" data-line-number="40">   MG_FREE(addr);</a>
<a class="sourceLine" id="cb21-41" data-line-number="41">   <span class="cf">return</span> nc;</a>
<a class="sourceLine" id="cb21-42" data-line-number="42"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="Firefox"></p>
<h3 id="project-name-firefox">Project Name: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5176">Firefox</a></h3>
<p><a name="Iframe injection & content spoofing & scripts execution via json viewer"></p>
<h3 id="iframe-injection-content-spoofing-scripts-execution-via-json-viewer">1. <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5176">Iframe injection &amp; content spoofing &amp; scripts execution via json viewer</a></h3>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5176"><strong>Description</strong></a></p>
<blockquote>
<p>The JSON Viewer displays clickable hyperlinks for strings that are parseable as URLs, including “javascript:” links. If a JSON file contains malicious JavaScript script embedded as “javascript:” links, users may be tricked into clicking and running this code in the context of the JSON Viewer. This can allow for the theft of cookies and authorization tokens which are accessible to that context. This vulnerability affects Firefox &lt; 60.</p>
</blockquote>
<p><a href="https://bugzilla.mozilla.org/attachment.cgi?id=8957304&amp;action=edit"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb22-1" data-line-number="1">       // Render the value (summary) using Reps library.</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">       return Rep(Object.assign({}, props, {</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">         cropLimit: 50,</a>
<a class="sourceLine" id="cb22-4" data-line-number="4">         noGrip: true,</a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="st">-        omitLinkHref: false,</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="va">+        openLink(str) {</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="va">+          try {</span></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="va">+            let u = new URL(str);</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="va">+            if (u.protocol == &quot;https:&quot; || u.protocol == &quot;http:&quot;) {</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="va">+              window.open(str, &quot;_blank&quot;);</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="va">+            }</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="va">+          } catch (ex) { /* the link might be bust, then we do nothing */ }</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="va">+        },</span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14">       }));</a></code></pre></div>
<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1442840"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co">// omitted</span></a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="poco"></p>
<h3 id="project-name-poco">Project Name: <a href="https://github.com/pocoproject/poco">poco</a></h3>
<p><a name="Zip Decompress Parent Path Injection #1968"></p>
<h3 id="zip-decompress-parent-path-injection-1968">1. <a href="https://github.com/pocoproject/poco/issues/1968">Zip Decompress Parent Path Injection #1968</a></h3>
<p><a href="https://github.com/pocoproject/poco/issues/1968"><strong>Description</strong></a></p>
<blockquote>
<p>By manipulation of the Zip input file header, the contents of the zip archive can be written to an arbitrary parent path of the user.</p>
</blockquote>
<blockquote>
<p>Expected behavior<br />
Throw an exception if filename contains a parent directory reference. isValidPath() (ZipCommon.cpp) should check if the filename contains a tilde character.</p>
</blockquote>
<blockquote>
<p>Actual behavior<br />
By inserting a tilde-slash (~/) in the filename area of the zip header, files can be written to the user’s home directory.</p>
</blockquote>
<blockquote>
<p>Steps to reproduce the problem<br />
Use the sample-unzip samle application as follows:</p>
</blockquote>
<pre><code>$ ./sample-unzip -f vuln.zip SOME_OUT_DIR
vuln.zip contains a file foo. foo includes the string bar</code></pre>
<p><a href="https://github.com/pocoproject/poco/commit/f5b2cf3dd6976ae53b2f3c9618b0087a0646cc7d"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb25-1" data-line-number="1">Zip/src/Decompress.cpp</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="dt">@@ -80,7 +80,7 @@ bool Decompress::handleZipEntry(std::istream&amp; zipStream, const ZipLocalFileHeade</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3">        {</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">            std::string dirName = hdr.getFileName();</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">            if (!ZipCommon::isValidPath(dirName))</a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="st">-               throw ZipException(&quot;Illegal entry name &quot; + dirName + &quot; containing parent directory reference&quot;);</span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="va">+               throw ZipException(&quot;Illegal entry name &quot; + dirName);</span></a>
<a class="sourceLine" id="cb25-8" data-line-number="8">            Poco::Path dir(_outDir, dirName);</a>
<a class="sourceLine" id="cb25-9" data-line-number="9">            dir.makeDirectory();</a>
<a class="sourceLine" id="cb25-10" data-line-number="10">            Poco::File aFile(dir);</a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="dt">@@ -100,7 +100,7 @@ bool Decompress::handleZipEntry(std::istream&amp; zipStream, const ZipLocalFileHeade</span></a>
<a class="sourceLine" id="cb25-12" data-line-number="12">        }</a>
<a class="sourceLine" id="cb25-13" data-line-number="13">        if (!ZipCommon::isValidPath(fileName))</a>
<a class="sourceLine" id="cb25-14" data-line-number="14"><span class="st">-           throw ZipException(&quot;Illegal entry name &quot; + fileName + &quot; containing parent directory reference&quot;);</span></a>
<a class="sourceLine" id="cb25-15" data-line-number="15"><span class="va">+           throw ZipException(&quot;Illegal entry name &quot; + fileName);</span></a>
<a class="sourceLine" id="cb25-16" data-line-number="16">        Poco::Path file(fileName);</a>
<a class="sourceLine" id="cb25-17" data-line-number="17">        file.makeFile();</a>
<a class="sourceLine" id="cb25-18" data-line-number="18"></a>
<a class="sourceLine" id="cb25-19" data-line-number="19">Zip/src/ZipCommon.cpp</a>
<a class="sourceLine" id="cb25-20" data-line-number="20"><span class="dt">@@ -21,15 +22,26 @@ namespace Zip {</span></a>
<a class="sourceLine" id="cb25-21" data-line-number="21"> bool ZipCommon::isValidPath(const std::string&amp; path)</a>
<a class="sourceLine" id="cb25-22" data-line-number="22">{</a>
<a class="sourceLine" id="cb25-23" data-line-number="23"><span class="va">+   if (!Path(path).isRelative())</span></a>
<a class="sourceLine" id="cb25-24" data-line-number="24"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-25" data-line-number="25"><span class="va">+   if (path == &quot;..&quot;)</span></a>
<a class="sourceLine" id="cb25-26" data-line-number="26"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-27" data-line-number="27"><span class="st">-   if (path.compare(0, 3, &quot;../&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-28" data-line-number="28"><span class="va">+   if ((path.size() &gt;= 3) &amp;&amp; path.compare(0, 3, &quot;../&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-29" data-line-number="29"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-30" data-line-number="30"><span class="va">+   if ((path.size() &gt;= 3) &amp;&amp; path.compare(0, 3, &quot;..\\&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-31" data-line-number="31"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-32" data-line-number="32"><span class="va">+   if (path.find(&quot;/../&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-33" data-line-number="33"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-34" data-line-number="34"><span class="va">+   if (path.find(&quot;\\..\\&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-35" data-line-number="35"><span class="va">+       return false;</span></a>
<a class="sourceLine" id="cb25-36" data-line-number="36"><span class="va">+   if (path.find(&quot;/..\\&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-37" data-line-number="37">        return false;</a>
<a class="sourceLine" id="cb25-38" data-line-number="38"><span class="st">-   if (path.compare(0, 3, &quot;..\\&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-39" data-line-number="39"><span class="va">+   if (path.find(&quot;\\../&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-40" data-line-number="40">        return false;</a>
<a class="sourceLine" id="cb25-41" data-line-number="41"><span class="st">-   if (path.find(&quot;/..&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-42" data-line-number="42"><span class="va">+   if ((path.size() &gt;= 2) &amp;&amp; path.compare(0, 2, &quot;~/&quot;) == 0)</span></a>
<a class="sourceLine" id="cb25-43" data-line-number="43">        return false;</a>
<a class="sourceLine" id="cb25-44" data-line-number="44"><span class="st">-   if (path.find(&quot;\\..&quot;) != std::string::npos)</span></a>
<a class="sourceLine" id="cb25-45" data-line-number="45"><span class="va">+   if (path.size() &gt; 0 &amp;&amp; (path[0] == &#39;/&#39; || path[0] == &#39;\\&#39;))</span></a>
<a class="sourceLine" id="cb25-46" data-line-number="46">        return false;</a>
<a class="sourceLine" id="cb25-47" data-line-number="47">    return true;</a>
<a class="sourceLine" id="cb25-48" data-line-number="48">}</a></code></pre></div>
<p><a href="https://github.com/pocoproject/poco/commit/f5b2cf3dd6976ae53b2f3c9618b0087a0646cc7d"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="CImg"></p>
<h3 id="project-name-cimg">Project Name: <a href="https://github.com/dtschump/CImg">CImg</a></h3>
<p><a name="other testcases lead to heap overflow by loading crafted images #185"></p>
<h3 id="other-testcases-lead-to-heap-overflow-by-loading-crafted-images-185">1. <a href="https://github.com/dtschump/CImg/issues/185">other testcases lead to heap overflow by loading crafted images #185</a></h3>
<p><a href="https://github.com/dtschump/CImg/issues/185"><strong>Description</strong></a></p>
<blockquote>
<p>An issue was discovered in CImg v.220. A heap-based buffer over-read in load_bmp in CImg.h occurs when loading a crafted bmp image, a different vulnerability than CVE-2018-7588. This is in a Monochrome case, aka case 1.</p>
</blockquote>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="dt">@@ -48331,7 +48331,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2">      if (header_size&gt;40) cimg::fseek(nfile,header_size - 40,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">       const int</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="st">-        dx_bytes = (bpp==1)?(dx/8 + (dx%8?1:0)):((bpp==4)?(dx/2 + (dx%2)):(dx*bpp/8)),</span></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="va">+        dx_bytes = (bpp==1)?(dx/8 + (dx%8?1:0)):((bpp==4)?(dx/2 + (dx%2)):(int)((longT)dx*bpp/8)),</span></a>
<a class="sourceLine" id="cb27-6" data-line-number="6">        align_bytes = (4 - dx_bytes%4)%4;</a>
<a class="sourceLine" id="cb27-7" data-line-number="7">      const ulongT</a>
<a class="sourceLine" id="cb27-8" data-line-number="8">        cimg_iobuffer = (ulongT)24*1024*1024,</a>
<a class="sourceLine" id="cb27-9" data-line-number="9"><span class="dt">@@ -48363,10 +48363,10 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-10" data-line-number="10">      }</a>
<a class="sourceLine" id="cb27-11" data-line-number="11">       // Read pixel data</a>
<a class="sourceLine" id="cb27-12" data-line-number="12"><span class="st">-      assign(dx,cimg::abs(dy),1,3);</span></a>
<a class="sourceLine" id="cb27-13" data-line-number="13"><span class="va">+      assign(dx,cimg::abs(dy),1,3,0);</span></a>
<a class="sourceLine" id="cb27-14" data-line-number="14">      switch (bpp) {</a>
<a class="sourceLine" id="cb27-15" data-line-number="15"><span class="st">-      case 1 : { // Monochrome</span></a>
<a class="sourceLine" id="cb27-16" data-line-number="16"><span class="va">+        for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb27-17" data-line-number="17">        if (colormap._width&gt;=2) for (int y = height() - 1; y&gt;=0; --y) {</a>
<a class="sourceLine" id="cb27-18" data-line-number="18">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-19" data-line-number="19">            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</a>
<a class="sourceLine" id="cb27-20" data-line-number="20">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-21" data-line-number="21"><span class="dt">@@ -48384,7 +48384,7 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-22" data-line-number="22">        }</a>
<a class="sourceLine" id="cb27-23" data-line-number="23">      } break;</a>
<a class="sourceLine" id="cb27-24" data-line-number="24">      case 4 : { // 16 colors</a>
<a class="sourceLine" id="cb27-25" data-line-number="25"><span class="st">-        for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb27-26" data-line-number="26"><span class="va">+        if (colormap._width&gt;=16) for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb27-27" data-line-number="27">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-28" data-line-number="28">            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</a>
<a class="sourceLine" id="cb27-29" data-line-number="29">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a>
<a class="sourceLine" id="cb27-30" data-line-number="30"><span class="dt">@@ -48402,8 +48402,8 @@ namespace cimg_library_suffixed {</span></a>
<a class="sourceLine" id="cb27-31" data-line-number="31">          ptrs+=align_bytes;</a>
<a class="sourceLine" id="cb27-32" data-line-number="32">        }</a>
<a class="sourceLine" id="cb27-33" data-line-number="33">      } break;</a>
<a class="sourceLine" id="cb27-34" data-line-number="34"><span class="st">-      case 8 : { //  256 colors</span></a>
<a class="sourceLine" id="cb27-35" data-line-number="35"><span class="st">-        for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb27-36" data-line-number="36"><span class="va">+      case 8 : { // 256 colors</span></a>
<a class="sourceLine" id="cb27-37" data-line-number="37"><span class="va">+        if (colormap._width&gt;=256) for (int y = height() - 1; y&gt;=0; --y) {</span></a>
<a class="sourceLine" id="cb27-38" data-line-number="38">          if (buf_size&gt;=cimg_iobuffer) {</a>
<a class="sourceLine" id="cb27-39" data-line-number="39">            if (!cimg::fread(ptrs=buffer._data,dx_bytes,nfile)) break;</a>
<a class="sourceLine" id="cb27-40" data-line-number="40">            cimg::fseek(nfile,align_bytes,SEEK_CUR);</a></code></pre></div>
<p><a href="https://github.com/dtschump/CImg/commit/10af1e8c1ad2a58a0a3342a856bae63e8f257abb"><strong>Full function:</strong></a></p>
<p>The function is too long, see <a href="https://github.com/dtschump/CImg/commit/10af1e8c1ad2a58a0a3342a856bae63e8f257abb">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="ImageMagick"></p>
<h3 id="project-name-imagemagick">Project Name: <a href="https://github.com/ImageMagick/ImageMagick">ImageMagick</a></h3>
<p><a name="heap-buffer-overflow in SVGStripString of svg.c #1336"></p>
<h3 id="heap-buffer-overflow-in-svgstripstring-of-svg.c-1336">1. <a href="https://github.com/ImageMagick/ImageMagick/issues/1336">heap-buffer-overflow in SVGStripString of svg.c #1336</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/1336"><strong>Description</strong></a></p>
<p>In ImageMagick 7.0.8-13 Q16, there is a heap-based buffer over-read in the SVGStripString function of coders/svg.c, which allows attackers to cause a denial of service via a crafted SVG image file.</p>
<p><a href="https://github.com/ImageMagick/ImageMagick6/commit/a5db4873626f702d2ddd8bc293573493e0a412c0"><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb28-1" data-line-number="1">      {</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">        for ( ; *p != &#39;\0&#39;; p++)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">          if ((*p == &#39;*&#39;) &amp;&amp; (*(p+1) == &#39;/&#39;))</a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="st">-            break;</span></a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="va">+            {</span></a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="va">+              p+=2;</span></a>
<a class="sourceLine" id="cb28-7" data-line-number="7"><span class="va">+              break;</span></a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="va">+            }</span></a>
<a class="sourceLine" id="cb28-9" data-line-number="9">        if (*p == &#39;\0&#39;)</a>
<a class="sourceLine" id="cb28-10" data-line-number="10">          break;</a>
<a class="sourceLine" id="cb28-11" data-line-number="11"><span class="st">-        p+=2;</span></a>
<a class="sourceLine" id="cb28-12" data-line-number="12">      }</a>
<a class="sourceLine" id="cb28-13" data-line-number="13">    *q++=(*p);</a>
<a class="sourceLine" id="cb28-14" data-line-number="14">  }</a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick6/commit/a5db4873626f702d2ddd8bc293573493e0a412c0"><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb29-1" data-line-number="1"> <span class="dt">static</span> <span class="dt">void</span> SVGStripString(<span class="dt">const</span> MagickBooleanType trim,<span class="dt">char</span> *message)</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"> {</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">   <span class="dt">register</span> <span class="dt">char</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4">     *p,</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">     *q;</a>
<a class="sourceLine" id="cb29-6" data-line-number="6"> </a>
<a class="sourceLine" id="cb29-7" data-line-number="7">   <span class="dt">size_t</span></a>
<a class="sourceLine" id="cb29-8" data-line-number="8">     length;</a>
<a class="sourceLine" id="cb29-9" data-line-number="9"> </a>
<a class="sourceLine" id="cb29-10" data-line-number="10">   assert(message != (<span class="dt">char</span> *) NULL);</a>
<a class="sourceLine" id="cb29-11" data-line-number="11">   <span class="cf">if</span> (*message == &#39;\<span class="dv">0</span>&#39;)</a>
<a class="sourceLine" id="cb29-12" data-line-number="12">     <span class="cf">return</span>;</a>
<a class="sourceLine" id="cb29-13" data-line-number="13">   <span class="co">/*</span></a>
<a class="sourceLine" id="cb29-14" data-line-number="14"><span class="co">     Remove comment.</span></a>
<a class="sourceLine" id="cb29-15" data-line-number="15"><span class="co">   */</span></a>
<a class="sourceLine" id="cb29-16" data-line-number="16">   q=message;</a>
<a class="sourceLine" id="cb29-17" data-line-number="17">   <span class="cf">for</span> (p=message; *p != &#39;\<span class="dv">0</span>&#39;; p++)</a>
<a class="sourceLine" id="cb29-18" data-line-number="18">   {</a>
<a class="sourceLine" id="cb29-19" data-line-number="19">     <span class="cf">if</span> ((*p == <span class="ch">&#39;/&#39;</span>) &amp;&amp; (*(p+<span class="dv">1</span>) == <span class="ch">&#39;*&#39;</span>))</a>
<a class="sourceLine" id="cb29-20" data-line-number="20">      {</a>
<a class="sourceLine" id="cb29-21" data-line-number="21">        <span class="cf">for</span> ( ; *p != &#39;\<span class="dv">0</span>&#39;; p++)</a>
<a class="sourceLine" id="cb29-22" data-line-number="22">          <span class="cf">if</span> ((*p == <span class="ch">&#39;*&#39;</span>) &amp;&amp; (*(p+<span class="dv">1</span>) == <span class="ch">&#39;/&#39;</span>))</a>
<a class="sourceLine" id="cb29-23" data-line-number="23">            <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb29-24" data-line-number="24">            {</a>
<a class="sourceLine" id="cb29-25" data-line-number="25">              p+=<span class="dv">2</span>;</a>
<a class="sourceLine" id="cb29-26" data-line-number="26">              <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb29-27" data-line-number="27">            }</a>
<a class="sourceLine" id="cb29-28" data-line-number="28">        <span class="cf">if</span> (*p == &#39;\<span class="dv">0</span>&#39;)</a>
<a class="sourceLine" id="cb29-29" data-line-number="29">          <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb29-30" data-line-number="30">        p+=<span class="dv">2</span>;</a>
<a class="sourceLine" id="cb29-31" data-line-number="31">      }</a>
<a class="sourceLine" id="cb29-32" data-line-number="32">    *q++=(*p);</a>
<a class="sourceLine" id="cb29-33" data-line-number="33">  }</a>
<a class="sourceLine" id="cb29-34" data-line-number="34">   *q=&#39;\<span class="dv">0</span>&#39;;</a>
<a class="sourceLine" id="cb29-35" data-line-number="35">   <span class="cf">if</span> (trim != MagickFalse)</a>
<a class="sourceLine" id="cb29-36" data-line-number="36">     {</a>
<a class="sourceLine" id="cb29-37" data-line-number="37">       <span class="co">/*</span></a>
<a class="sourceLine" id="cb29-38" data-line-number="38"><span class="co">         Remove whitespace.</span></a>
<a class="sourceLine" id="cb29-39" data-line-number="39"><span class="co">       */</span></a>
<a class="sourceLine" id="cb29-40" data-line-number="40">       length=strlen(message);</a>
<a class="sourceLine" id="cb29-41" data-line-number="41">       p=message;</a>
<a class="sourceLine" id="cb29-42" data-line-number="42">       <span class="cf">while</span> (isspace((<span class="dt">int</span>) ((<span class="dt">unsigned</span> <span class="dt">char</span>) *p)) != <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb29-43" data-line-number="43">         p++;</a>
<a class="sourceLine" id="cb29-44" data-line-number="44">       <span class="cf">if</span> ((*p == <span class="ch">&#39;\&#39;&#39;</span>) || (*p == <span class="ch">&#39;&quot;&#39;</span>))</a>
<a class="sourceLine" id="cb29-45" data-line-number="45">         p++;</a>
<a class="sourceLine" id="cb29-46" data-line-number="46">       q=message+length<span class="dv">-1</span>;</a>
<a class="sourceLine" id="cb29-47" data-line-number="47">       <span class="cf">while</span> ((isspace((<span class="dt">int</span>) ((<span class="dt">unsigned</span> <span class="dt">char</span>) *q)) != <span class="dv">0</span>) &amp;&amp; (q &gt; p))</a>
<a class="sourceLine" id="cb29-48" data-line-number="48">         q--;</a>
<a class="sourceLine" id="cb29-49" data-line-number="49">       <span class="cf">if</span> (q &gt; p)</a>
<a class="sourceLine" id="cb29-50" data-line-number="50">         <span class="cf">if</span> ((*q == <span class="ch">&#39;\&#39;&#39;</span>) || (*q == <span class="ch">&#39;&quot;&#39;</span>))</a>
<a class="sourceLine" id="cb29-51" data-line-number="51">           q--;</a>
<a class="sourceLine" id="cb29-52" data-line-number="52">       (<span class="dt">void</span>) memmove(message,p,(<span class="dt">size_t</span>) (q-p+<span class="dv">1</span>));</a>
<a class="sourceLine" id="cb29-53" data-line-number="53">       message[q-p+<span class="dv">1</span>]=&#39;\<span class="dv">0</span>&#39;;</a>
<a class="sourceLine" id="cb29-54" data-line-number="54">     }</a>
<a class="sourceLine" id="cb29-55" data-line-number="55">   <span class="co">/*</span></a>
<a class="sourceLine" id="cb29-56" data-line-number="56"><span class="co">     Convert newlines to a space.</span></a>
<a class="sourceLine" id="cb29-57" data-line-number="57"><span class="co">   */</span></a>
<a class="sourceLine" id="cb29-58" data-line-number="58">   <span class="cf">for</span> (p=message; *p != &#39;\<span class="dv">0</span>&#39;; p++)</a>
<a class="sourceLine" id="cb29-59" data-line-number="59">     <span class="cf">if</span> (*p == <span class="ch">&#39;\n&#39;</span>)</a>
<a class="sourceLine" id="cb29-60" data-line-number="60">       *p=<span class="ch">&#39; &#39;</span>;</a>
<a class="sourceLine" id="cb29-61" data-line-number="61"> }</a></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="heap-buffer-overflow in EncodeImage of pict.c #1335"></p>
<h3 id="heap-buffer-overflow-in-encodeimage-of-pict.c-1335">1. <a href="https://github.com/ImageMagick/ImageMagick/issues/1335">heap-buffer-overflow in EncodeImage of pict.c #1335</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/1335"><strong>Description</strong></a></p>
<p>In ImageMagick 7.0.8-13 Q16, there is a heap-based buffer over-read in the EncodeImage function of coders/pict.c, which allows attackers to cause a denial of service via a crafted SVG image file.</p>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="dt">@@ -444,7 +444,7 @@ static unsigned char *DecodeImage(Image *blob,Image *image,</span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2">    bytes_per_line=width;</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">  row_bytes=(size_t) (image-&gt;columns | 0x8000);</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">  if (image-&gt;storage_class == DirectClass)</a>
<a class="sourceLine" id="cb30-5" data-line-number="5"><span class="st">-    row_bytes=(size_t) (4*(image-&gt;columns | 0x8000));</span></a>
<a class="sourceLine" id="cb30-6" data-line-number="6"><span class="va">+    row_bytes=(size_t) ((4*image-&gt;columns) | 0x8000);</span></a>
<a class="sourceLine" id="cb30-7" data-line-number="7">  /*</a>
<a class="sourceLine" id="cb30-8" data-line-number="8">    Allocate pixel and scanline buffer.</a>
<a class="sourceLine" id="cb30-9" data-line-number="9">  */</a>
<a class="sourceLine" id="cb30-10" data-line-number="10"><span class="dt">@@ -1778,7 +1778,7 @@ static MagickBooleanType WritePICTImage(const ImageInfo *image_info,</span></a>
<a class="sourceLine" id="cb30-11" data-line-number="11">  /*</a>
<a class="sourceLine" id="cb30-12" data-line-number="12">    Allocate memory.</a>
<a class="sourceLine" id="cb30-13" data-line-number="13">  */</a>
<a class="sourceLine" id="cb30-14" data-line-number="14"><span class="st">-  bytes_per_line=image-&gt;columns | 0x8000;</span></a>
<a class="sourceLine" id="cb30-15" data-line-number="15"><span class="va">+  bytes_per_line=image-&gt;columns;</span></a>
<a class="sourceLine" id="cb30-16" data-line-number="16">  if (storage_class == DirectClass)</a>
<a class="sourceLine" id="cb30-17" data-line-number="17">    bytes_per_line*=image-&gt;alpha_trait != UndefinedPixelTrait ? 4 : 3;</a>
<a class="sourceLine" id="cb30-18" data-line-number="18">  buffer=(unsigned char *) AcquireQuantumMemory(PictInfoSize,sizeof(*buffer));</a>
<a class="sourceLine" id="cb30-19" data-line-number="19"><span class="dt">@@ -1799,7 +1799,8 @@ static MagickBooleanType WritePICTImage(const ImageInfo *image_info,</span></a>
<a class="sourceLine" id="cb30-20" data-line-number="20">      ThrowWriterException(ResourceLimitError,&quot;MemoryAllocationFailed&quot;);</a>
<a class="sourceLine" id="cb30-21" data-line-number="21">    }</a>
<a class="sourceLine" id="cb30-22" data-line-number="22">  (void) memset(scanline,0,row_bytes);</a>
<a class="sourceLine" id="cb30-23" data-line-number="23"><span class="st">-  (void) memset(packed_scanline,0,(size_t) (row_bytes+2*MaxCount));</span></a>
<a class="sourceLine" id="cb30-24" data-line-number="24"><span class="va">+  (void) memset(packed_scanline,0,(size_t) (row_bytes+2*MaxCount)*</span></a>
<a class="sourceLine" id="cb30-25" data-line-number="25"><span class="va">+    sizeof(*packed_scanline));</span></a>
<a class="sourceLine" id="cb30-26" data-line-number="26">  /*</a>
<a class="sourceLine" id="cb30-27" data-line-number="27">    Write header, header size, size bounding box, version, and reserved.</a>
<a class="sourceLine" id="cb30-28" data-line-number="28">  */</a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/1a22fc0c8837838e60daecc0bf01648f359dd6fd#diff-9f0be979d8a302c3f34029647fc77cbdR450"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/ImageMagick/ImageMagick/commit/1a22fc0c8837838e60daecc0bf01648f359dd6fd#diff-9f0be979d8a302c3f34029647fc77cbdR450">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name="heap-buffer-overflow in MagickCore #1156"></p>
<h3 id="heap-buffer-overflow-in-magickcore-1156">1. <a href="https://github.com/ImageMagick/ImageMagick/issues/1156">heap-buffer-overflow in MagickCore #1156</a></h3>
<p><a href="https://github.com/ImageMagick/ImageMagick/issues/1156"><strong>Description</strong></a></p>
<p>In ImageMagick 7.0.7-37 Q16, SetGrayscaleImage in the quantize.c file allows attackers to cause a heap-based buffer over-read via a crafted file.</p>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb31-1" data-line-number="1">  if (image-&gt;type != GrayscaleType)</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">    (void) TransformImageColorspace(image,GRAYColorspace,exception);</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">  if (image-&gt;storage_class == PseudoClass)</a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="st">-    colormap_index=(ssize_t *) AcquireQuantumMemory(image-&gt;colors,</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="va">+    colormap_index=(ssize_t *) AcquireQuantumMemory(image-&gt;colors+1,</span></a>
<a class="sourceLine" id="cb31-6" data-line-number="6">      sizeof(*colormap_index));</a>
<a class="sourceLine" id="cb31-7" data-line-number="7">  else</a>
<a class="sourceLine" id="cb31-8" data-line-number="8"><span class="st">-    colormap_index=(ssize_t *) AcquireQuantumMemory(MaxColormapSize,</span></a>
<a class="sourceLine" id="cb31-9" data-line-number="9"><span class="va">+    colormap_index=(ssize_t *) AcquireQuantumMemory(MaxColormapSize+1,</span></a>
<a class="sourceLine" id="cb31-10" data-line-number="10">      sizeof(*colormap_index));</a>
<a class="sourceLine" id="cb31-11" data-line-number="11">  if (colormap_index == (ssize_t *) NULL)</a>
<a class="sourceLine" id="cb31-12" data-line-number="12">    ThrowBinaryException(ResourceLimitError,&quot;MemoryAllocationFailed&quot;,</a></code></pre></div>
<p><a href="https://github.com/ImageMagick/ImageMagick/commit/5294966898532a6bd54699fbf04edf18902513ac#diff-b422c231973548d46a04db74c7cb8e58R3448"><strong>Full function:</strong></a></p>
<p>too long, see <a href="https://github.com/ImageMagick/ImageMagick/commit/5294966898532a6bd54699fbf04edf18902513ac#diff-b422c231973548d46a04db74c7cb8e58R3448">here</a></p>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name=""></p>
<h3 id="project-name">Project Name: <a href=""></a></h3>
<h3 id="section">1. <a href=""></a></h3>
<p><a href=""><strong>Description</strong></a></p>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode diff"><code class="sourceCode diff"></code></pre></div>
<p><a href=""><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name=""></p>
<h3 id="project-name-1">Project Name: <a href=""></a></h3>
<h3 id="section-1">1. <a href=""></a></h3>
<p><a href=""><strong>Description</strong></a></p>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode diff"><code class="sourceCode diff"></code></pre></div>
<p><a href=""><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c"><code class="sourceCode c"></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name=""></p>
<h3 id="project-name-2">Project Name: <a href=""></a></h3>
<h3 id="section-2">1. <a href=""></a></h3>
<p><a href=""><strong>Description</strong></a></p>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode diff"><code class="sourceCode diff"></code></pre></div>
<p><a href=""><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name=""></p>
<h3 id="project-name-3">Project Name: <a href=""></a></h3>
<h3 id="section-3">1. <a href=""></a></h3>
<p><a href=""><strong>Description</strong></a></p>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode diff"><code class="sourceCode diff"></code></pre></div>
<p><a href=""><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c"></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
<p><a name=""></p>
<h3 id="project-name-4">Project Name: <a href=""></a></h3>
<h3 id="section-4">1. <a href=""></a></h3>
<p><a href=""><strong>Description</strong></a></p>
<p><a href=""><strong>Patch code:</strong></a></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode diff"><code class="sourceCode diff"></code></pre></div>
<p><a href=""><strong>Full function:</strong></a></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c"><code class="sourceCode c"></code></pre></div>
<p><strong>Comments</strong>:</p>
<hr />
</body>
</html>
